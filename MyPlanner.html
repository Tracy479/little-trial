<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MyPlanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --theme-color: #558B2F;
            --theme-light: #DCEDC8;
            --glass-opacity: 0.95;
            --img-opacity: 0.5;
            --bg-image: none;
            --bg-color: #f3f4f6;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
        }
        
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--bg-image); background-size: cover; background-position: center;
            opacity: var(--img-opacity); z-index: -1; pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* 玻璃面板 */
        .glass-panel {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .glass-panel.is-collapsed {
            height: auto !important;
            flex: 0 0 auto !important;
            min-height: 0 !important;
        }

        /* 布局切换相关 */
        .view-container {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        .view-container.active {
            display: block;
        }

        /* 首页日历视图样式 */
        #calendarView {
            height: calc(100vh - 140px);
            min-height: 500px;
        }

        /* 看板视图三列布局 */
        #dashboardView {
            display: none;
        }
        #dashboardView.active {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            height: calc(100vh - 140px);
            min-height: 500px;
        }

        @media (max-aspect-ratio: 1/1) {
            #dashboardView.active {
                grid-template-columns: 1fr; /* 长宽接近时改为单列 */
                height: auto;
            }
            .dashboard-col {
                height: 500px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 通用样式保持不变 */
        .theme-text { color: var(--theme-color); transition: color 0.3s; }
        .theme-bg { background-color: var(--theme-color); transition: background-color 0.3s; }
        
        .theme-tag {
            background-color: var(--theme-light);
            color: var(--theme-color);
            border-radius: 4px; font-size: 11px; padding: 2px 6px; font-weight: bold;
            display: inline-block; transition: all 0.3s;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: rgba(0,0,0,0.2); 
            border-radius: 3px; 
            transition: background 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        .task-checkbox {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        .task-checkbox:hover { 
            border-color: var(--theme-color); 
            transform: scale(1.1);
        }
        .task-checkbox.checked {
            background-color: var(--theme-color);
            border-color: var(--theme-color);
        }
        .task-checkbox.checked i {
            opacity: 1 !important;
            color: white;
        }

        .panel-wrapper {
            flex: 1;
            transition: flex-grow 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }
        .panel-wrapper.collapsed {
            flex: 0 0 0; 
            opacity: 0; 
            padding: 0 !important;
        }
        .panel-inner { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* 日历样式微调以适应全屏 */
        .calendar-grid { 
            display: grid; 
            /* 修改：使用 minmax(0, 1fr) 强制格子宽度固定，防止被长文字撑开 */
            grid-template-columns: repeat(7, minmax(0, 1fr)); 
            gap: 8px; /* 间距稍微加大 */
            padding-bottom: 10px; 
        }
        .calendar-day {
            min-height: 120px; /* 高度增加 */
            border-radius: 8px; 
            padding: 8px; 
            cursor: pointer;
            border: 1px solid transparent; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            font-size: 15px;
            overflow: hidden; /* 防止溢出圆角 */
        }
        .calendar-day:hover { 
            z-index: 10; 
            transform: translateY(-2px) scale(1.01); 
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
            overflow: visible; 
        }
        .calendar-day:hover { overflow: hidden; }

        .cal-today { 
            border: 2px solid var(--theme-color); 
            font-weight: bold;
            box-shadow: 0 0 0 3px var(--theme-light);
        }
        
        .pencil-circle {
            border: 2px solid #ef4444; 
            border-radius: 50%; 
            color: #ef4444; 
            font-weight: bold;
            width: 28px; height: 28px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        .cal-goal-label {
            font-size: 12px; 
            color: #4b5563; 
            margin-top: 6px; 
            text-align: center;
            background: #f3f4f6; 
            padding: 2px 6px; 
            border-radius: 4px; 
            width: 95%;
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
        }

        .cal-task-item {
            background: var(--theme-color); 
            opacity: 0.8; 
            color: white; 
            padding: 2px 6px; 
            border-radius: 3px; 
            margin-top: 2px; 
            font-size: 11px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%;
            max-width: 100%; /* 强制最大宽度 */
            transition: all 0.2s;
            position: relative;
            text-align: left; /* 左对齐 */
        }
        
        .cal-task-item.done {
            opacity: 0.5;
        }
        
        .cal-task-item.done::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: white;
            transform: translateY(-50%);
        }
        
        .countdown-badge-classic {
            position: absolute; 
            top: 4px; 
            right: 4px;
            font-size: 11px; 
            font-weight: 800;
            padding: 2px 6px; 
            border-radius: 6px;
            z-index: 5;
        }
        .badge-urgent { background-color: #fee2e2; color: #ef4444; }
        .badge-warning { background-color: #ffedd5; color: #ea580c; }
        .badge-normal { background-color: var(--theme-light); color: var(--theme-color); }

        .task-separator { 
            display: flex; 
            align-items: center; 
            margin: 16px 0 8px 0; 
            font-size: 12px; 
            color: #9ca3af; 
            font-weight: bold; 
        }
        .task-separator::before, .task-separator::after { 
            content: ""; flex: 1; height: 1px; background: #e5e7eb; 
        }
        .task-separator span { margin: 0 10px; }

        .fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip { position: relative; }
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%) translateY(-5px);
            padding: 4px 8px; background: rgba(0, 0, 0, 0.8);
            color: white; font-size: 12px; border-radius: 4px;
            white-space: nowrap; opacity: 0; pointer-events: none;
            transition: opacity 0.2s, transform 0.2s; z-index: 100;
        }
        .tooltip:hover::before { opacity: 1; transform: translateX(-50%) translateY(-8px); }
        
        .hidden-visually { opacity: 0; pointer-events: none; }
        
        .stat-card {
            background: linear-gradient(135deg, var(--theme-color) 0%, rgba(79, 70, 229, 0.8) 100%);
            color: white; padding: 16px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .empty-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 40px 20px; text-align: center; color: #9ca3af;
        }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        /* 导航切换按钮样式 */
        .nav-switch {
            background: rgba(243, 244, 246, var(--glass-opacity));
            padding: 2px;
            border-radius: 8px;
            display: flex;
            gap: 2px;
            backdrop-filter: blur(10px);
        }
        .nav-btn {
            width: 72px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
        }
        .nav-btn.active {
            background: rgba(255, 255, 255, var(--glass-opacity));
            color: var(--theme-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-btn:hover:not(.active) {
            background: rgba(255,255,255,0.5);
        }
        
        /* 右侧按钮样式 */
        .header-btn {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(10px);
        }


        /* 修复按钮默认样式 */
        button {
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        button:focus {
            outline: none;
        }
        
        /* 主题色边框和hover效果 */
        .theme-border-hover:hover {
            border-color: var(--theme-color) !important;
        }
        .theme-border-focus:focus {
            border-color: var(--theme-color) !important;
            outline: none;
        }
        
        /* 加号按钮主题色 */
        .add-btn-theme {
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .add-btn-theme:hover,
        .add-btn-theme:focus {
            border-color: var(--theme-color) !important;
            background-color: var(--theme-light) !important;
        }
        
        /* 恢复按钮主题色 */
        .restore-btn-theme:hover,
        .restore-btn-theme:focus {
            color: var(--theme-color) !important;
            border-color: var(--theme-color) !important;
        }
        
        /* 编辑按钮主题色 */
        .edit-btn-theme:hover {
            color: var(--theme-color) !important;
        }

        /* 修复Z-Index遮挡问题 */
        .z-60 {
            z-index: 60 !important;
        }

    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <!-- 顶部导航 -->
    <header class="max-w-[95%] mx-auto mb-4 mt-4 glass-panel px-6 py-3 rounded-2xl shadow-sm shrink-0" style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;">
        <div class="flex items-center gap-4">
            <div class="bg-white/50 p-2.5 rounded-xl theme-text border border-white/60 shadow-sm">
                <i class="fa-solid fa-calendar-days text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold theme-text tracking-tight" style="font-family: Calibri, sans-serif;">MyPlanner</h1>
                <p class="text-gray-500 font-medium text-sm mt-0.5" id="headerDate">Loading...</p>
            </div>
        </div>

        <!-- 中间：视图切换 -->
        <div class="nav-switch">
            <button onclick="switchView('calendar')" class="nav-btn active" id="btn-calendar">
                <i class="fa-solid fa-calendar mr-2"></i>日历
            </button>
            <button onclick="switchView('dashboard')" class="nav-btn" id="btn-dashboard">
                <i class="fa-solid fa-columns mr-2"></i>看板
            </button>
        </div>

        <div class="flex gap-2 justify-end items-center">
            <button onclick="openStats()" class="header-btn flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm">
                <i class="fa-solid fa-chart-bar theme-text"></i>
            </button>
            <button onclick="openSettings()" class="header-btn flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm">
                <i class="fa-solid fa-palette theme-text"></i>
            </button>
        </div>
    </header>

    <!-- 主容器 -->
    <main class="max-w-[95%] mx-auto pb-4">
        
        <!-- 视图 1: 日历 (默认显示) -->
        <div id="calendarView" class="view-container active">
            <section id="ddlSection" class="glass-panel rounded-2xl shadow-lg w-full h-full">
                <div class="p-4 bg-white/30 overflow-y-auto custom-scrollbar" style="height: 100%;">
                    <div class="flex justify-between items-center mb-3 px-1 shrink-0">
                        <span class="text-lg font-bold text-gray-700" id="miniCalTitle"></span>
                        <div class="flex gap-3 items-center">
                            <select id="ddlFilterSelect" onchange="renderMiniCalendar()" class="text-xs bg-white border border-gray-200 rounded-lg px-2 py-1 outline-none text-gray-600 cursor-pointer hover:border-indigo-400">
                                <option value="all">全部目标</option>
                            </select>
                            <span class="text-xs text-gray-500 flex items-center gap-1">
                                <div class="w-3 h-3 rounded-full theme-bg"></div>今天
                            </span>
                            <span class="text-xs text-gray-500 flex items-center gap-1">
                                <div class="w-3 h-3 rounded-full border-2 border-red-500"></div>截止日
                            </span>
                        </div>
                    </div>
                    <div id="miniCalendar" class="calendar-grid"></div>
                </div>
            </section>
        </div>

        <!-- 视图 2: 看板 (三列并排) -->
        <div id="dashboardView" class="view-container">
            
            <!-- 第一列: 目标 -->
            <section id="goalsSection" class="glass-panel rounded-2xl shadow-lg dashboard-col">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('goalsWrapper', 'goalsChevron', 'addGoalBtn')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-bullseye mr-2"></i>目标
                    </h2>
                    <div class="flex gap-3 items-center">
                        <button id="addGoalBtn" onclick="event.stopPropagation(); openAddGoalModal()" class="add-btn-theme text-xs bg-white px-2 py-1 rounded-full shadow-sm text-gray-600 flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="goalsChevron"></i>
                    </div>
                </div>
                <div id="goalsWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 space-y-3 bg-white/30 overflow-y-auto custom-scrollbar" id="goalsContent"></div>
                </div>
            </section>

            <!-- 第二列: 代办 -->
            <section id="todoSection" class="glass-panel rounded-2xl shadow-lg dashboard-col">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('stepsWrapper', 'stepsChevron', 'addTaskBtn')">
                    <div class="flex items-center gap-2">
                        <h2 class="text-lg font-bold theme-text pl-2">
                            <i class="fa-solid fa-list-check mr-2"></i>代办
                        </h2>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full" id="taskCountBadge">0</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <button id="addTaskBtn" onclick="event.stopPropagation(); openAddTaskModal()" class="add-btn-theme text-xs bg-white px-2 py-1 rounded-full shadow-sm text-gray-600 flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="stepsChevron"></i>
                    </div>
                </div>
                <div id="stepsWrapper" class="panel-wrapper">
                    <div class="panel-inner flex flex-col h-full bg-white/30">
                        <div id="stepsList" class="space-y-3 p-4 flex-1 overflow-y-auto custom-scrollbar"></div>
                        <div class="p-3 pt-2 border-t-0 bg-transparent shrink-0">
                            <div class="flex gap-2 shadow-sm rounded-lg overflow-hidden border border-gray-200 bg-white" style="height: 36px;">
                                <input type="text" id="quickIndependentInput" placeholder="快速添加今日任务..." class="flex-1 px-3 py-1 outline-none text-gray-700 text-sm" onkeydown="if(event.key==='Enter')addQuickTask()">
                                <button onclick="addQuickTask()" class="theme-bg text-white px-3 flex items-center justify-center hover:opacity-90 transition shrink-0" title="添加" style="width: 36px;">
                                    <i class="fa-solid fa-plus text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 第三列: 已完成 -->
            <section id="completedSection" class="glass-panel rounded-2xl shadow-lg dashboard-col">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('completedWrapper', 'completedChevron')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-check-circle mr-2"></i>已完成
                    </h2>
                    <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="completedChevron"></i>
                </div>
                <div id="completedWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 bg-white/30 overflow-y-auto custom-scrollbar" id="completedContent">
                        <div id="completedList" class="grid grid-cols-1 gap-2"></div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- 弹窗：新建目标 -->
    <div id="goalModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in-up">
            <h3 class="text-xl font-bold mb-4 theme-text" id="goalModalTitle">
                <i class="fa-solid fa-flag mr-2"></i>新建目标
            </h3>
            <label class="block text-sm font-bold text-gray-700 mb-1">目标名称</label>
            <input type="text" id="goalTitle" class="w-full mb-4 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" placeholder="输入目标名称..." onkeydown="if(event.key==='Enter')saveGoal()">
            <div class="flex gap-4 mb-6">
                <div class="flex-1">
                    <label class="block text-sm font-bold text-gray-700 mb-1">截止日期</label>
                    <input type="date" id="goalDDL" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" style="height: 50px;">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-bold text-gray-700 mb-1">分类</label>
                    <select id="goalCategorySelect" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" style="height: 50px;"></select>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeModal('goalModal')" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition">
                    取消
                </button>
                <button onclick="saveGoal()" class="px-5 py-2 theme-bg text-white rounded-lg hover:opacity-90 font-medium shadow-md transition">
                    <i class="fa-solid fa-save mr-2"></i>保存
                </button>
            </div>
        </div>
    </div>

    <!-- 弹窗：新建/修改任务 (修改版：增加重复功能) -->
    <div id="taskModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in-up">
            <h3 id="taskModalTitle" class="text-xl font-bold mb-4 theme-text">
                <i class="fa-solid fa-tasks mr-2"></i>新建任务
            </h3>
            <label class="block text-sm font-bold text-gray-700 mb-1">任务名称</label>
            <input type="text" id="taskTitle" class="w-full mb-4 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" placeholder="输入任务名称..." onkeydown="if(event.key==='Enter')saveTaskFromModal()">
            
            <div class="flex gap-4 mb-2">
                <div class="flex-1">
                    <label class="block text-sm font-bold text-gray-700 mb-1">日期 / 开始日期</label>
                    <input type="date" id="taskDate" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" style="height: 50px;">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-bold text-gray-700 mb-1">关联目标</label>
                    <select id="taskGoalSelectModal" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" style="height: 50px;">
                        <option value="">独立任务</option>
                    </select>
                </div>
            </div>

            <!-- 重复任务选项区 -->
            <div id="taskRepeatSection" class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <input type="checkbox" id="taskRepeatToggle" onchange="toggleRepeatMode()" class="w-4 h-4 text-[var(--theme-color)] border-gray-300 rounded focus:ring-[var(--theme-color)]">
                    <label for="taskRepeatToggle" class="text-sm font-bold text-gray-700 select-none">每天重复</label>
                </div>
                
                <div id="repeatEndDateContainer" class="hidden fade-in-up">
                    <label class="block text-sm font-bold text-gray-700 mb-1">结束日期 (重复至)</label>
                    <input type="date" id="taskEndDate" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-[var(--theme-color)] bg-gray-50" style="height: 50px;">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">任务颜色</label>
                <!-- 这里使用JS动态渲染预设颜色 -->
                <div id="taskPresetsList" class="flex gap-2 items-center flex-wrap">
                    <!-- JS populate here -->
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <span id="taskColorPreview" class="text-xs text-gray-400 italic">右键点击色块可修改常用色</span>
                </div>
                <input type="hidden" id="taskColor" value="">
            </div>
            
            <div class="flex justify-between pt-4 border-t items-center">
                <!-- 删除按钮：默认隐藏，编辑时显示 -->
                <button id="btnDeleteTask" onclick="deleteTaskFromModal()" class="hidden px-4 py-2 bg-red-50 text-red-500 hover:bg-red-100 rounded-lg font-bold text-sm transition">
                    <i class="fa-solid fa-trash mr-1"></i>删除
                </button>
                <div class="flex gap-3 ml-auto">
                    <button onclick="closeModal('taskModal')" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition">
                        取消
                    </button>
                    <button onclick="saveTaskFromModal()" class="px-5 py-2 theme-bg text-white rounded-lg hover:opacity-90 font-medium shadow-md transition">
                        <i class="fa-solid fa-save mr-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 弹窗：详情 -->
    <div id="detailModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden fade-in-up">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h2 id="detailTitle" class="text-2xl font-bold theme-text tracking-tight"></h2>
                <button onclick="closeModal('detailModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-12 bg-white">
                <div class="md:col-span-8 p-6 overflow-y-auto custom-scrollbar border-r border-gray-100">
                    <div id="detailCalendarView" class="calendar-grid pb-20"></div>
                </div>
                <div class="md:col-span-4 flex flex-col h-full bg-gray-50/50">
                    <div class="p-5 border-b border-gray-100 bg-white">
                        <h4 class="font-bold text-gray-700 text-lg">
                            <i class="fa-solid fa-tasks mr-2"></i>任务清单
                        </h4>
                    </div>
                    <div id="detailTaskList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2"></div>
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <input type="text" id="quickTaskInput" placeholder="输入任务..." class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-300 outline-none bg-gray-50">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计弹窗 -->
    <div id="statsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-6 fade-in-up max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold theme-text">
                    <i class="fa-solid fa-chart-line mr-2"></i>数据统计
                </h3>
                <button onclick="closeModal('statsModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- 统计卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">总目标</div>
                    <div class="text-3xl font-bold" id="statTotalGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">进行中</div>
                    <div class="text-3xl font-bold" id="statActiveGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">总任务</div>
                    <div class="text-3xl font-bold" id="statTotalTasks">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">完成率</div>
                    <div class="text-3xl font-bold" id="statCompletionRate">0%</div>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-tag mr-2"></i>分类统计</h4>
                <div id="categoryStats" class="space-y-2"></div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-history mr-2"></i>最近7天完成任务</h4>
                <div id="recentCompletions" class="text-center text-gray-500">暂无数据</div>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar fade-in-up">
            <h3 class="text-xl font-bold mb-4 theme-text">
                <i class="fa-solid fa-palette mr-2"></i>主题设置
            </h3>
            
            <div class="space-y-3 mb-4 pb-4 border-b">
                <div>
                    <label class="block text-sm font-bold mb-1.5 text-gray-700">主题颜色</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="themeColorPicker" class="w-12 h-10 cursor-pointer rounded border border-gray-200 p-0.5" onchange="updateStyleRealtime()">
                        <span class="text-xs text-gray-500">点击色块选择</span>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <!-- 缩小为 w-6, 减少为 5 个 -->
                        <button onclick="setPresetColor('#558B2F')" class="w-6 h-6 rounded-full" style="background: #558B2F"></button>
                        <button onclick="setPresetColor('#4f46e5')" class="w-6 h-6 rounded-full" style="background: #4f46e5"></button>
                        <button onclick="setPresetColor('#06b6d4')" class="w-6 h-6 rounded-full" style="background: #06b6d4"></button>
                        <button onclick="setPresetColor('#f59e0b')" class="w-6 h-6 rounded-full" style="background: #f59e0b"></button>
                        <button onclick="setPresetColor('#ec4899')" class="w-6 h-6 rounded-full" style="background: #ec4899"></button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1.5 text-gray-700">背景板透明度</label>
                    <input type="range" id="glassOpacityPicker" min="0.3" max="1" step="0.05" class="w-full accent-indigo-600" oninput="updateStyleRealtime()">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1.5 text-gray-700">图片/背景透明度</label>
                    <input type="range" id="imgOpacityPicker" min="0" max="1" step="0.05" class="w-full accent-indigo-600" oninput="updateStyleRealtime()">
                </div>
            </div>
            
            <div class="space-y-3 mb-4 pb-4 border-b">
                <label class="block text-sm font-bold mb-1.5 text-gray-700">
                    <i class="fa-solid fa-image mr-2"></i>上传本地图片
                </label>
                <input type="file" id="localBgInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <button onclick="clearBackground()" class="text-xs text-red-500 hover:text-red-700 transition">
                    <i class="fa-solid fa-times mr-1"></i>清除背景图片
                </button>
            </div>
            
            <div class="space-y-3 mb-4">
                <label class="block text-sm font-bold mb-1.5 text-gray-700">
                    <i class="fa-solid fa-tags mr-2"></i>自定义分类
                </label>
                <textarea id="categoriesInput" rows="3" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="用逗号或顿号分隔，例如：工作, 学习, 生活"></textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeModal('settingsModal')" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">
                    取消
                </button>
                <button onclick="saveSettings()" class="flex-1 py-3 theme-bg text-white rounded-xl font-bold shadow-lg hover:opacity-90 transition">
                    <i class="fa-solid fa-check mr-2"></i>保存设置
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 数据管理 ====================
        let data = {
            goals: [],
            subtasks: [],
            categories: ['工作', '学习', '生活', '健康'],
            settings: {
                theme: '#558B2F',
                themeOpacity: 1,
                glassOpacity: 0.95,
                imgOpacity: 0.5,
                bg: '',
                // 新增：任务常用颜色预设 (5个)
                taskPresets: ['#558B2F', '#1976D2', '#F57C00', '#C2185B', '#7B1FA2']
            }
        };
        
        let currentGoalId = null;
        let editingGoalId = null;
        let currentView = 'calendar'; // 默认视图

        // ==================== 工具函数 ====================
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) {
                r = "0x" + hex[1] + hex[1];
                g = "0x" + hex[2] + hex[2];
                b = "0x" + hex[3] + hex[3];
            } else if (hex.length == 7) {
                r = "0x" + hex[1] + hex[2];
                g = "0x" + hex[3] + hex[4];
                b = "0x" + hex[5] + hex[6];
            }
            return +r + "," + +g + "," + +b;
        }

        function parseDateStr(s) {
            if (!s) return new Date();
            const p = s.split('-');
            return new Date(p[0], p[1] - 1, p[2]);
        }

        function getTodayStr() {
            const n = new Date();
            return `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}-${String(n.getDate()).padStart(2, '0')}`;
        }
        
        // 辅助函数：格式化Date对象为 YYYY-MM-DD
        function formatDateToISO(dateObj) {
            return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const date = parseDateStr(dateStr);
            const today = parseDateStr(getTodayStr());
            const diff = Math.ceil((date - today) / 86400000);
            
            if (diff === 0) return '今天';
            if (diff === 1) return '明天';
            if (diff === -1) return '昨天';
            if (diff > 0 && diff <= 7) return `${diff}天后`;
            if (diff < 0) return `${Math.abs(diff)}天前`;
            return dateStr;
        }

        // ==================== 初始化 ====================
        function init() {
            loadData();
            // 兼容性处理：如果旧数据没有 taskPresets，则初始化
            if (!data.settings.taskPresets || data.settings.taskPresets.length === 0) {
                data.settings.taskPresets = ['#558B2F', '#1976D2', '#F57C00', '#C2185B', '#7B1FA2'];
            }
            updateHeaderDate();
            applyStyles();
            renderAll();
            setupEventListeners();
            setInterval(updateHeaderDate, 60000);
        }

        function loadData() {
            const saved = localStorage.getItem('dailyPlannerPro_v12');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    data = { ...data, ...parsed, settings: { ...data.settings, ...parsed.settings } };
                } catch (e) { console.error(e); }
            }
        }

        function setupEventListeners() {
            document.getElementById('quickIndependentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addIndependentTask();
            });
            document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addSubtaskFromInput();
            });
            document.getElementById('localBgInput').addEventListener('change', handleImageUpload);
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function handleKeyboardShortcuts(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault(); openAddGoalModal();
            }
            if (e.key === 'Escape') closeAllModals();
        }

        function closeAllModals() {
            ['goalModal', 'detailModal', 'statsModal', 'settingsModal', 'taskModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal && !modal.classList.contains('hidden')) closeModal(id);
            });
        }

        // ==================== 视图切换 ====================
        function switchView(viewName) {
            currentView = viewName;
            
            // 切换按钮状态
            document.getElementById('btn-calendar').classList.remove('active');
            document.getElementById('btn-dashboard').classList.remove('active');
            document.getElementById(`btn-${viewName}`).classList.add('active');
            
            // 切换内容显示
            document.getElementById('calendarView').classList.remove('active');
            document.getElementById('dashboardView').classList.remove('active');
            document.getElementById(`${viewName}View`).classList.add('active');
        }

        // ==================== 渲染函数 ====================
        function renderAll() {
            renderGoals();
            renderDailySteps();
            renderCompleted();
            renderMiniCalendar();
            updateTaskGoalSelect();
        }
        
        // 更新任务目标选择框
        function updateTaskGoalSelect() {
            const activeGoals = data.goals.filter(g => !g.completed);
            const optionsHtml = '<option value="">独立任务</option>' + 
                activeGoals.map(g => `<option value="${g.id}">${g.title}</option>`).join('');
            
            // 更新模态框中的选择器
            const modalSelect = document.getElementById('taskGoalSelectModal');
            if (modalSelect) {
                modalSelect.innerHTML = optionsHtml;
            }
        }

        // DDL 日历渲染 (第一周为当周)
        function renderMiniCalendar() {
            const container = document.getElementById('miniCalendar');
            container.innerHTML = '';
            
            const select = document.getElementById('ddlFilterSelect');
            const currentFilter = select.value;
            
            const optionsHtml = '<option value="all">全部目标</option>' + 
                data.goals.filter(g => !g.completed)
                    .map(g => `<option value="${g.id}">${g.title}</option>`)
                    .join('');
            if (select.innerHTML !== optionsHtml) {
                select.innerHTML = optionsHtml;
                select.value = currentFilter;
            }

            const now = new Date();
            // 计算当前周的起始日（周日）
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            
            document.getElementById('miniCalTitle').innerText = `${now.getFullYear()}年 ${now.getMonth() + 1}月`;
            
            ['日', '一', '二', '三', '四', '五', '六'].forEach(w => {
                container.innerHTML += `<div class="text-center text-sm text-gray-600 py-2 font-semibold opacity-100" style="opacity: 1 !important;">${w}</div>`;
            });
            
            let loop = new Date(startOfWeek);
            let daysToShow = 35; // 默认5周
            
            // 如果选择了具体目标，根据目标时间调整显示范围
            if (currentFilter !== 'all') {
                const goal = data.goals.find(g => g.id === currentFilter);
                if (goal) {
                    const ddlDate = parseDateStr(goal.ddl);
                    const ddlWeekEnd = new Date(ddlDate);
                    ddlWeekEnd.setDate(ddlDate.getDate() + (6 - ddlDate.getDay()));
                    
                    const daysToDeadline = Math.ceil((ddlWeekEnd - startOfWeek) / 86400000);
                    const weeksToDeadline = Math.ceil(daysToDeadline / 7);
                    
                    // 如果小于等于5周，显示5周；否则显示到截止日期
                    if (weeksToDeadline <= 5) {
                        daysToShow = 35;
                    } else {
                        daysToShow = daysToDeadline;
                    }
                }
            }
            
            for (let i = 0; i < daysToShow; i++) {
                const dateStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isToday = dateStr === getTodayStr();
                
                if (currentFilter === 'all') {
                    const goalsToday = data.goals.filter(g => g.ddl === dateStr && !g.completed);
                    let content = `<span class="relative z-10 ${goalsToday.length > 0 ? 'pencil-circle' : ''}">${loop.getDate()}</span>`;
                    if (goalsToday.length > 0) {
                        content += `<div class="cal-goal-label">${goalsToday[0].title}</div>`;
                        if (goalsToday.length > 1) {
                            content += `<div class="text-[10px] text-gray-400 mt-1">+${goalsToday.length - 1}</div>`;
                        }
                    }
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''}" onclick="showDayDetail('${dateStr}')">${content}</div>`;
                } else {
                    const goal = data.goals.find(g => g.id === currentFilter);
                    if (!goal) continue;
                    
                    const isDDL = goal.ddl === dateStr;
                    const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                    
                    let html = `<span class="font-bold text-gray-500 z-10">${loop.getDate()}</span>`;
                    
                    if (goal && loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        if (diff <= 60) html += `<div class="countdown-badge-classic ${badgeClass}">${diff}天</div>`;
                    }
                    if (isDDL) html = `<span class="pencil-circle z-10">${loop.getDate()}</span>`;
                    
                    const tasks = data.subtasks.filter(s => s.goalId === currentFilter && s.date === dateStr);
                    const taskHtml = tasks.map(t => {
                        const taskColor = t.color || 'var(--theme-color)';
                        // 修改：添加 w-full 和 max-w-full 确保在详情页也能截断
                        return `<div class="cal-task-item ${t.completed ? 'done' : ''}" style="background: ${taskColor}; cursor: pointer;" onclick="event.stopPropagation(); editTask('${t.id}');">${t.title}</div>`;
                    }).join('');
                    
                    // 修复：传入 currentFilter (goalId)
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''} ${isDDL ? 'bg-red-50' : ''}" onclick="selectDateForTask('${dateStr}', '${currentFilter}')">${html}<div class="w-full flex flex-col items-center mt-1">${taskHtml}</div></div>`;
                }
                
                loop.setDate(loop.getDate() + 1);
            }
        }

        // 代办任务渲染
        function renderDailySteps() {
            const container = document.getElementById('stepsList');
            let tasks = data.subtasks.filter(s => 
                !s.completed && 
                (!s.goalId || (data.goals.find(g => g.id === s.goalId) && !data.goals.find(g => g.id === s.goalId).completed))
            );
            
            document.getElementById('taskCountBadge').innerText = tasks.length;
            
            const todayStr = getTodayStr();
            const todayTasks = tasks.filter(t => t.date === todayStr);
            const futureTasks = tasks.filter(t => t.date > todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            const pastTasks = tasks.filter(t => t.date < todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));

            container.innerHTML = '';
            
            if (pastTasks.length) {
                container.innerHTML += pastTasks.map(t => renderTaskItem(t, 'past')).join('');
                container.innerHTML += `<div class="task-separator"><span>以上已过期</span></div>`;
            }
            
            if (todayTasks.length) {
                container.innerHTML += todayTasks.map(t => renderTaskItem(t, 'today')).join('');
            } else if (tasks.length > 0) {
                container.innerHTML += `<div class="text-center text-xs text-gray-400 py-4">
                    <i class="fa-solid fa-coffee text-2xl mb-2 opacity-50"></i><p>今天暂无安排</p>
                </div>`;
            } else {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-check-circle"></i><p>今日清闲</p>
                </div>`;
            }
            
            if (futureTasks.length) {
                container.innerHTML += `<div class="task-separator"><span>未来计划</span></div>`;
                container.innerHTML += futureTasks.map(t => renderTaskItem(t, 'future')).join('');
            }
        }

        function renderTaskItem(s, type) {
            const parent = s.goalId ? data.goals.find(g => g.id === s.goalId) : null;
            let bg = type === 'today' ? 'bg-white shadow-md transform scale-[1.01]' : 'bg-white/80 hover:bg-white shadow-sm';
            
            return `
            <div class="${bg} p-3 rounded-xl flex items-center justify-between group transition mb-2 fade-in-up relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full theme-bg"></div>
                <div class="flex-1 min-w-0 mr-3 pl-2">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-gray-800 text-sm truncate cursor-text" ondblclick="editTask('${s.id}')" title="${s.title}">${s.title}</span>
                        <button onclick="editTask('${s.id}')" class="opacity-0 group-hover:opacity-100 text-xs text-gray-300 edit-btn-theme transition">
                            <i class="fa-solid fa-pencil"></i>
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 flex gap-3 items-center">
                        <span class="${type === 'past' ? 'text-red-500 font-bold' : ''}">
                            <i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}
                        </span>
                        ${parent ? `<span class="theme-tag truncate max-w-[80px]" title="${parent.title}">${parent.title}</span>` : ''}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteTask('${s.id}')" class="w-7 h-7 rounded-full hover:bg-red-50 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center transition hover:border-[var(--theme-color)]">
                        <i class="fa-solid fa-check text-xs opacity-0 group-hover:opacity-100 text-gray-400"></i>
                    </button>
                </div>
            </div>`;
        }

        // 目标渲染
        function renderGoals() {
            const container = document.getElementById('goalsContent');
            const list = data.goals.filter(g => !g.completed);
            list.sort((a, b) => parseDateStr(a.ddl) - parseDateStr(b.ddl));
            
            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-bullseye"></i><p>暂无目标</p></div>`;
                return;
            }
            
            container.innerHTML = list.map(g => {
                const today = parseDateStr(getTodayStr());
                const diff = Math.ceil((parseDateStr(g.ddl) - today) / 86400000);
                
                let badgeClass = 'badge-normal';
                if (diff < 0) badgeClass = 'badge-urgent';
                else if (diff <= 3) badgeClass = 'badge-urgent';
                else if (diff <= 7) badgeClass = 'badge-warning';
                
                let badgeText = diff < 0 ? `逾期${Math.abs(diff)}天` : `${diff}天`;
                const relTasks = data.subtasks.filter(s => s.goalId === g.id);
                const progress = relTasks.length ? Math.round((relTasks.filter(s => s.completed).length / relTasks.length) * 100) : 0;
                
                return `
                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden fade-in-up" onclick="openDetail('${g.id}')">
                    <div class="absolute top-0 left-0 w-1 h-full theme-bg"></div>
                    <div class="flex justify-between items-start mb-1 pl-2">
                        <div class="font-bold text-gray-800 text-sm truncate pr-2" title="${g.title}">${g.title}</div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); openEditGoalModal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-gray-100 text-gray-400 edit-btn-theme"><i class="fa-solid fa-pencil text-xs"></i></button>
                            <button onclick="event.stopPropagation(); deleteGoal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-red-100 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xs pl-2 mb-2">
                        <div>
                            <span class="countdown-badge-classic ${badgeClass} relative top-0 right-0">${badgeText}</span>
                            <span class="theme-tag ml-2">${g.category}</span>
                        </div>
                        <div class="text-gray-400 font-bold">${progress}%</div>
                    </div>
                    <div class="bg-gray-100 h-1 rounded-full ml-2 overflow-hidden w-[calc(100%-8px)]">
                        <div class="theme-bg h-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
        }

        // 已完成渲染
        function renderCompleted() {
            const container = document.getElementById('completedList');
            container.innerHTML = '';
            
            const cGoals = data.goals.filter(g => g.completed);
            if (cGoals.length) {
                container.innerHTML += `<div class="text-xs text-gray-400 font-bold mb-2"><i class="fa-solid fa-trophy mr-1"></i>已达成目标</div>`;
                cGoals.forEach(g => {
                    container.innerHTML += `
                    <div class="bg-green-50 p-2 rounded border border-green-100 flex justify-between items-center mb-2 group hover:bg-green-100 transition">
                        <span class="font-bold text-gray-600 line-through text-xs truncate flex-1" title="${g.title}">${g.title}</span>
                        <div class="flex gap-2">
                            <button onclick="deleteGoal('${g.id}')" class="text-xs text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="restoreGoal('${g.id}')" class="theme-tag restore-btn-theme"><i class="fa-solid fa-rotate-left mr-1"></i>恢复</button>
                        </div>
                    </div>`;
                });
            }
            
            const cTasks = data.subtasks.filter(s => s.completed).sort((a, b) => b.id - a.id).slice(0, 10);
            if (cTasks.length) {
                container.innerHTML += `<div class="text-xs text-gray-400 font-bold mb-2 mt-3"><i class="fa-solid fa-check mr-1"></i>最近完成任务</div>`;
                cTasks.forEach(s => {
                    container.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50/50 rounded border border-gray-100 mb-1 text-xs group hover:bg-gray-100 transition">
                        <span class="text-gray-400 line-through truncate flex-1 mr-2" title="${s.title}">${s.title}</span>
                        <div class="flex gap-2">
                            <button onclick="deleteTask('${s.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="toggleTaskStatus('${s.id}')" class="text-gray-400 restore-btn-theme border border-gray-200 rounded px-1"><i class="fa-solid fa-rotate-left"></i></button>
                        </div>
                    </div>`;
                });
            }
            
            if (!cGoals.length && !cTasks.length) {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-inbox"></i><p>无完成记录</p></div>`;
            }
        }

        // ==================== 逻辑操作 ====================
        function openDetail(id) {
            currentGoalId = id;
            const g = data.goals.find(x => x.id === id);
            document.getElementById('detailTitle').innerHTML = `<i class="fa-solid fa-flag mr-2"></i>${g.title}`;
            document.getElementById('detailModal').classList.remove('hidden');
            renderDetailCalendar();
            renderDetailTaskList();
        }

        function renderDetailCalendar() {
            const container = document.getElementById('detailCalendarView');
            container.innerHTML = '';
            const goal = data.goals.find(g => g.id === currentGoalId);
            const now = new Date();
            
            // 从当天所在周的周日开始
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // 本周日
            
            // 计算目标截止日期所在周的周六
            const ddlDate = parseDateStr(goal.ddl);
            const ddlWeekEnd = new Date(ddlDate);
            ddlWeekEnd.setDate(ddlDate.getDate() + (6 - ddlDate.getDay())); // 截止日期所在周的周六
            
            // 计算从当周到截止日期的天数
            const daysToDeadline = Math.ceil((ddlWeekEnd - startOfWeek) / 86400000);
            const weeksToDeadline = Math.ceil(daysToDeadline / 7);
            
            // 如果小于等于5周，显示5周；否则显示到截止日期所在周的周六
            let end;
            if (weeksToDeadline <= 5) {
                end = new Date(startOfWeek);
                end.setDate(startOfWeek.getDate() + 34); // 35天 = 5周
            } else {
                end = ddlWeekEnd;
            }
            
            ['日', '一', '二', '三', '四', '五', '六'].forEach(w => container.innerHTML += `<div class="text-center text-xs font-bold text-gray-600 py-1" style="opacity: 1 !important;">${w}</div>`);
            
            let loop = new Date(startOfWeek);
            while (loop <= end) {
                const dStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isDDL = dStr === goal.ddl;
                const isToday = dStr === getTodayStr();
                const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                
                let html = '';
                let dateHtml = `<span class="font-bold text-gray-500">${loop.getDate()}</span>`;
                if (loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                    if (diff <= 60) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        html = `<div class="countdown-badge-classic ${badgeClass}">${diff}天</div>`;
                    }
                }
                if (isDDL) dateHtml = `<span class="pencil-circle">${loop.getDate()}</span>`;
                
                const tasks = data.subtasks.filter(s => s.goalId === currentGoalId && s.date === dStr);
                const taskHtml = tasks.map(t => {
                    const taskColor = t.color || 'var(--theme-color)';
                    // 修改：添加 w-full 和 max-w-full 确保在详情页也能截断
                    return `<div class="text-white text-[10px] px-1 rounded truncate mt-0.5 opacity-80 hover:opacity-100 transition w-full max-w-full ${t.completed ? 'line-through' : ''}" style="background: ${taskColor}; cursor: pointer;" onclick="event.stopPropagation(); editTask('${t.id}');">${t.title}</div>`;
                }).join('');

                // 修改：给包裹 taskHtml 的 div 添加 w-full 和 overflow-hidden
                container.innerHTML += `
                <div class="min-h-[80px] border border-gray-100 p-1 rounded relative hover:shadow-md transition bg-white overflow-hidden ${isToday ? 'border-2 border-[var(--theme-color)]' : ''} ${isDDL ? 'bg-red-50' : ''}" onclick="selectDateForTask('${dStr}', '${currentGoalId}')">
                    ${dateHtml}<div class="flex flex-col w-full overflow-hidden">${taskHtml}</div>${html}
                </div>`;
                loop.setDate(loop.getDate() + 1);
            }
        }

        function renderDetailTaskList() {
            const listContainer = document.getElementById('detailTaskList');
            const tasks = data.subtasks.filter(s => s.goalId === currentGoalId);
            tasks.sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            
            if (tasks.length === 0) {
                listContainer.innerHTML = `<div class="empty-state"><i class="fa-solid fa-tasks"></i><p>暂无任务</p></div>`;
                return;
            }
            
            listContainer.innerHTML = tasks.map(s => `
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-100 rounded-lg hover:shadow-sm transition group fade-in-up">
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox ${s.completed ? 'checked' : ''} w-6 h-6 rounded-full border-2 ${s.completed ? 'border-[var(--theme-color)] bg-[var(--theme-color)]' : 'border-gray-300 bg-white'} flex items-center justify-center transition hover:border-[var(--theme-color)]">
                        <i class="fa-solid fa-check text-xs ${s.completed ? 'text-white' : 'text-transparent'}"></i>
                    </button>
                    <div class="flex-1 ${s.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                        <div class="text-sm font-medium cursor-text" ondblclick="editTask('${s.id}')" title="${s.title}">${s.title}</div>
                        <div class="text-xs text-gray-400"><i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}</div>
                    </div>
                    <button onclick="editTask('${s.id}')" class="text-gray-300 edit-btn-theme opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-pencil"></i></button>
                    <button onclick="deleteTask('${s.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
            
            const goal = data.goals.find(g => g.id === currentGoalId);
            if (tasks.length > 0 && tasks.every(t => t.completed) && !goal.completed) {
                listContainer.innerHTML += `<button onclick="completeGoal('${currentGoalId}')" class="w-full mt-4 py-3 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition font-bold shadow-sm">🎉 任务全部完成，归档该目标！</button>`;
            }
        }

        // 基本数据操作
        function openAddGoalModal() {
            editingGoalId = null;
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-flag mr-2"></i>新建目标';
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDDL').value = getTodayStr();
            document.getElementById('goalModal').classList.remove('hidden');
            fillCategories();
            setTimeout(() => document.getElementById('goalTitle').focus(), 100);
        }
        
        function openEditGoalModal(id) {
            editingGoalId = id;
            const g = data.goals.find(x => x.id === id);
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-pencil mr-2"></i>编辑目标';
            document.getElementById('goalTitle').value = g.title;
            document.getElementById('goalDDL').value = g.ddl;
            document.getElementById('goalModal').classList.remove('hidden');
            fillCategories();
            document.getElementById('goalCategorySelect').value = g.category;
            setTimeout(() => document.getElementById('goalTitle').focus(), 100);
        }
        
        function fillCategories() {
            document.getElementById('goalCategorySelect').innerHTML = data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        function saveGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            const ddl = document.getElementById('goalDDL').value;
            const cat = document.getElementById('goalCategorySelect').value;
            if (!title || !ddl) return alert('请完善信息');
            
            if (editingGoalId) {
                const g = data.goals.find(x => x.id === editingGoalId);
                g.title = title; g.ddl = ddl; g.category = cat;
            } else {
                data.goals.push({ id: Date.now().toString(), title, ddl, category: cat, completed: false });
            }
            saveData(); closeModal('goalModal'); renderAll();
        }

        function deleteGoal(id) {
            if (!confirm('确定删除？')) return;
            data.goals = data.goals.filter(g => g.id !== id);
            data.subtasks = data.subtasks.filter(s => s.goalId !== id);
            saveData(); renderAll();
        }

        function completeGoal(id) {
            data.goals.find(x => x.id === id).completed = true;
            saveData(); closeModal('detailModal'); renderAll();
        }

        function restoreGoal(id) {
            data.goals.find(x => x.id === id).completed = false;
            saveData(); renderAll();
        }

        let editingTaskId = null;
        
        function editTask(id) {
            const task = data.subtasks.find(s => s.id === id);
            if (!task) return;
            
            editingTaskId = id;
            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModalTitle').innerHTML = '<i class="fa-solid fa-edit mr-2"></i>修改任务';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDate').value = task.date;
            
            // 显示删除按钮
            document.getElementById('btnDeleteTask').classList.remove('hidden');
            
            // 编辑时不显示重复选项 (简化逻辑，只允许新建时批量创建)
            document.getElementById('taskRepeatSection').classList.add('hidden');
            
            // 先更新选项列表
            updateTaskGoalSelect();
            
            // 然后设置选中的值（这样才不会被覆盖）
            document.getElementById('taskGoalSelectModal').value = task.goalId || '';
            
            // 渲染常用色块
            renderTaskPresets();

            // 设置颜色
            setTaskColor(task.color || '');
        }

        function addIndependentTask() {
            const input = document.getElementById('quickIndependentInput');
            const title = input.value.trim();
            const goalSelect = document.getElementById('taskGoalSelect');
            const selectedGoalId = goalSelect.value || null;
            
            if (title) {
                addTaskData(title, getTodayStr(), selectedGoalId);
                input.value = '';
            }
        }

        // 快速添加任务（从下方输入框）
        function addQuickTask() {
            const input = document.getElementById('quickIndependentInput');
            const title = input.value.trim();
            
            if (title) {
                addTaskData(title, getTodayStr(), null);  // 默认创建独立任务
                input.value = '';
            }
        }

        // 打开新建任务模态框
        function openAddTaskModal() {
            editingTaskId = null;
            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModalTitle').innerHTML = '<i class="fa-solid fa-tasks mr-2"></i>新建任务';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDate').value = getTodayStr();
            
            // 隐藏删除按钮
            document.getElementById('btnDeleteTask').classList.add('hidden');
            
            // 显示并重置重复选项
            document.getElementById('taskRepeatSection').classList.remove('hidden');
            document.getElementById('taskRepeatToggle').checked = false;
            toggleRepeatMode(); // 重置UI状态
            document.getElementById('taskEndDate').value = '';

            document.getElementById('taskGoalSelectModal').value = '';
            
            // 渲染常用色块
            renderTaskPresets();
            
            setTaskColor('');
            updateTaskGoalSelect();
        }

        // 新增：切换重复模式UI
        function toggleRepeatMode() {
            const isRepeat = document.getElementById('taskRepeatToggle').checked;
            const endContainer = document.getElementById('repeatEndDateContainer');
            if (isRepeat) {
                endContainer.classList.remove('hidden');
            } else {
                endContainer.classList.add('hidden');
            }
        }

        // 渲染任务颜色预设（5个）
        function renderTaskPresets() {
            const container = document.getElementById('taskPresetsList');
            container.innerHTML = '';

            // 1. 默认清除按钮
            const defaultBtn = document.createElement('button');
            defaultBtn.type = 'button';
            defaultBtn.className = 'w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-gray-400 transition';
            defaultBtn.title = '默认主题色';
            defaultBtn.onclick = () => setTaskColor('');
            defaultBtn.innerHTML = '<i class="fa-solid fa-palette text-gray-400 text-xs"></i>';
            container.appendChild(defaultBtn);

            // 2. 动态渲染 5 个预设
            // 保证有数据
            if (!data.settings.taskPresets) data.settings.taskPresets = ['#558B2F', '#1976D2', '#F57C00', '#C2185B', '#7B1FA2'];
            
            data.settings.taskPresets.forEach((color, index) => {
                // 外层容器，用于定位隐藏的 input
                const wrapper = document.createElement('div');
                wrapper.className = 'relative w-6 h-6';

                // 实际显示的按钮
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-6 h-6 rounded-full transform hover:scale-110 transition';
                btn.style.backgroundColor = color;
                btn.title = '左键选择，右键修改';
                
                // 左键点击：设置任务颜色
                btn.onclick = () => setTaskColor(color);
                
                // 右键点击：触发修改颜色
                btn.oncontextmenu = (e) => {
                    e.preventDefault(); // 阻止默认右键菜单
                    const input = wrapper.querySelector('input[type="color"]');
                    if (input) input.click();
                };

                // 隐藏的颜色输入框，用于修改预设
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.className = 'absolute inset-0 opacity-0 w-full h-full cursor-pointer';
                colorInput.style.pointerEvents = 'none'; // 避免覆盖按钮的左键点击，由JS触发click
                colorInput.value = color;
                colorInput.onchange = (e) => updateTaskPreset(index, e.target.value);

                wrapper.appendChild(btn);
                wrapper.appendChild(colorInput);
                container.appendChild(wrapper);
            });

            // 3. 自定义颜色取色器 (Custom)
            const customWrapper = document.createElement('div');
            customWrapper.className = 'relative w-8 h-8 rounded bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition';
            customWrapper.innerHTML = `
                <i class="fa-solid fa-eye-dropper text-gray-500 text-xs pointer-events-none"></i>
                <input type="color" id="taskColorPicker" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" onchange="setTaskColor(this.value)" title="自选颜色">
            `;
            container.appendChild(customWrapper);
        }

        // 修改预设颜色
        function updateTaskPreset(index, newColor) {
            data.settings.taskPresets[index] = newColor;
            saveData();
            renderTaskPresets(); // 重新渲染以更新按钮颜色
            setTaskColor(newColor); // 同时选中新颜色
        }

        // 设置任务颜色（预览）
        function setTaskColor(color) {
            document.getElementById('taskColor').value = color;
            const preview = document.getElementById('taskColorPreview');
            
            // 如果是自选颜色，同步到 custom picker
            const picker = document.getElementById('taskColorPicker');
            if (picker && color) picker.value = color;
            
            if (color) {
                preview.textContent = '自定义颜色';
                preview.style.color = color;
            } else {
                preview.textContent = '默认主题色';
                preview.style.color = '#6b7280';
            }
        }

        // 从模态框保存任务 (包含重复逻辑)
        function saveTaskFromModal() {
            const title = document.getElementById('taskTitle').value.trim();
            const date = document.getElementById('taskDate').value;
            const goalId = document.getElementById('taskGoalSelectModal').value || null;
            const color = document.getElementById('taskColor').value || '';
            const isRepeat = document.getElementById('taskRepeatToggle').checked;
            const endDateStr = document.getElementById('taskEndDate').value;
            
            if (!title) {
                alert('请输入任务名称');
                return;
            }
            if (!date) {
                alert('请选择日期');
                return;
            }
            
            if (editingTaskId) {
                // 编辑模式 (不支持批量编辑，仅单条)
                const task = data.subtasks.find(s => s.id === editingTaskId);
                if (task) {
                    task.title = title;
                    task.date = date;
                    task.goalId = goalId;
                    task.color = color;
                    saveData();
                    renderAll();
                    if (currentGoalId) {
                        renderDetailTaskList();
                        renderDetailCalendar();
                    }
                }
                editingTaskId = null;
            } else {
                // 新建模式 - 检查是否重复
                if (isRepeat && endDateStr) {
                    const start = parseDateStr(date);
                    const end = parseDateStr(endDateStr);
                    
                    if (end < start) {
                        alert('结束日期不能早于开始日期');
                        return;
                    }
                    
                    // 循环创建任务
                    let loopDate = new Date(start);
                    while (loopDate <= end) {
                        const dStr = formatDateToISO(loopDate);
                        data.subtasks.push({
                            id: Date.now() + Math.random().toString(), // 确保ID唯一
                            title: title,
                            date: dStr,
                            goalId: goalId,
                            completed: false,
                            color: color || ''
                        });
                        loopDate.setDate(loopDate.getDate() + 1);
                    }
                    saveData();
                    renderAll();
                    if (currentGoalId) { renderDetailTaskList(); renderDetailCalendar(); }
                } else {
                    // 普通新建
                    addTaskData(title, date, goalId, color);
                }
            }
            closeModal('taskModal');
        }
        
        // 从模态框删除任务
        function deleteTaskFromModal() {
            if (editingTaskId) {
                deleteTask(editingTaskId);
                closeModal('taskModal');
            }
        }


        function addSubtaskFromInput() {
            const input = document.getElementById('quickTaskInput');
            const title = input.value.trim();
            if (title) {
                addTaskData(title, getTodayStr(), currentGoalId);
                input.value = '';
            }
        }

        // 修复：增加了 goalId 参数
        function selectDateForTask(dateStr, goalId) {
            // 如果没有传入goalId，使用currentGoalId（详情页的情况）
            const targetGoalId = goalId || currentGoalId || '';
            
            editingTaskId = null;
            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModalTitle').innerHTML = '<i class="fa-solid fa-tasks mr-2"></i>新建任务';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDate').value = dateStr;
            
            // 隐藏删除按钮
            document.getElementById('btnDeleteTask').classList.add('hidden');
            
            // 显示并重置重复选项
            document.getElementById('taskRepeatSection').classList.remove('hidden');
            document.getElementById('taskRepeatToggle').checked = false;
            toggleRepeatMode();
            document.getElementById('taskEndDate').value = '';
            
            // 先更新，再设置值
            updateTaskGoalSelect();
            renderTaskPresets(); // 渲染预设
            document.getElementById('taskGoalSelectModal').value = targetGoalId;
            setTaskColor('');
        }

        function addTaskData(title, dateStr, goalId, color) {
            data.subtasks.push({ id: Date.now() + '', title, date: dateStr, goalId: goalId, completed: false, color: color || '' });
            saveData(); renderAll();
            if (currentGoalId) { renderDetailTaskList(); renderDetailCalendar(); }
        }

        function toggleTaskStatus(id) {
            const task = data.subtasks.find(s => s.id === id);
            task.completed = !task.completed;
            saveData(); renderAll();
            if (currentGoalId) { renderDetailTaskList(); renderDetailCalendar(); }
        }

        function deleteTask(id) {
            if (!confirm('确定删除？')) return;
            data.subtasks = data.subtasks.filter(s => s.id !== id);
            saveData(); renderAll();
            if (currentGoalId) { renderDetailTaskList(); renderDetailCalendar(); }
        }

        // 统计与设置
        function openStats() {
            document.getElementById('statsModal').classList.remove('hidden');
            const totalGoals = data.goals.length;
            const activeGoals = data.goals.filter(g => !g.completed).length;
            const totalTasks = data.subtasks.length;
            const completedTasks = data.subtasks.filter(t => t.completed).length;
            
            document.getElementById('statTotalGoals').innerText = totalGoals;
            document.getElementById('statActiveGoals').innerText = activeGoals;
            document.getElementById('statTotalTasks').innerText = totalTasks;
            document.getElementById('statCompletionRate').innerText = (totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0) + '%';
            
            const categoryCounts = {};
            data.goals.filter(g => !g.completed).forEach(g => categoryCounts[g.category] = (categoryCounts[g.category] || 0) + 1);
            document.getElementById('categoryStats').innerHTML = Object.entries(categoryCounts).length ? Object.entries(categoryCounts).map(([cat, count]) => `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="theme-tag">${cat}</span><span class="font-bold text-gray-700">${count} 个目标</span>
                </div>`).join('') : '<div class="text-center text-gray-400 py-2">暂无数据</div>';
                
            const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recent = data.subtasks.filter(t => t.completed && parseInt(t.id) > sevenDaysAgo.getTime()).length;
            document.getElementById('recentCompletions').innerHTML = recent > 0 ? 
                `<div class="text-4xl font-bold theme-text">${recent}</div><div class="text-sm text-gray-500 mt-2">继续保持！💪</div>` : 
                '<div class="text-gray-400">最近7天暂无完成记录</div>';
        }


        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('themeColorPicker').value = data.settings.theme;
            document.getElementById('glassOpacityPicker').value = data.settings.glassOpacity;
            document.getElementById('imgOpacityPicker').value = data.settings.imgOpacity || 0.5;
            document.getElementById('categoriesInput').value = data.categories.join(', ');
        }

        function setPresetColor(color) {
            document.getElementById('themeColorPicker').value = color;
            updateStyleRealtime();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                data.settings.bg = ev.target.result;
                updateStyleRealtime();
            };
            reader.readAsDataURL(file);
        }

        function clearBackground() {
            data.settings.bg = '';
            document.getElementById('localBgInput').value = '';
            updateStyleRealtime();
        }

        function saveSettings() {
            data.settings.theme = document.getElementById('themeColorPicker').value;
            data.settings.glassOpacity = document.getElementById('glassOpacityPicker').value;
            data.settings.imgOpacity = document.getElementById('imgOpacityPicker').value;
            data.categories = document.getElementById('categoriesInput').value.split(/[,，]/).map(s => s.trim()).filter(s => s);
            if (data.categories.length === 0) data.categories = ['工作', '学习', '生活', '健康'];
            saveData(); closeModal('settingsModal'); renderAll();
        }

        function updateStyleRealtime() {
            const color = document.getElementById('themeColorPicker').value;
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-light', `rgba(${hexToRgb(color)}, 0.1)`);
            document.documentElement.style.setProperty('--glass-opacity', document.getElementById('glassOpacityPicker').value);
            document.documentElement.style.setProperty('--img-opacity', document.getElementById('imgOpacityPicker').value);
            document.documentElement.style.setProperty('--bg-image', data.settings.bg ? `url('${data.settings.bg}')` : 'none');
        }

        function applyStyles() {
            document.documentElement.style.setProperty('--theme-color', data.settings.theme);
            document.documentElement.style.setProperty('--theme-light', `rgba(${hexToRgb(data.settings.theme)}, 0.1)`);
            document.documentElement.style.setProperty('--glass-opacity', data.settings.glassOpacity);
            document.documentElement.style.setProperty('--img-opacity', data.settings.imgOpacity);
            if (data.settings.bg) document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
        }

        function toggleSection(wrapperId, iconId, btnId) {
            const wrapper = document.getElementById(wrapperId);
            const icon = document.getElementById(iconId);
            const btn = btnId ? document.getElementById(btnId) : null;
            const parentPanel = wrapper.closest('.glass-panel');
            
            if (wrapper.classList.contains('collapsed')) {
                wrapper.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
                if (btn) btn.classList.remove('hidden-visually');
                if (parentPanel) parentPanel.classList.remove('is-collapsed');
            } else {
                wrapper.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                if (btn) btn.classList.add('hidden-visually');
                if (parentPanel) parentPanel.classList.add('is-collapsed');
            }
        }

        function updateHeaderDate() {
            const now = new Date();
            document.getElementById('headerDate').innerText = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function saveData() { localStorage.setItem('dailyPlannerPro_v12', JSON.stringify(data)); }
        function showDayDetail(dateStr) {
            const goals = data.goals.filter(g => g.ddl === dateStr && !g.completed);
            if (goals.length > 0) alert(`${dateStr} 有 ${goals.length} 个截止目标:\n${goals.map(g => '• ' + g.title).join('\n')}`);
        }

        init();
    </script>
</body>
</html>