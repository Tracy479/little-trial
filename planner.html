<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日计划 - 优化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --theme-color: #4f46e5;
            --theme-light: #e0e7ff;
            --theme-opacity: 1;
            --glass-opacity: 0.95;
            --img-opacity: 0.5;
            --left-width: 60%;
            --ddl-height: 400px;
            --todo-height: 500px;
            --goals-height: 400px;
            --completed-height: 400px;
            --bg-image: none;
            --bg-color: #f3f4f6;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
        }
        
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--bg-image); background-size: cover; background-position: center;
            opacity: var(--img-opacity); z-index: -1; pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* 玻璃面板 - 优化版 */
        .glass-panel {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .glass-panel.is-collapsed {
            height: auto !important;
            flex: 0 0 auto !important;
            min-height: 0 !important;
        }

        /* 主题样式 */
        .theme-text { color: var(--theme-color); transition: color 0.3s; }
        .theme-bg { background-color: var(--theme-color); transition: background-color 0.3s; }
        
        .theme-tag {
            background-color: var(--theme-light);
            color: var(--theme-color);
            border-radius: 4px; font-size: 11px; padding: 2px 6px; font-weight: bold;
            display: inline-block; transition: all 0.3s;
        }

        /* 优化：自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: rgba(0,0,0,0.2); 
            border-radius: 3px; 
            transition: background 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        /* 优化：添加loading状态 */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        /* 优化：任务复选框动画 */
        .task-checkbox {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        .task-checkbox:hover { 
            border-color: var(--theme-color); 
            transform: scale(1.1);
        }
        .task-checkbox.checked {
            background-color: var(--theme-color);
            border-color: var(--theme-color);
        }
        .task-checkbox.checked i {
            opacity: 1 !important;
            color: white;
        }

        /* 折叠动画 */
        .panel-wrapper {
            flex: 1;
            transition: flex-grow 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }
        .panel-wrapper.collapsed {
            flex: 0 0 0; 
            opacity: 0; 
            padding: 0 !important;
        }
        .panel-inner { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* 拖动条样式 */
        .resizer-h {
            width: 14px; cursor: col-resize; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 20; margin: 0 -1px;
            background: transparent; 
            transition: all 0.2s; 
            border-radius: 8px; 
            align-self: stretch;
        }
        .resizer-h:hover, .resizer-h.active {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .resizer-h::after {
            content: ""; width: 4px; height: 40px; 
            background-color: var(--theme-color); 
            border-radius: 2px; opacity: 0; 
            transition: opacity 0.2s;
        }
        .resizer-h:hover::after, .resizer-h.active::after { opacity: 0.5; }

        .resizer-v {
            height: 12px; cursor: row-resize; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 20; width: 100%;
            background: transparent; 
            transition: all 0.2s; 
            margin-top: -4px; margin-bottom: -4px; 
            position: relative;
        }
        .resizer-v:hover, .resizer-v.active { background: rgba(255, 255, 255, 0.5); }
        .resizer-v::after {
            content: ""; height: 4px; width: 40px; 
            background-color: var(--theme-color); 
            border-radius: 2px; opacity: 0; 
            transition: opacity 0.2s;
        }
        .resizer-v:hover::after, .resizer-v.active::after { opacity: 0.5; }

        /* 日历样式 */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            padding-bottom: 10px; 
        }
        .calendar-day {
            min-height: 90px; 
            border-radius: 6px; 
            padding: 6px 4px 4px 4px; 
            cursor: pointer;
            border: 1px solid transparent; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            font-size: 14px;
        }
        .calendar-day:hover { 
            z-index: 10; 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        .cal-today { 
            border: 2px solid var(--theme-color); 
            font-weight: bold;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .pencil-circle {
            border: 2px solid #ef4444; 
            border-radius: 50%; 
            color: #ef4444; 
            font-weight: bold;
            width: 24px; height: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        .cal-goal-label {
            font-size: 11px; 
            color: #4b5563; 
            margin-top: 4px; 
            text-align: center;
            background: #f3f4f6; 
            padding: 1px 4px; 
            border-radius: 4px; 
            width: 90%;
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
        }

        .cal-task-item {
            background: var(--theme-color); 
            opacity: 0.8; 
            color: white; 
            padding: 1px 4px; 
            border-radius: 3px; 
            margin-top: 2px; 
            font-size: 10px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%;
            transition: all 0.2s;
        }
        .cal-task-item:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .cal-task-item.done { 
            background: #10b981; 
            text-decoration: line-through; 
            opacity: 0.6; 
        }
        
        /* 倒计时标签 - 调整位置避免重叠 */
        .countdown-badge-classic {
            position: absolute; 
            top: 2px; 
            right: 2px;
            font-size: 10px; 
            font-weight: 800;
            padding: 2px 5px; 
            border-radius: 6px;
            transition: all 0.2s;
            z-index: 5;
        }
        .countdown-badge-classic:hover {
            transform: scale(1.1);
        }
        .badge-urgent { background-color: #fee2e2; color: #ef4444; }
        .badge-warning { background-color: #ffedd5; color: #ea580c; }
        .badge-normal { background-color: var(--theme-light); color: var(--theme-color); }

        /* 任务分隔线 */
        .task-separator { 
            display: flex; 
            align-items: center; 
            margin: 16px 0 8px 0; 
            font-size: 12px; 
            color: #9ca3af; 
            font-weight: bold; 
        }
        .task-separator::before, .task-separator::after { 
            content: ""; 
            flex: 1; 
            height: 1px; 
            background: #e5e7eb; 
        }
        .task-separator span { margin: 0 10px; }

        /* 优化：添加淡入动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }

        /* 优化：提示工具 */
        .tooltip {
            position: relative;
        }
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 100;
        }
        .tooltip:hover::before {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }

        /* 响应式布局 */
        @media (min-width: 1024px) {
            #mainGrid { 
                display: grid; 
                grid-template-columns: var(--left-width) 14px 1fr; 
                align-items: start; 
                gap: 0;
            }
            #leftColumn, #rightColumn { 
                display: flex; 
                flex-direction: column; 
                gap: 12px;
            }
            /* 各个section使用指定高度 */
            #ddlSection { 
                height: var(--ddl-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            #todoSection { 
                height: var(--todo-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            #goalsSection { 
                height: var(--goals-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            #completedSection { 
                height: var(--completed-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            /* 桌面端隐藏底部导航 */
            #mobileTabBar { 
                display: none !important; 
            }
        }
        
        /* 移动端布局 */
        @media (max-width: 1023px) {
            #mainGrid { 
                display: block;
                padding-bottom: 80px; /* 为底部导航留空间 */
            }
            #resizerH, #resizerV1, #resizerV2 { display: none; }
            
            /* 移动端：只显示当前激活的section */
            #leftColumn, #rightColumn { 
                display: block; 
            }
            #ddlSection, #todoSection, #goalsSection, #completedSection {
                display: none;
                height: auto !important;
                min-height: calc(100vh - 180px) !important;
            }
            #ddlSection.active, #todoSection.active, #goalsSection.active, #completedSection.active {
                display: flex !important;
            }
            
            /* 移动端底部导航栏 */
            #mobileTabBar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-around;
                padding: 8px 0 max(8px, env(safe-area-inset-bottom));
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            }
            
            .tab-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 8px 4px;
                color: #9ca3af;
                text-decoration: none;
                transition: all 0.3s;
                cursor: pointer;
                user-select: none;
            }
            
            .tab-item i {
                font-size: 20px;
                margin-bottom: 4px;
                transition: transform 0.3s;
            }
            
            .tab-item span {
                font-size: 11px;
                font-weight: 500;
            }
            
            .tab-item.active {
                color: var(--theme-color);
            }
            
            .tab-item.active i {
                transform: scale(1.1);
            }
            
            /* 移动端header优化 */
            header {
                position: sticky;
                top: 0;
                z-index: 100;
                margin-bottom: 12px !important;
                flex-direction: column !important;
                gap: 12px !important;
                padding: 12px 16px !important;
            }
            
            header .flex {
                width: 100%;
                justify-content: space-between;
            }
            
            header button {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
            
            /* 移动端section优化 */
            .glass-panel {
                margin: 0 12px;
                border-radius: 16px !important;
            }
            
            /* 移动端任务卡片优化 */
            #stepsList > div {
                padding: 12px !important;
            }
            
            /* 移动端快捷输入框 */
            #quickIndependentInput {
                font-size: 14px !important;
            }
            
            /* 移动端隐藏统计和导出按钮 */
            header button[onclick="openStats()"],
            header button[onclick="exportData()"] {
                display: none;
            }
            
            /* 移动端设置弹窗优化 */
            #settingsModal > div {
                max-h: 80vh !important;
                padding: 16px !important;
                margin: 0 8px;
            }
            
            #settingsModal h3 {
                font-size: 18px !important;
                margin-bottom: 16px !important;
                padding-bottom: 12px !important;
            }
            
            #settingsModal .space-y-3 {
                margin-bottom: 16px !important;
                padding-bottom: 16px !important;
            }
            
            #settingsModal .space-y-3:last-of-type {
                margin-bottom: 12px !important;
            }
        }
        
        .hidden-visually { 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.2s; 
        }

        /* 优化：统计卡片 */
        .stat-card {
            background: linear-gradient(135deg, var(--theme-color) 0%, rgba(79, 70, 229, 0.8) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* 优化：空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body onmouseup="stopResize()" onmousemove="resize(event)">

    <div id="bg-layer"></div>

    <!-- 顶部导航 - 优化版 -->
    <header class="max-w-[95%] mx-auto flex flex-col md:flex-row justify-between items-center mb-4 mt-4 glass-panel p-4 rounded-2xl shadow-sm gap-4 shrink-0">
        <div class="flex items-center gap-4">
            <div class="bg-white/50 p-3 rounded-xl theme-text border border-white/60 shadow-sm">
                <i class="fa-solid fa-calendar-days text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold theme-text tracking-tight">每日计划</h1>
                <p class="text-gray-500 font-medium text-sm mt-0.5" id="headerDate">Loading...</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- 统计按钮 -->
            <button onclick="openStats()" class="tooltip flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm text-sm font-medium" data-tooltip="查看统计">
                <i class="fa-solid fa-chart-bar theme-text"></i>
            </button>
            <!-- 导出按钮 -->
            <button onclick="exportData()" class="tooltip flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm text-sm font-medium" data-tooltip="导出数据">
                <i class="fa-solid fa-download theme-text"></i>
            </button>
            <!-- 主题按钮 -->
            <button onclick="openSettings()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm text-sm font-medium">
                <i class="fa-solid fa-palette theme-text"></i> 主题
            </button>
        </div>
    </header>

    <!-- 主布局 -->
    <main id="mainGrid" class="max-w-[95%] mx-auto pb-4">
        
        <!-- 左侧列 -->
        <div id="leftColumn">
            <!-- 1. DDL 可视化 -->
            <section id="ddlSection" class="glass-panel rounded-2xl shadow-lg shrink-0" style="height: var(--ddl-height); min-height: 200px;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('ddlWrapper', 'ddlChevron', 'ddlControls')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-clock mr-2"></i>DDL 可视化
                    </h2>
                    <div class="flex gap-3 items-center">
                        <div id="ddlControls" class="transition-opacity duration-200">
                            <select id="ddlFilterSelect" onclick="event.stopPropagation()" onchange="renderMiniCalendar()" class="text-xs bg-white border border-gray-200 rounded-lg px-2 py-1 outline-none text-gray-600 cursor-pointer hover:border-indigo-400">
                                <option value="all">全部目标</option>
                            </select>
                        </div>
                        <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="ddlChevron"></i>
                    </div>
                </div>
                <div id="ddlWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 bg-white/30 overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-3 px-1 shrink-0">
                            <span class="text-sm font-bold text-gray-700" id="miniCalTitle"></span>
                            <div class="flex gap-3">
                                <span class="text-[10px] text-gray-500 flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full theme-bg"></div>今天
                                </span>
                                <span class="text-[10px] text-gray-500 flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full border-2 border-red-500"></div>截止日
                                </span>
                            </div>
                        </div>
                        <div id="miniCalendar" class="calendar-grid"></div>
                    </div>
                </div>
            </section>

            <div id="resizerV1" class="resizer-v" onmousedown="startResize(event, 'v1')"></div>

            <!-- 2. 目标 -->
            <section id="goalsSection" class="glass-panel rounded-2xl shadow-lg" style="height: var(--goals-height); min-height: 200px;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('goalsWrapper', 'goalsChevron', 'addGoalBtn')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-bullseye mr-2"></i>目标
                    </h2>
                    <div class="flex gap-3 items-center">
                        <button id="addGoalBtn" onclick="event.stopPropagation(); openAddGoalModal()" class="text-xs bg-white border border-gray-200 hover:border-indigo-500 hover:text-indigo-600 px-3 py-1.5 rounded-full shadow-sm text-gray-600 transition flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i> 新建
                        </button>
                        <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="goalsChevron"></i>
                    </div>
                </div>
                <div id="goalsWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 space-y-3 bg-white/30 overflow-y-auto custom-scrollbar" id="goalsContent"></div>
                </div>
            </section>
        </div>

        <div id="resizerH" class="resizer-h" onmousedown="startResize(event, 'h')"></div>

        <!-- 右侧列 -->
        <div id="rightColumn">
            <!-- 3. 代办 -->
            <section id="todoSection" class="glass-panel rounded-2xl shadow-lg shrink-0" style="height: var(--todo-height); min-height: 200px;">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('stepsWrapper', 'stepsChevron')">
                    <div class="flex items-center gap-2">
                        <h2 class="text-xl font-bold theme-text pl-2">
                            <i class="fa-solid fa-list-check mr-2"></i>代办
                        </h2>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full" id="taskCountBadge">0</span>
                    </div>
                    <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="stepsChevron"></i>
                </div>
                <div id="stepsWrapper" class="panel-wrapper">
                    <div class="panel-inner flex flex-col h-full bg-white/30">
                        <div id="stepsList" class="space-y-3 p-5 flex-1 overflow-y-auto custom-scrollbar"></div>
                        <div class="p-5 pt-3 border-t-0 bg-transparent shrink-0">
                            <div class="flex gap-3 shadow-sm rounded-xl overflow-hidden border border-gray-200 bg-white p-1">
                                <input type="text" id="quickIndependentInput" placeholder="添加待办 (回车保存)..." class="flex-1 px-4 py-2 outline-none text-gray-700">
                                <button onclick="addIndependentTask()" class="theme-bg text-white px-6 rounded-lg font-medium hover:opacity-90 transition">
                                    <i class="fa-solid fa-plus mr-1"></i>添加
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="resizerV2" class="resizer-v" onmousedown="startResize(event, 'v2')"></div>

            <!-- 4. 已完成 -->
            <section id="completedSection" class="glass-panel rounded-2xl shadow-lg" style="height: var(--completed-height); min-height: 200px;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('completedWrapper', 'completedChevron')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-check-circle mr-2"></i>已完成
                    </h2>
                    <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="completedChevron"></i>
                </div>
                <div id="completedWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 bg-white/30 overflow-y-auto custom-scrollbar" id="completedContent">
                        <div id="completedList" class="grid grid-cols-1 gap-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 移动端底部导航栏 -->
    <nav id="mobileTabBar">
        <div class="tab-item active" onclick="switchTab('ddl')">
            <i class="fa-solid fa-clock"></i>
            <span>DDL</span>
        </div>
        <div class="tab-item" onclick="switchTab('goals')">
            <i class="fa-solid fa-bullseye"></i>
            <span>目标</span>
        </div>
        <div class="tab-item" onclick="switchTab('todo')">
            <i class="fa-solid fa-list-check"></i>
            <span>代办</span>
        </div>
        <div class="tab-item" onclick="switchTab('completed')">
            <i class="fa-solid fa-check-circle"></i>
            <span>已完成</span>
        </div>
    </nav>

    <!-- 弹窗：新建目标 -->
    <div id="goalModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in-up">
            <h3 class="text-xl font-bold mb-4 theme-text" id="goalModalTitle">
                <i class="fa-solid fa-flag mr-2"></i>新建目标
            </h3>
            <label class="block text-sm font-bold text-gray-700 mb-1">目标名称</label>
            <input type="text" id="goalTitle" class="w-full mb-4 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50" placeholder="输入目标名称...">
            <div class="flex gap-4 mb-6">
                <div class="w-1/2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">截止日期</label>
                    <input type="date" id="goalDDL" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                </div>
                <div class="w-1/2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">分类</label>
                    <select id="goalCategorySelect" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 h-[50px]"></select>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeModal('goalModal')" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition">
                    取消
                </button>
                <button onclick="saveGoal()" class="px-5 py-2 theme-bg text-white rounded-lg hover:opacity-90 font-medium shadow-md transition">
                    <i class="fa-solid fa-save mr-2"></i>保存
                </button>
            </div>
        </div>
    </div>

    <!-- 弹窗：详情 -->
    <div id="detailModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden fade-in-up">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h2 id="detailTitle" class="text-2xl font-bold theme-text tracking-tight"></h2>
                <button onclick="closeModal('detailModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-12 bg-white">
                <div class="md:col-span-8 p-6 overflow-y-auto custom-scrollbar border-r border-gray-100">
                    <div id="detailCalendarView" class="calendar-grid pb-20"></div>
                </div>
                <div class="md:col-span-4 flex flex-col h-full bg-gray-50/50">
                    <div class="p-5 border-b border-gray-100 bg-white">
                        <h4 class="font-bold text-gray-700 text-lg">
                            <i class="fa-solid fa-tasks mr-2"></i>任务清单
                        </h4>
                    </div>
                    <div id="detailTaskList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2"></div>
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <input type="text" id="quickTaskInput" placeholder="输入任务..." class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-300 outline-none bg-gray-50">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增：统计弹窗 -->
    <div id="statsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 fade-in-up max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold theme-text">
                    <i class="fa-solid fa-chart-line mr-2"></i>数据统计
                </h3>
                <button onclick="closeModal('statsModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- 统计卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">总目标</div>
                    <div class="text-3xl font-bold" id="statTotalGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">进行中</div>
                    <div class="text-3xl font-bold" id="statActiveGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">总任务</div>
                    <div class="text-3xl font-bold" id="statTotalTasks">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">完成率</div>
                    <div class="text-3xl font-bold" id="statCompletionRate">0%</div>
                </div>
            </div>
            
            <!-- 分类统计 -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-bold text-gray-700 mb-3">
                    <i class="fa-solid fa-tag mr-2"></i>分类统计
                </h4>
                <div id="categoryStats" class="space-y-2"></div>
            </div>
            
            <!-- 近期完成 -->
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-bold text-gray-700 mb-3">
                    <i class="fa-solid fa-history mr-2"></i>最近7天完成任务
                </h4>
                <div id="recentCompletions" class="text-center text-gray-500">暂无数据</div>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-[400px] shadow-2xl max-h-[85vh] overflow-y-auto custom-scrollbar fade-in-up">
            <h3 class="text-xl font-bold mb-6 theme-text sticky top-0 bg-white pb-2 z-10">
                <i class="fa-solid fa-palette mr-2"></i>主题设置
            </h3>
            
            <div class="space-y-3 mb-5 pb-5 border-b">
                <div>
                    <label class="block text-sm font-bold mb-2 text-gray-700">主题颜色</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="themeColorPicker" class="w-12 h-10 cursor-pointer rounded border border-gray-200 p-0.5" onchange="updateStyleRealtime()">
                        <span class="text-xs text-gray-500">点击色块选择</span>
                    </div>
                    <!-- 预设颜色 -->
                    <div class="flex gap-2 mt-2">
                        <button onclick="setPresetColor('#4f46e5')" class="w-8 h-8 rounded-full" style="background: #4f46e5" title="靛蓝"></button>
                        <button onclick="setPresetColor('#06b6d4')" class="w-8 h-8 rounded-full" style="background: #06b6d4" title="青色"></button>
                        <button onclick="setPresetColor('#10b981')" class="w-8 h-8 rounded-full" style="background: #10b981" title="绿色"></button>
                        <button onclick="setPresetColor('#f59e0b')" class="w-8 h-8 rounded-full" style="background: #f59e0b" title="橙色"></button>
                        <button onclick="setPresetColor('#ec4899')" class="w-8 h-8 rounded-full" style="background: #ec4899" title="粉色"></button>
                        <button onclick="setPresetColor('#8b5cf6')" class="w-8 h-8 rounded-full" style="background: #8b5cf6" title="紫色"></button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2 text-gray-700">背景板透明度</label>
                    <input type="range" id="glassOpacityPicker" min="0.3" max="1" step="0.05" class="w-full accent-indigo-600" oninput="updateStyleRealtime()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>透明</span>
                        <span>不透明</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2 text-gray-700">图片/背景透明度</label>
                    <input type="range" id="imgOpacityPicker" min="0" max="1" step="0.05" class="w-full accent-indigo-600" oninput="updateStyleRealtime()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>透明</span>
                        <span>不透明</span>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3 mb-5 pb-5 border-b">
                <label class="block text-sm font-bold mb-2 text-gray-700">
                    <i class="fa-solid fa-image mr-2"></i>上传本地图片
                </label>
                <input type="file" id="localBgInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <button onclick="clearBackground()" class="text-xs text-red-500 hover:text-red-700 transition">
                    <i class="fa-solid fa-times mr-1"></i>清除背景图片
                </button>
            </div>
            
            <div class="space-y-3 mb-6">
                <label class="block text-sm font-bold mb-2 text-gray-700">
                    <i class="fa-solid fa-tags mr-2"></i>自定义分类
                </label>
                <textarea id="categoriesInput" rows="3" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="用逗号或顿号分隔，例如：工作, 学习, 生活"></textarea>
                <p class="text-xs text-gray-500">用逗号或顿号分隔多个分类</p>
            </div>
            
            <div class="flex gap-3 sticky bottom-0 bg-white pt-4 pb-2 -mx-6 px-6">
                <button onclick="closeModal('settingsModal')" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">
                    取消
                </button>
                <button onclick="saveSettings()" class="flex-1 py-3 theme-bg text-white rounded-xl font-bold shadow-lg hover:opacity-90 transition">
                    <i class="fa-solid fa-check mr-2"></i>保存设置
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 数据管理 ====================
        let data = {
            goals: [],
            subtasks: [],
            categories: ['工作', '学习', '生活', '健康'],
            settings: {
                theme: '#4f46e5',
                themeOpacity: 1,
                glassOpacity: 0.95,
                imgOpacity: 0.5,
                bg: '',
                layoutLeftWidth: 60,
                ddlHeight: 400,
                todoHeight: 500,
                goalsHeight: 400,
                completedHeight: 400
            }
        };
        
        let currentGoalId = null;
        let editingGoalId = null;
        let resizingMode = null;

        // ==================== 工具函数 ====================
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) {
                r = "0x" + hex[1] + hex[1];
                g = "0x" + hex[2] + hex[2];
                b = "0x" + hex[3] + hex[3];
            } else if (hex.length == 7) {
                r = "0x" + hex[1] + hex[2];
                g = "0x" + hex[3] + hex[4];
                b = "0x" + hex[5] + hex[6];
            }
            return +r + "," + +g + "," + +b;
        }

        function parseDateStr(s) {
            if (!s) return new Date();
            const p = s.split('-');
            return new Date(p[0], p[1] - 1, p[2]);
        }

        function getTodayStr() {
            const n = new Date();
            return `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}-${String(n.getDate()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const date = parseDateStr(dateStr);
            const today = parseDateStr(getTodayStr());
            const diff = Math.ceil((date - today) / 86400000);
            
            if (diff === 0) return '今天';
            if (diff === 1) return '明天';
            if (diff === -1) return '昨天';
            if (diff > 0 && diff <= 7) return `${diff}天后`;
            if (diff < 0) return `${Math.abs(diff)}天前`;
            return dateStr;
        }

        // ==================== 初始化 ====================
        function init() {
            loadData();
            updateHeaderDate();
            applyStyles();
            renderAll();
            setupEventListeners();
            initMobileView();
            
            // 定时更新
            setInterval(updateHeaderDate, 60000); // 每分钟更新时间
        }
        
        // 初始化移动端视图
        function initMobileView() {
            if (window.innerWidth < 1024) {
                // 移动端：默认显示DDL页面
                document.getElementById('ddlSection').classList.add('active');
            }
        }
        
        // 监听窗口大小变化
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
                // 桌面端：显示所有section
                document.querySelectorAll('#ddlSection, #goalsSection, #todoSection, #completedSection').forEach(section => {
                    section.classList.remove('active');
                });
            } else {
                // 移动端：只显示当前激活的section
                initMobileView();
            }
        });

        function loadData() {
            const saved = localStorage.getItem('dailyPlannerPro_v12');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    data = {
                        ...data,
                        ...parsed,
                        settings: { ...data.settings, ...parsed.settings }
                    };
                } catch (e) {
                    console.error('数据加载失败:', e);
                }
            }
            
            // 应用布局设置
            if (data.settings.layoutLeftWidth) {
                document.documentElement.style.setProperty('--left-width', data.settings.layoutLeftWidth + '%');
            }
            if (data.settings.ddlHeight) {
                document.documentElement.style.setProperty('--ddl-height', data.settings.ddlHeight + 'px');
            }
            if (data.settings.todoHeight) {
                document.documentElement.style.setProperty('--todo-height', data.settings.todoHeight + 'px');
            }
            if (data.settings.goalsHeight) {
                document.documentElement.style.setProperty('--goals-height', data.settings.goalsHeight + 'px');
            }
            if (data.settings.completedHeight) {
                document.documentElement.style.setProperty('--completed-height', data.settings.completedHeight + 'px');
            }
        }

        function setupEventListeners() {
            // 快速添加任务
            document.getElementById('quickIndependentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addIndependentTask();
            });
            document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addSubtaskFromInput();
            });
            
            // 背景图片上传
            document.getElementById('localBgInput').addEventListener('change', handleImageUpload);
            
            // 键盘快捷键
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl/Cmd + N: 新建目标
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                openAddGoalModal();
            }
            // Esc: 关闭弹窗
            if (e.key === 'Escape') {
                closeAllModals();
            }
        }

        function closeAllModals() {
            ['goalModal', 'detailModal', 'statsModal', 'settingsModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal && !modal.classList.contains('hidden')) {
                    closeModal(id);
                }
            });
        }

        // ==================== 拖动调整大小 ====================
        function startResize(e, mode) {
            resizingMode = mode;
            document.body.style.cursor = mode === 'h' ? 'col-resize' : 'row-resize';
            e.preventDefault();
        }

        function stopResize() {
            if (resizingMode) {
                resizingMode = null;
                document.body.style.cursor = 'default';
                saveData();
            }
        }

        function resize(e) {
            if (!resizingMode) return;
            const mainGrid = document.getElementById('mainGrid');
            
            if (resizingMode === 'h') {
                const percent = ((e.clientX - mainGrid.getBoundingClientRect().left) / mainGrid.offsetWidth) * 100;
                if (percent > 30 && percent < 75) {
                    document.documentElement.style.setProperty('--left-width', percent + '%');
                    data.settings.layoutLeftWidth = percent;
                }
            } else if (resizingMode === 'v1') {
                // DDL section高度调整
                const section = document.getElementById('ddlSection');
                const newH = e.clientY - section.getBoundingClientRect().top;
                if (newH > 200 && newH < 800) {
                    document.documentElement.style.setProperty('--ddl-height', newH + 'px');
                    data.settings.ddlHeight = newH;
                }
            } else if (resizingMode === 'v2') {
                // Todo section高度调整
                const section = document.getElementById('todoSection');
                const newH = e.clientY - section.getBoundingClientRect().top;
                if (newH > 200 && newH < 800) {
                    document.documentElement.style.setProperty('--todo-height', newH + 'px');
                    data.settings.todoHeight = newH;
                }
            }
        }

        // ==================== 渲染函数 ====================
        function renderAll() {
            renderGoals();
            renderDailySteps();
            renderCompleted();
            renderMiniCalendar();
        }

        // DDL 日历渲染
        function renderMiniCalendar() {
            const container = document.getElementById('miniCalendar');
            container.innerHTML = '';
            
            const select = document.getElementById('ddlFilterSelect');
            const currentFilter = select.value;
            
            // 更新筛选选项
            const optionsHtml = '<option value="all">全部目标</option>' + 
                data.goals.filter(g => !g.completed)
                    .map(g => `<option value="${g.id}">${g.title}</option>`)
                    .join('');
            if (select.innerHTML !== optionsHtml) {
                select.innerHTML = optionsHtml;
                select.value = currentFilter;
            }

            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            
            document.getElementById('miniCalTitle').innerText = `${now.getFullYear()}年 ${now.getMonth() + 1}月`;
            
            // 渲染星期标题
            ['日', '一', '二', '三', '四', '五', '六'].forEach(w => {
                container.innerHTML += `<div class="text-center text-[10px] text-gray-400 py-2 font-medium">${w}</div>`;
            });
            
            // 渲染日期
            let loop = new Date(startOfWeek);
            const daysToShow = 35;
            
            for (let i = 0; i < daysToShow; i++) {
                const dateStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isToday = dateStr === getTodayStr();
                
                if (currentFilter === 'all') {
                    // 显示所有目标
                    const goalsToday = data.goals.filter(g => g.ddl === dateStr && !g.completed);
                    let content = `<span class="relative z-10 ${goalsToday.length > 0 ? 'pencil-circle' : ''}">${loop.getDate()}</span>`;
                    if (goalsToday.length > 0) {
                        content += `<div class="cal-goal-label">${goalsToday[0].title}</div>`;
                        if (goalsToday.length > 1) {
                            content += `<div class="text-[9px] text-gray-400 mt-1">+${goalsToday.length - 1}</div>`;
                        }
                    }
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''}" onclick="showDayDetail('${dateStr}')">${content}</div>`;
                } else {
                    // 显示单个目标
                    const goal = data.goals.find(g => g.id === currentFilter);
                    if (!goal) continue;
                    
                    const isDDL = goal.ddl === dateStr;
                    const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                    
                    let html = `<span class="font-bold text-gray-500 z-10">${loop.getDate()}</span>`;
                    
                    // 倒计时标签
                    if (goal && loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        
                        if (diff <= 60) {
                            html += `<div class="countdown-badge-classic ${badgeClass}">${diff}天</div>`;
                        }
                    }
                    // DDL当天用红圈标注日期
                    if (isDDL) {
                        html = `<span class="pencil-circle z-10">${loop.getDate()}</span>`;
                    }
                    
                    // 任务列表
                    const tasks = data.subtasks.filter(s => s.goalId === currentFilter && s.date === dateStr);
                    const taskHtml = tasks.map(t => 
                        `<div class="cal-task-item ${t.completed ? 'done' : ''}">${t.title}</div>`
                    ).join('');
                    
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''} ${isDDL ? 'bg-red-50' : ''}" onclick="selectDateForTask('${dateStr}')">${html}<div class="w-full flex flex-col items-center mt-1">${taskHtml}</div></div>`;
                    currentGoalId = currentFilter;
                }
                
                loop.setDate(loop.getDate() + 1);
            }
        }

        // 代办任务渲染
        function renderDailySteps() {
            const container = document.getElementById('stepsList');
            let tasks = data.subtasks.filter(s => 
                !s.completed && 
                (!s.goalId || (data.goals.find(g => g.id === s.goalId) && !data.goals.find(g => g.id === s.goalId).completed))
            );
            
            document.getElementById('taskCountBadge').innerText = tasks.length;
            
            const todayStr = getTodayStr();
            const todayTasks = tasks.filter(t => t.date === todayStr);
            const futureTasks = tasks.filter(t => t.date > todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            const pastTasks = tasks.filter(t => t.date < todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));

            container.innerHTML = '';
            
            // 过期任务
            if (pastTasks.length) {
                container.innerHTML += pastTasks.map(t => renderTaskItem(t, 'past')).join('');
                container.innerHTML += `<div class="task-separator"><span>以上已过期</span></div>`;
            }
            
            // 今日任务
            if (todayTasks.length) {
                container.innerHTML += todayTasks.map(t => renderTaskItem(t, 'today')).join('');
            } else if (tasks.length > 0) {
                container.innerHTML += `<div class="text-center text-xs text-gray-400 py-4">
                    <i class="fa-solid fa-coffee text-2xl mb-2 opacity-50"></i>
                    <p>今天暂无安排，休息一下吧！</p>
                </div>`;
            } else {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-check-circle"></i>
                    <p>今日清闲，可以添加新任务</p>
                </div>`;
            }
            
            // 未来任务
            if (futureTasks.length) {
                container.innerHTML += `<div class="task-separator"><span>未来计划</span></div>`;
                container.innerHTML += futureTasks.map(t => renderTaskItem(t, 'future')).join('');
            }
        }

        function renderTaskItem(s, type) {
            const parent = s.goalId ? data.goals.find(g => g.id === s.goalId) : null;
            let border = type === 'today' ? 'border-l-4 border-[var(--theme-color)]' : 
                        (type === 'past' ? 'border-l-4 border-red-300' : 'border-l-4 border-gray-200');
            let bg = type === 'today' ? 'bg-white shadow-md transform scale-[1.01]' : 'bg-white/80 hover:bg-white shadow-sm';
            
            return `
            <div class="${bg} p-3 rounded-xl ${border} flex items-center justify-between group transition mb-2 fade-in-up">
                <div class="flex-1 min-w-0 mr-3">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-gray-800 text-sm truncate cursor-text" ondblclick="editTask('${s.id}')" title="${s.title}">${s.title}</span>
                        <button onclick="editTask('${s.id}')" class="opacity-0 group-hover:opacity-100 text-xs text-gray-300 hover:text-indigo-500 transition tooltip" data-tooltip="编辑">
                            <i class="fa-solid fa-pencil"></i>
                        </button>
                        ${parent ? `<span class="theme-tag truncate max-w-[80px]" title="${parent.title}">${parent.title}</span>` : ''}
                    </div>
                    <div class="text-xs text-gray-500 flex gap-3">
                        <span class="${type === 'past' ? 'text-red-500 font-bold' : ''}">
                            <i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}
                        </span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteTask('${s.id}')" class="w-7 h-7 rounded-full hover:bg-red-50 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition tooltip" data-tooltip="删除">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center transition hover:border-[var(--theme-color)] tooltip" data-tooltip="完成">
                        <i class="fa-solid fa-check text-xs opacity-0 group-hover:opacity-100 text-gray-400"></i>
                    </button>
                </div>
            </div>`;
        }

        // 目标渲染
        function renderGoals() {
            const container = document.getElementById('goalsContent');
            const list = data.goals.filter(g => !g.completed);
            list.sort((a, b) => parseDateStr(a.ddl) - parseDateStr(b.ddl));
            
            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-bullseye"></i>
                    <p>暂无目标，点击"新建"创建第一个目标</p>
                </div>`;
                return;
            }
            
            container.innerHTML = list.map(g => {
                const today = parseDateStr(getTodayStr());
                const diff = Math.ceil((parseDateStr(g.ddl) - today) / 86400000);
                
                let badgeClass = 'badge-normal';
                if (diff < 0) badgeClass = 'badge-urgent';
                else if (diff <= 3) badgeClass = 'badge-urgent';
                else if (diff <= 7) badgeClass = 'badge-warning';
                
                let badgeText = diff < 0 ? `逾期${Math.abs(diff)}天` : `${diff}天`;
                
                const relTasks = data.subtasks.filter(s => s.goalId === g.id);
                const progress = relTasks.length ? Math.round((relTasks.filter(s => s.completed).length / relTasks.length) * 100) : 0;
                
                return `
                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden fade-in-up" onclick="openDetail('${g.id}')">
                    <div class="absolute top-0 left-0 w-1 h-full theme-bg"></div>
                    <div class="flex justify-between items-start mb-1 pl-2">
                        <div class="font-bold text-gray-800 text-sm truncate pr-2" title="${g.title}">${g.title}</div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); openEditGoalModal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-gray-100 text-gray-400 hover:text-indigo-500 tooltip" data-tooltip="编辑">
                                <i class="fa-solid fa-pencil text-xs"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteGoal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-red-100 text-gray-400 hover:text-red-500 tooltip" data-tooltip="删除">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xs pl-2 mb-2">
                        <div>
                            <span class="countdown-badge-classic ${badgeClass} relative top-0 right-0">${badgeText}</span>
                            <span class="theme-tag ml-2">${g.category}</span>
                        </div>
                        <div class="text-gray-400 font-bold">${progress}%</div>
                    </div>
                    <div class="bg-gray-100 h-1 rounded-full ml-2 overflow-hidden w-[calc(100%-8px)]">
                        <div class="theme-bg h-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
        }

        // 已完成渲染
        function renderCompleted() {
            const container = document.getElementById('completedList');
            container.innerHTML = '';
            
            const cGoals = data.goals.filter(g => g.completed);
            if (cGoals.length) {
                container.innerHTML += `<div class="text-xs text-gray-400 font-bold mb-2">
                    <i class="fa-solid fa-trophy mr-1"></i>已达成目标
                </div>`;
                cGoals.forEach(g => {
                    container.innerHTML += `
                    <div class="bg-green-50 p-2 rounded border border-green-100 flex justify-between items-center mb-2 group hover:bg-green-100 transition">
                        <span class="font-bold text-gray-600 line-through text-xs truncate flex-1" title="${g.title}">${g.title}</span>
                        <div class="flex gap-2">
                            <button onclick="deleteGoal('${g.id}')" class="text-xs text-gray-400 hover:text-red-500 tooltip" data-tooltip="删除">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            <button onclick="restoreGoal('${g.id}')" class="theme-tag tooltip" data-tooltip="恢复">
                                <i class="fa-solid fa-rotate-left mr-1"></i>恢复
                            </button>
                        </div>
                    </div>`;
                });
            }
            
            const cTasks = data.subtasks.filter(s => s.completed).sort((a, b) => b.id - a.id).slice(0, 10);
            if (cTasks.length) {
                container.innerHTML += `<div class="text-xs text-gray-400 font-bold mb-2 mt-3">
                    <i class="fa-solid fa-check mr-1"></i>最近完成任务
                </div>`;
                cTasks.forEach(s => {
                    container.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50/50 rounded border border-gray-100 mb-1 text-xs group hover:bg-gray-100 transition">
                        <span class="text-gray-400 line-through truncate flex-1 mr-2" title="${s.title}">${s.title}</span>
                        <div class="flex gap-2">
                            <button onclick="deleteTask('${s.id}')" class="text-gray-400 hover:text-red-500 tooltip" data-tooltip="删除">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                            <button onclick="toggleTaskStatus('${s.id}')" class="text-gray-400 hover:text-indigo-500 tooltip" data-tooltip="恢复">
                                <i class="fa-solid fa-rotate-left"></i>
                            </button>
                        </div>
                    </div>`;
                });
            }
            
            if (!cGoals.length && !cTasks.length) {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-inbox"></i>
                    <p>还没有完成的项目</p>
                </div>`;
            }
        }

        // ==================== 详情弹窗 ====================
        function openDetail(id) {
            currentGoalId = id;
            const g = data.goals.find(x => x.id === id);
            document.getElementById('detailTitle').innerHTML = `<i class="fa-solid fa-flag mr-2"></i>${g.title}`;
            document.getElementById('detailModal').classList.remove('hidden');
            renderDetailCalendar();
            renderDetailTaskList();
        }

        function renderDetailCalendar() {
            const container = document.getElementById('detailCalendarView');
            container.innerHTML = '';
            
            const goal = data.goals.find(g => g.id === currentGoalId);
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(parseDateStr(goal.ddl).getFullYear(), parseDateStr(goal.ddl).getMonth() + 1, 0);
            
            ['日', '一', '二', '三', '四', '五', '六'].forEach(w => {
                container.innerHTML += `<div class="text-center text-xs font-bold text-gray-400 py-1">${w}</div>`;
            });
            
            for (let i = 0; i < start.getDay(); i++) {
                container.innerHTML += `<div></div>`;
            }
            
            let loop = new Date(start);
            while (loop <= end) {
                const dStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isDDL = dStr === goal.ddl;
                const isToday = dStr === getTodayStr();
                const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                
                let html = '';
                let dateHtml = `<span class="font-bold text-gray-500">${loop.getDate()}</span>`;
                if (loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                    if (diff <= 60) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        html = `<div class="countdown-badge-classic ${badgeClass}">${diff}天</div>`;
                    }
                }
                // DDL当天用红圈标注
                if (isDDL) {
                    dateHtml = `<span class="pencil-circle">${loop.getDate()}</span>`;
                }
                
                const tasks = data.subtasks.filter(s => s.goalId === currentGoalId && s.date === dStr);
                const taskHtml = tasks.map(t => 
                    `<div class="theme-bg text-white text-[10px] px-1 rounded truncate mt-0.5 opacity-80 hover:opacity-100 transition ${t.completed ? 'line-through bg-green-500' : ''}" title="${t.title}">${t.title}</div>`
                ).join('');

                container.innerHTML += `
                <div class="min-h-[80px] border border-gray-100 p-1 rounded relative hover:shadow-md transition bg-white ${isToday ? 'border-2 border-indigo-500' : ''} ${isDDL ? 'bg-red-50' : ''}" onclick="selectDateForTask('${dStr}')">
                    ${dateHtml}
                    <div class="flex flex-col">${taskHtml}</div>
                    ${html}
                </div>`;
                loop.setDate(loop.getDate() + 1);
            }
        }

        function renderDetailTaskList() {
            const listContainer = document.getElementById('detailTaskList');
            const tasks = data.subtasks.filter(s => s.goalId === currentGoalId);
            tasks.sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            
            if (tasks.length === 0) {
                listContainer.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-tasks"></i>
                    <p>暂无任务，点击日期添加</p>
                </div>`;
                return;
            }
            
            listContainer.innerHTML = tasks.map(s => `
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-100 rounded-lg hover:shadow-sm transition group fade-in-up">
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox ${s.completed ? 'checked' : ''} w-6 h-6 rounded-full border-2 ${s.completed ? 'border-[var(--theme-color)] bg-[var(--theme-color)]' : 'border-gray-300 bg-white'} flex items-center justify-center transition hover:border-[var(--theme-color)]">
                        <i class="fa-solid fa-check text-xs ${s.completed ? 'text-white' : 'text-transparent'}"></i>
                    </button>
                    <div class="flex-1 ${s.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                        <div class="text-sm font-medium cursor-text" ondblclick="editTask('${s.id}')" title="${s.title}">${s.title}</div>
                        <div class="text-xs text-gray-400">
                            <i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}
                        </div>
                    </div>
                    <button onclick="deleteTask('${s.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2 tooltip" data-tooltip="删除">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
            
            const goal = data.goals.find(g => g.id === currentGoalId);
            if (tasks.length > 0 && tasks.every(t => t.completed) && !goal.completed) {
                listContainer.innerHTML += `
                <button onclick="completeGoal('${currentGoalId}')" class="w-full mt-4 py-3 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition font-bold shadow-sm">
                    🎉 任务全部完成，归档该目标！
                </button>`;
            }
        }

        // ==================== 核心操作 ====================
        function openAddGoalModal() {
            editingGoalId = null;
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-flag mr-2"></i>新建目标';
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDDL').value = getTodayStr();
            document.getElementById('goalModal').classList.remove('hidden');
            fillCategories();
            // 聚焦到输入框
            setTimeout(() => document.getElementById('goalTitle').focus(), 100);
        }

        function openEditGoalModal(id) {
            editingGoalId = id;
            const g = data.goals.find(x => x.id === id);
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-pencil mr-2"></i>编辑目标';
            document.getElementById('goalTitle').value = g.title;
            document.getElementById('goalDDL').value = g.ddl;
            document.getElementById('goalModal').classList.remove('hidden');
            fillCategories();
            document.getElementById('goalCategorySelect').value = g.category;
            setTimeout(() => document.getElementById('goalTitle').focus(), 100);
        }

        function fillCategories() {
            document.getElementById('goalCategorySelect').innerHTML = data.categories.map(c => 
                `<option value="${c}">${c}</option>`
            ).join('');
        }

        function saveGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            const ddl = document.getElementById('goalDDL').value;
            const cat = document.getElementById('goalCategorySelect').value;
            
            if (!title) {
                alert('请输入目标名称');
                return;
            }
            if (!ddl) {
                alert('请选择截止日期');
                return;
            }
            
            if (editingGoalId) {
                const g = data.goals.find(x => x.id === editingGoalId);
                g.title = title;
                g.ddl = ddl;
                g.category = cat;
            } else {
                data.goals.push({
                    id: Date.now().toString(),
                    title,
                    ddl,
                    category: cat,
                    completed: false
                });
            }
            
            saveData();
            closeModal('goalModal');
            renderAll();
        }

        function deleteGoal(id) {
            if (!confirm('确定要删除这个目标吗？相关任务也会被删除。')) return;
            
            data.goals = data.goals.filter(g => g.id !== id);
            data.subtasks = data.subtasks.filter(s => s.goalId !== id);
            saveData();
            renderAll();
        }

        function completeGoal(id) {
            const g = data.goals.find(x => x.id === id);
            g.completed = true;
            saveData();
            closeModal('detailModal');
            renderAll();
        }

        function restoreGoal(id) {
            const g = data.goals.find(x => x.id === id);
            g.completed = false;
            saveData();
            renderAll();
        }

        // 任务操作
        function editTask(id) {
            const task = data.subtasks.find(s => s.id === id);
            const newTitle = prompt("修改任务名称", task.title);
            if (newTitle && newTitle.trim()) {
                task.title = newTitle.trim();
                saveData();
                renderAll();
                if (currentGoalId) {
                    renderDetailTaskList();
                    renderDetailCalendar();
                }
            }
        }

        function addIndependentTask() {
            const input = document.getElementById('quickIndependentInput');
            const title = input.value.trim();
            if (title) {
                addTaskData(title, getTodayStr(), null);
                input.value = '';
            }
        }

        function addSubtaskFromInput() {
            const input = document.getElementById('quickTaskInput');
            const title = input.value.trim();
            if (title) {
                addTaskData(title, getTodayStr(), currentGoalId);
                input.value = '';
            }
        }

        function selectDateForTask(dateStr) {
            const title = prompt(`为 ${dateStr} 添加任务:`);
            if (title && title.trim()) {
                addTaskData(title.trim(), dateStr, currentGoalId);
            }
        }

        function addTaskData(title, dateStr, goalId) {
            data.subtasks.push({
                id: Date.now() + '',
                title,
                date: dateStr,
                goalId: goalId,
                completed: false
            });
            saveData();
            renderAll();
            if (currentGoalId) {
                renderDetailTaskList();
                renderDetailCalendar();
            }
        }

        function toggleTaskStatus(id) {
            const task = data.subtasks.find(s => s.id === id);
            task.completed = !task.completed;
            saveData();
            renderAll();
            if (currentGoalId) {
                renderDetailTaskList();
                renderDetailCalendar();
            }
            
            // 添加动画效果
            const checkbox = event.target.closest('.task-checkbox');
            if (checkbox) {
                if (task.completed) {
                    checkbox.classList.add('checked');
                } else {
                    checkbox.classList.remove('checked');
                }
            }
        }

        function deleteTask(id) {
            if (!confirm('确定要删除这个任务吗？')) return;
            
            data.subtasks = data.subtasks.filter(s => s.id !== id);
            saveData();
            renderAll();
            if (currentGoalId) {
                renderDetailTaskList();
                renderDetailCalendar();
            }
        }

        // ==================== 统计功能 ====================
        function openStats() {
            document.getElementById('statsModal').classList.remove('hidden');
            calculateStats();
        }

        function calculateStats() {
            const totalGoals = data.goals.length;
            const activeGoals = data.goals.filter(g => !g.completed).length;
            const totalTasks = data.subtasks.length;
            const completedTasks = data.subtasks.filter(t => t.completed).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('statTotalGoals').innerText = totalGoals;
            document.getElementById('statActiveGoals').innerText = activeGoals;
            document.getElementById('statTotalTasks').innerText = totalTasks;
            document.getElementById('statCompletionRate').innerText = completionRate + '%';
            
            // 分类统计
            const categoryStatsContainer = document.getElementById('categoryStats');
            const categoryCounts = {};
            data.goals.filter(g => !g.completed).forEach(g => {
                categoryCounts[g.category] = (categoryCounts[g.category] || 0) + 1;
            });
            
            if (Object.keys(categoryCounts).length > 0) {
                categoryStatsContainer.innerHTML = Object.entries(categoryCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cat, count]) => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="theme-tag">${cat}</span>
                            <span class="font-bold text-gray-700">${count} 个目标</span>
                        </div>
                    `).join('');
            } else {
                categoryStatsContainer.innerHTML = '<div class="text-center text-gray-400 py-2">暂无数据</div>';
            }
            
            // 近期完成统计
            const recentContainer = document.getElementById('recentCompletions');
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentCompleted = data.subtasks.filter(t => {
                if (!t.completed) return false;
                // 简化：用ID作为时间戳估算（实际应记录完成时间）
                return parseInt(t.id) > sevenDaysAgo.getTime();
            }).length;
            
            if (recentCompleted > 0) {
                recentContainer.innerHTML = `<div class="text-4xl font-bold theme-text">${recentCompleted}</div>
                    <div class="text-sm text-gray-500 mt-2">继续保持！💪</div>`;
            } else {
                recentContainer.innerHTML = '<div class="text-gray-400">最近7天暂无完成记录</div>';
            }
        }

        // ==================== 导出功能 ====================
        function exportData() {
            if (!confirm('确定要导出所有数据吗？')) return;
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily-planner-${getTodayStr()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== 设置功能 ====================
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('themeColorPicker').value = data.settings.theme;
            document.getElementById('glassOpacityPicker').value = data.settings.glassOpacity;
            document.getElementById('imgOpacityPicker').value = data.settings.imgOpacity || 0.5;
            document.getElementById('categoriesInput').value = data.categories.join(', ');
            
            // 禁止背景滚动
            document.body.style.overflow = 'hidden';
        }

        function setPresetColor(color) {
            document.getElementById('themeColorPicker').value = color;
            updateStyleRealtime();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('图片需小于5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                data.settings.bg = ev.target.result;
                updateStyleRealtime();
            };
            reader.readAsDataURL(file);
        }

        function clearBackground() {
            data.settings.bg = '';
            updateStyleRealtime();
            document.getElementById('localBgInput').value = '';
        }

        function saveSettings() {
            data.settings.theme = document.getElementById('themeColorPicker').value;
            data.settings.glassOpacity = document.getElementById('glassOpacityPicker').value;
            data.settings.imgOpacity = document.getElementById('imgOpacityPicker').value;
            
            const categoriesText = document.getElementById('categoriesInput').value;
            data.categories = categoriesText.split(/[,，]/).map(s => s.trim()).filter(s => s);
            
            if (data.categories.length === 0) {
                data.categories = ['工作', '学习', '生活', '健康'];
            }
            
            saveData();
            closeModal('settingsModal');
            renderAll();
        }

        function updateStyleRealtime() {
            const color = document.getElementById('themeColorPicker').value;
            const glassOp = document.getElementById('glassOpacityPicker').value;
            const imgOp = document.getElementById('imgOpacityPicker').value;
            
            const rgb = hexToRgb(color);
            const lightColor = `rgba(${rgb}, 0.1)`;
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-light', lightColor);
            document.documentElement.style.setProperty('--glass-opacity', glassOp);
            document.documentElement.style.setProperty('--img-opacity', imgOp);
            
            if (data.settings.bg) {
                document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
            } else {
                document.documentElement.style.setProperty('--bg-image', 'none');
            }
        }

        function applyStyles() {
            const rgb = hexToRgb(data.settings.theme);
            const lightColor = `rgba(${rgb}, 0.1)`;
            
            document.documentElement.style.setProperty('--theme-color', data.settings.theme);
            document.documentElement.style.setProperty('--theme-light', lightColor);
            document.documentElement.style.setProperty('--glass-opacity', data.settings.glassOpacity);
            document.documentElement.style.setProperty('--img-opacity', data.settings.imgOpacity);
            
            if (data.settings.bg) {
                document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
            }
        }

        // ==================== UI 操作 ====================
        function switchTab(tabName) {
            // 只在移动端生效
            if (window.innerWidth >= 1024) return;
            
            // 移除所有active类
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('#ddlSection, #goalsSection, #todoSection, #completedSection').forEach(section => {
                section.classList.remove('active');
            });
            
            // 添加active类到当前标签
            event.currentTarget.classList.add('active');
            
            // 显示对应的section
            const sectionMap = {
                'ddl': 'ddlSection',
                'goals': 'goalsSection',
                'todo': 'todoSection',
                'completed': 'completedSection'
            };
            
            const targetSection = document.getElementById(sectionMap[tabName]);
            if (targetSection) {
                targetSection.classList.add('active');
                // 滚动到顶部
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function toggleSection(wrapperId, iconId, btnId) {
            const wrapper = document.getElementById(wrapperId);
            const icon = document.getElementById(iconId);
            const btn = btnId ? document.getElementById(btnId) : null;
            const parentPanel = wrapper.closest('.glass-panel');
            
            if (wrapper.classList.contains('collapsed')) {
                wrapper.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
                if (btn) btn.classList.remove('hidden-visually');
                if (parentPanel) parentPanel.classList.remove('is-collapsed');
            } else {
                wrapper.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                if (btn) btn.classList.add('hidden-visually');
                if (parentPanel) parentPanel.classList.add('is-collapsed');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            // 恢复背景滚动
            document.body.style.overflow = '';
        }

        function updateHeaderDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('headerDate').innerText = now.toLocaleDateString('zh-CN', options);
        }

        function saveData() {
            try {
                localStorage.setItem('dailyPlannerPro_v12', JSON.stringify(data));
            } catch (e) {
                console.error('数据保存失败:', e);
                alert('数据保存失败，可能是存储空间不足');
            }
        }

        function showDayDetail(dateStr) {
            const goals = data.goals.filter(g => g.ddl === dateStr && !g.completed);
            if (goals.length > 0) {
                alert(`${dateStr} 有 ${goals.length} 个截止目标:\n${goals.map(g => '• ' + g.title).join('\n')}`);
            }
        }

        // 页面加载时初始化
        init();
    </script>
</body>
</html>
