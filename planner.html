<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日计划 - 优化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --theme-color: #4f46e5;
            --theme-light: #e0e7ff;
            --theme-opacity: 1;
            --glass-opacity: 0.95;
            --img-opacity: 0.5;
            --left-width: 60%;
            --ddl-height: 400px;
            --todo-height: 500px;
            --goals-height: 400px;
            --completed-height: 400px;
            --bg-image: none;
            --bg-color: #f3f4f6;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
        }
        
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--bg-image); background-size: cover; background-position: center;
            opacity: var(--img-opacity); z-index: -1; pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* 玻璃面板 - 优化版 */
        .glass-panel {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .glass-panel.is-collapsed {
            height: auto !important;
            flex: 0 0 auto !important;
            min-height: 0 !important;
        }

        /* 主题样式 */
        .theme-text { color: var(--theme-color); transition: color 0.3s; }
        .theme-bg { background-color: var(--theme-color); transition: background-color 0.3s; }
        
        .theme-tag {
            background-color: var(--theme-light);
            color: var(--theme-color);
            border-radius: 4px; font-size: 11px; padding: 2px 6px; font-weight: bold;
            display: inline-block; transition: all 0.3s;
        }

        /* 优化：自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: rgba(0,0,0,0.2); 
            border-radius: 3px; 
            transition: background 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

        /* 优化：添加loading状态 */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        /* 优化：任务复选框动画 */
        .task-checkbox {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        .task-checkbox:hover { 
            border-color: var(--theme-color); 
            transform: scale(1.1);
        }
        .task-checkbox.checked {
            background-color: var(--theme-color);
            border-color: var(--theme-color);
        }
        .task-checkbox.checked i {
            opacity: 1 !important;
            color: white;
        }

        /* 折叠动画 */
        .panel-wrapper {
            flex: 1;
            transition: flex-grow 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }
        .panel-wrapper.collapsed {
            flex: 0 0 0; 
            opacity: 0; 
            padding: 0 !important;
        }
        .panel-inner { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* 拖动条样式 */
        .resizer-h {
            width: 14px; cursor: col-resize; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 20; margin: 0 -1px;
            background: transparent; 
            transition: all 0.2s; 
            border-radius: 8px; 
            align-self: stretch;
        }
        .resizer-h:hover, .resizer-h.active {
            background: rgba(255, 255, 255, var(--glass-opacity));
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .resizer-h::after {
            content: ""; width: 4px; height: 40px; 
            background-color: var(--theme-color); 
            border-radius: 2px; opacity: 0; 
            transition: opacity 0.2s;
        }
        .resizer-h:hover::after, .resizer-h.active::after { opacity: 0.5; }

        .resizer-v {
            height: 12px; cursor: row-resize; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 20; width: 100%;
            background: transparent; 
            transition: all 0.2s; 
            margin-top: -4px; margin-bottom: -4px; 
            position: relative;
        }
        .resizer-v:hover, .resizer-v.active { background: rgba(255, 255, 255, 0.5); }
        .resizer-v::after {
            content: ""; height: 4px; width: 40px; 
            background-color: var(--theme-color); 
            border-radius: 2px; opacity: 0; 
            transition: opacity 0.2s;
        }
        .resizer-v:hover::after, .resizer-v.active::after { opacity: 0.5; }

        /* 日历样式 */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            padding-bottom: 10px; 
        }
        .calendar-day {
            min-height: 90px;
            max-width: 100%; /* 固定最大宽度 */
            border-radius: 6px; 
            padding: 6px 4px 4px 4px; 
            cursor: pointer;
            border: 1px solid transparent; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            font-size: 14px;
        }
        .calendar-day:hover { 
            z-index: 10; 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        .cal-today { 
            border: 2px solid var(--theme-color); 
            font-weight: bold;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .pencil-circle {
            border: 2px solid #ef4444; 
            border-radius: 50%; 
            color: #ef4444; 
            font-weight: bold;
            width: 24px; height: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        .cal-goal-label {
            font-size: 11px; 
            color: #4b5563; 
            margin-top: 4px; 
            text-align: center;
            background: #f3f4f6; 
            padding: 1px 4px; 
            border-radius: 4px; 
            width: 90%;
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap;
        }

        .cal-task-item {
            background: var(--theme-color); 
            opacity: 0.8; 
            color: white; 
            padding: 1px 4px; 
            border-radius: 3px; 
            margin-top: 2px; 
            font-size: 10px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%;
            max-width: 100%; /* 强制限制宽度 */
            transition: all 0.2s;
        }
        .cal-task-item:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .cal-task-item.done { 
            background: #10b981; 
            text-decoration: line-through; 
            opacity: 0.6; 
        }
        
        /* 倒计时标签 - 调整位置避免重叠 */
        .countdown-badge-classic {
            position: absolute; 
            top: 2px; 
            right: 2px;
            font-size: 10px; 
            font-weight: 800;
            padding: 2px 5px; 
            border-radius: 6px;
            transition: all 0.2s;
            z-index: 5;
        }
        .countdown-badge-classic:hover {
            transform: scale(1.1);
        }
        .badge-urgent { background-color: #fee2e2; color: #ef4444; }
        .badge-warning { background-color: #ffedd5; color: #ea580c; }
        .badge-normal { background-color: var(--theme-light); color: var(--theme-color); }

        /* 任务分隔线 */
        .task-separator { 
            display: flex; 
            align-items: center; 
            margin: 16px 0 8px 0; 
            font-size: 12px; 
            color: #9ca3af; 
            font-weight: bold; 
        }
        .task-separator::before, .task-separator::after { 
            content: ""; 
            flex: 1; 
            height: 1px; 
            background: #e5e7eb; 
        }
        .task-separator span { margin: 0 10px; }

        /* 优化：添加淡入动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }

        /* 优化：提示工具 */
        .tooltip {
            position: relative;
        }
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 100;
        }
        .tooltip:hover::before {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }

        /* 响应式布局 */
        @media (min-width: 1024px) {
            #mainGrid { 
                display: grid; 
                grid-template-columns: var(--left-width) 14px 1fr; 
                align-items: start; 
                gap: 0;
            }
            #leftColumn, #rightColumn { 
                display: flex; 
                flex-direction: column; 
                gap: 12px;
            }
            /* 各个section使用指定高度 */
            #ddlSection { 
                height: var(--ddl-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            #todoSection { 
                height: var(--todo-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            #goalsSection { 
                height: var(--goals-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            #completedSection { 
                height: var(--completed-height);
                flex-shrink: 0;
                min-height: 200px;
            }
            /* 桌面端隐藏底部导航 */
            #mobileTabBar { 
                display: none !important; 
            }
        }
        
        /* 移动端布局 */
        @media (max-width: 1023px) {
            body {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            #mainGrid { 
                display: block;
                padding: 0 !important;
                padding-bottom: 70px !important;
                margin: 0 !important;
            }
            #resizerH, #resizerV1, #resizerV2 { display: none; }
            
            /* 移动端：只显示当前激活的section */
            #leftColumn, #rightColumn { 
                display: block;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* 默认隐藏所有section */
            #ddlSection, #todoSection, #goalsSection, #completedSection {
                display: none !important;
                height: auto !important;
                min-height: calc(100vh - 190px) !important;
                margin: 12px !important;
                visibility: hidden;
            }
            
            /* 只有激活的section才显示 */
            #ddlSection.active, #todoSection.active, #goalsSection.active, #completedSection.active {
                display: flex !important;
                visibility: visible !important;
            }
            
            /* 隐藏左右列的容器 */
            #leftColumn > *:not(.active),
            #rightColumn > *:not(.active) {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* 移动端底部导航栏 */
            #mobileTabBar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                display: flex;
                justify-content: space-around;
                padding: 8px 0 max(8px, env(safe-area-inset-bottom));
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            }
            
            .tab-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 8px 4px;
                color: #9ca3af;
                text-decoration: none;
                transition: all 0.3s;
                cursor: pointer;
                user-select: none;
            }
            
            .tab-item i {
                font-size: 20px;
                margin-bottom: 4px;
                transition: transform 0.3s;
            }
            
            .tab-item span {
                font-size: 11px;
                font-weight: 500;
            }
            
            .tab-item.active {
                color: var(--theme-color);
            }
            
            .tab-item.active i {
                transform: scale(1.1);
            }
            
            /* 移动端header优化 - 修改：保持显示 */
            header {
                margin: 12px !important;
                padding: 12px !important;
            }
            
            header .flex {
                width: 100%;
                justify-content: space-between;
            }
            
            header h1 {
                font-size: 18px !important;
            }
            
            header button {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            
            /* 移动端section优化 */
            .glass-panel {
                margin: 0 12px;
                border-radius: 16px !important;
            }
            
            /* 移动端任务卡片优化 */
            #stepsList > div {
                padding: 12px !important;
            }
            
            /* 移动端快捷输入框 */
            #quickIndependentInput {
                font-size: 14px !important;
            }
            
            /* 移动端隐藏统计和导出按钮 */
            header button[onclick="openStats()"],
            header button[onclick="exportData()"] {
                display: none;
            }
            
            /* 移动端设置弹窗优化 */
            #settingsModal > div {
                max-height: 65vh !important;
                padding: 12px !important;
                margin: 0 8px;
            }
            
            #settingsModal h3 {
                font-size: 16px !important;
                margin-bottom: 10px !important;
                padding-bottom: 8px !important;
            }
        }
        
        .hidden-visually { 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.2s; 
        }

        /* 优化：统计卡片 */
        .stat-card {
            background: linear-gradient(135deg, var(--theme-color) 0%, rgba(79, 70, 229, 0.8) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* 优化：空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* 日历滚动容器 */
        .calendar-scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body onmouseup="stopResize()" onmousemove="resize(event)">

    <div id="bg-layer"></div>

    <!-- 顶部导航 - 优化版 -->
    <header class="max-w-[95%] mx-auto flex flex-col md:flex-row justify-between items-center mb-4 mt-4 glass-panel p-4 rounded-2xl shadow-sm gap-4 shrink-0">
        <div class="flex items-center gap-4">
            <div class="bg-white/50 p-3 rounded-xl theme-text border border-white/60 shadow-sm">
                <i class="fa-solid fa-calendar-days text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold theme-text tracking-tight">每日计划</h1>
                <p class="text-gray-500 font-medium text-sm mt-0.5" id="headerDate">Loading...</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- 统计按钮 -->
            <button onclick="openStats()" class="tooltip flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm text-sm font-medium" data-tooltip="查看统计">
                <i class="fa-solid fa-chart-bar theme-text"></i>
            </button>
            <!-- 导出按钮 -->
            <button onclick="exportData()" class="tooltip flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm text-sm font-medium" data-tooltip="导出数据">
                <i class="fa-solid fa-download theme-text"></i>
            </button>
            <!-- 主题按钮 -->
            <button onclick="openSettings()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 transition shadow-sm text-sm font-medium">
                <i class="fa-solid fa-palette theme-text"></i> 主题
            </button>
        </div>
    </header>

    <!-- 主布局 -->
    <main id="mainGrid" class="max-w-[95%] mx-auto pb-4">
        
        <!-- 左侧列 -->
        <div id="leftColumn">
            <!-- 1. DDL 可视化 -->
            <section id="ddlSection" class="glass-panel rounded-2xl shadow-lg shrink-0 active" style="height: var(--ddl-height); min-height: 200px;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('ddlWrapper', 'ddlChevron', 'ddlControls')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-clock mr-2"></i>DDL 可视化
                    </h2>
                    <div class="flex gap-3 items-center">
                        <button onclick="event.stopPropagation(); openSettings()" class="lg:hidden w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-500 transition" title="设置">
                            <i class="fa-solid fa-palette text-sm"></i>
                        </button>
                        <div id="ddlControls" class="transition-opacity duration-200">
                            <select id="ddlFilterSelect" onclick="event.stopPropagation()" onchange="renderMiniCalendar()" class="text-xs bg-white border border-gray-200 rounded-lg px-2 py-1 outline-none text-gray-600 cursor-pointer hover:border-indigo-400">
                                <option value="all">全部目标</option>
                            </select>
                        </div>
                        <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="ddlChevron"></i>
                    </div>
                </div>
                <div id="ddlWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 bg-white/30 overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-3 px-1 shrink-0">
                            <span class="text-sm font-bold text-gray-700" id="miniCalTitle"></span>
                            <div class="flex gap-3">
                                <span class="text-[10px] text-gray-500 flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full theme-bg"></div>今天
                                </span>
                                <span class="text-[10px] text-gray-500 flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full border-2 border-red-500"></div>截止日
                                </span>
                            </div>
                        </div>
                        <div id="miniCalendar" class="calendar-grid"></div>
                    </div>
                </div>
            </section>

            <div id="resizerV1" class="resizer-v" onmousedown="startResize(event, 'v1')"></div>

            <!-- 2. 目标 -->
            <section id="goalsSection" class="glass-panel rounded-2xl shadow-lg" style="height: var(--goals-height); min-height: 200px;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('goalsWrapper', 'goalsChevron', 'addGoalBtn')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-bullseye mr-2"></i>目标
                    </h2>
                    <div class="flex gap-3 items-center">
                        <button id="addGoalBtn" onclick="event.stopPropagation(); openAddGoalModal()" class="text-xs bg-white border border-gray-200 hover:border-indigo-500 hover:text-indigo-600 px-3 py-1.5 rounded-full shadow-sm text-gray-600 transition flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i> 新建
                        </button>
                        <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="goalsChevron"></i>
                    </div>
                </div>
                <div id="goalsWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 space-y-3 bg-white/30 overflow-y-auto custom-scrollbar" id="goalsContent"></div>
                </div>
            </section>
        </div>

        <div id="resizerH" class="resizer-h" onmousedown="startResize(event, 'h')"></div>

        <!-- 右侧列 -->
        <div id="rightColumn">
            <!-- 3. 代办 -->
            <section id="todoSection" class="glass-panel rounded-2xl shadow-lg shrink-0" style="height: var(--todo-height); min-height: 200px;">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('stepsWrapper', 'stepsChevron')">
                    <div class="flex items-center gap-2">
                        <h2 class="text-xl font-bold theme-text pl-2">
                            <i class="fa-solid fa-list-check mr-2"></i>代办
                        </h2>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full" id="taskCountBadge">0</span>
                    </div>
                    <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="stepsChevron"></i>
                </div>
                <div id="stepsWrapper" class="panel-wrapper">
                    <div class="panel-inner flex flex-col h-full bg-white/30">
                        <div id="stepsList" class="space-y-3 p-5 flex-1 overflow-y-auto custom-scrollbar"></div>
                        <div class="p-5 pt-3 border-t-0 bg-transparent shrink-0">
                            <div class="flex gap-3 shadow-sm rounded-xl overflow-hidden border border-gray-200 bg-white p-1">
                                <input type="text" id="quickIndependentInput" placeholder="添加待办 (回车保存)..." class="flex-1 px-4 py-2 outline-none text-gray-700">
                                <button onclick="addIndependentTask()" class="theme-bg text-white px-6 rounded-lg font-medium hover:opacity-90 transition">
                                    <i class="fa-solid fa-plus mr-1"></i>添加
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="resizerV2" class="resizer-v" onmousedown="startResize(event, 'v2')"></div>

            <!-- 4. 已完成 -->
            <section id="completedSection" class="glass-panel rounded-2xl shadow-lg" style="height: var(--completed-height); min-height: 200px;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 cursor-pointer hover:bg-gray-100 transition select-none shrink-0" onclick="toggleSection('completedWrapper', 'completedChevron')">
                    <h2 class="text-lg font-bold theme-text pl-2">
                        <i class="fa-solid fa-check-circle mr-2"></i>已完成
                    </h2>
                    <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300" id="completedChevron"></i>
                </div>
                <div id="completedWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 bg-white/30 overflow-y-auto custom-scrollbar" id="completedContent">
                        <div id="completedList" class="grid grid-cols-1 gap-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 移动端底部导航栏 -->
    <nav id="mobileTabBar">
        <div class="tab-item active" onclick="switchTab('ddl')">
            <i class="fa-solid fa-clock"></i>
            <span>DDL</span>
        </div>
        <div class="tab-item" onclick="switchTab('goals')">
            <i class="fa-solid fa-bullseye"></i>
            <span>目标</span>
        </div>
        <div class="tab-item" onclick="switchTab('todo')">
            <i class="fa-solid fa-list-check"></i>
            <span>代办</span>
        </div>
        <div class="tab-item" onclick="switchTab('completed')">
            <i class="fa-solid fa-check-circle"></i>
            <span>已完成</span>
        </div>
    </nav>

    <!-- 弹窗：新建目标 -->
    <div id="goalModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in-up">
            <h3 class="text-xl font-bold mb-4 theme-text" id="goalModalTitle">
                <i class="fa-solid fa-flag mr-2"></i>新建目标
            </h3>
            <label class="block text-sm font-bold text-gray-700 mb-1">目标名称</label>
            <input type="text" id="goalTitle" class="w-full mb-4 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50" placeholder="输入目标名称...">
            <div class="flex gap-4 mb-6">
                <div class="w-1/2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">截止日期</label>
                    <input type="date" id="goalDDL" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                </div>
                <div class="w-1/2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">分类</label>
                    <select id="goalCategorySelect" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 h-[50px]"></select>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeModal('goalModal')" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition">
                    取消
                </button>
                <button onclick="saveGoal()" class="px-5 py-2 theme-bg text-white rounded-lg hover:opacity-90 font-medium shadow-md transition">
                    <i class="fa-solid fa-save mr-2"></i>保存
                </button>
            </div>
        </div>
    </div>

    <!-- 弹窗：详情 -->
    <div id="detailModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden fade-in-up">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h2 id="detailTitle" class="text-2xl font-bold theme-text tracking-tight"></h2>
                <button onclick="closeModal('detailModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-12 bg-white">
                <div class="md:col-span-8 p-6 overflow-y-auto custom-scrollbar border-r border-gray-100">
                    <div id="detailCalendarView" class="calendar-grid pb-20"></div>
                </div>
                <div class="md:col-span-4 flex flex-col h-full bg-gray-50/50">
                    <div class="p-5 border-b border-gray-100 bg-white">
                        <h4 class="font-bold text-gray-700 text-lg">
                            <i class="fa-solid fa-tasks mr-2"></i>任务清单
                        </h4>
                    </div>
                    <div id="detailTaskList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2"></div>
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <input type="text" id="quickTaskInput" placeholder="输入任务..." class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-300 outline-none bg-gray-50">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增：统计弹窗 -->
    <div id="statsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 fade-in-up max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold theme-text">
                    <i class="fa-solid fa-chart-line mr-2"></i>数据统计
                </h3>
                <button onclick="closeModal('statsModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- 统计卡片 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">总目标</div>
                    <div class="text-3xl font-bold" id="statTotalGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">进行中</div>
                    <div class="text-3xl font-bold" id="statActiveGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">总任务</div>
                    <div class="text-3xl font-bold" id="statTotalTasks">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-sm opacity-90 mb-1">完成率</div>
                    <div class="text-3xl font-bold" id="statCompletionRate">0%</div>
                </div>
            </div>
            
            <!-- 分类统计 -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-bold text-gray-700 mb-3">
                    <i class="fa-solid fa-tag mr-2"></i>分类统计
                </h4>
                <div id="categoryStats" class="space-y-2"></div>
            </div>
            
            <!-- 近期完成 -->
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-bold text-gray-700 mb-3">
                    <i class="fa-solid fa-history mr-2"></i>最近7天完成任务
                </h4>
                <div id="recentCompletions" class="text-center text-gray-500">暂无数据</div>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-[400px] shadow-2xl flex flex-col fade-in-up" style="max-height: 70vh; padding: 16px;">
            <h3 class="text-lg font-bold mb-3 theme-text shrink-0 border-b pb-2">
                <i class="fa-solid fa-palette mr-2"></i>主题设置
            </h3>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar -mx-2 px-2" style="min-height: 0;">
            
            <div class="space-y-2 mb-3 pb-3 border-b">
                <div>
                    <label class="block text-xs font-bold mb-1.5 text-gray-700">主题颜色</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="themeColorPicker" class="w-10 h-8 cursor-pointer rounded border border-gray-200 p-0.5" onchange="updateStyleRealtime()">
                        <span class="text-xs text-gray-500">点击色块选择</span>
                    </div>
                    <!-- 预设颜色 -->
                    <div class="flex gap-1.5 mt-2">
                        <button onclick="setPresetColor('#4f46e5')" class="w-7 h-7 rounded-full" style="background: #4f46e5" title="靛蓝"></button>
                        <button onclick="setPresetColor('#06b6d4')" class="w-7 h-7 rounded-full" style="background: #06b6d4" title="青色"></button>
                        <button onclick="setPresetColor('#10b981')" class="w-7 h-7 rounded-full" style="background: #10b981" title="绿色"></button>
                        <button onclick="setPresetColor('#f59e0b')" class="w-7 h-7 rounded-full" style="background: #f59e0b" title="橙色"></button>
                        <button onclick="setPresetColor('#ec4899')" class="w-7 h-7 rounded-full" style="background: #ec4899" title="粉色"></button>
                        <button onclick="setPresetColor('#8b5cf6')" class="w-7 h-7 rounded-full" style="background: #8b5cf6" title="紫色"></button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1.5 text-gray-700">背景板透明度</label>
                    <input type="range" id="glassOpacityPicker" min="0.3" max="1" step="0.05" class="w-full accent-indigo-600" oninput="updateStyleRealtime()">
                    <div class="flex justify-between text-xs text-gray-500 mt-0.5">
                        <span>透明</span>
                        <span>不透明</span>
                    </div>
                </div>
            </div>
            
            <div class="space-y-2 mb-3 pb-3 border-b">
                <label class="block text-xs font-bold text-gray-700 mb-1.5">背景图片</label>
                <input type="file" id="localBgInput" accept="image/*" onchange="handleImageUpload(event)" class="block w-full text-xs text-gray-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                <div>
                    <label class="block text-xs font-bold mb-1.5 text-gray-700 mt-2">图片透明度</label>
                    <input type="range" id="imgOpacityPicker" min="0" max="1" step="0.05" class="w-full accent-indigo-600" oninput="updateStyleRealtime()">
                    <div class="flex justify-between text-xs text-gray-500 mt-0.5">
                        <span>透明</span>
                        <span>不透明</span>
                    </div>
                </div>
                <button onclick="clearBackground()" class="w-full mt-2 px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-xs font-medium transition">
                    清除背景
                </button>
            </div>
            
            <div class="mb-3">
                <label class="block text-xs font-bold mb-1.5 text-gray-700">自定义分类 (用逗号分隔)</label>
                <input type="text" id="categoriesInput" class="w-full p-2 border rounded-lg text-xs outline-none focus:ring-2 focus:ring-indigo-400" placeholder="工作,学习,生活,健康">
            </div>
            
            </div>
            
            <div class="flex justify-end gap-2 pt-3 mt-3 border-t shrink-0">
                <button onclick="closeModal('settingsModal')" class="px-4 py-1.5 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition">
                    取消
                </button>
                <button onclick="saveSettings()" class="px-4 py-1.5 theme-bg text-white rounded-lg hover:opacity-90 text-sm font-medium shadow-md transition">
                    保存
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 数据结构 ====================
        let data = {
            goals: [],
            subtasks: [],
            categories: ['工作', '学习', '生活', '健康'],
            settings: {
                theme: '#4f46e5',
                glassOpacity: 0.95,
                imgOpacity: 0.5,
                bg: '',
                ddlHeight: 400,
                todoHeight: 500,
                goalsHeight: 400,
                completedHeight: 400,
                leftWidth: 60
            }
        };

        let currentGoalId = null;
        let editingGoalId = null;
        let editingTaskId = null;

        let resizingMode = null;

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function parseDateStr(str) {
            return new Date(str + ' 00:00:00');
        }

        function getTodayStr() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const d = parseDateStr(dateStr);
            return `${d.getMonth() + 1}/${d.getDate()}`;
        }

        function init() {
            const stored = localStorage.getItem('dailyPlannerPro_v12');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    data.goals = parsed.goals || [];
                    data.subtasks = parsed.subtasks || [];
                    data.categories = parsed.categories || ['工作', '学习', '生活', '健康'];
                    data.settings = Object.assign(data.settings, parsed.settings || {});
                    
                    // 恢复自定义尺寸
                    if (data.settings.ddlHeight) {
                        document.documentElement.style.setProperty('--ddl-height', data.settings.ddlHeight + 'px');
                    }
                    if (data.settings.todoHeight) {
                        document.documentElement.style.setProperty('--todo-height', data.settings.todoHeight + 'px');
                    }
                    if (data.settings.goalsHeight) {
                        document.documentElement.style.setProperty('--goals-height', data.settings.goalsHeight + 'px');
                    }
                    if (data.settings.completedHeight) {
                        document.documentElement.style.setProperty('--completed-height', data.settings.completedHeight + 'px');
                    }
                    if (data.settings.leftWidth) {
                        document.documentElement.style.setProperty('--left-width', data.settings.leftWidth + '%');
                    }
                    
                    applyStyles();
                } catch (e) {
                    console.error('数据解析失败:', e);
                }
            }
            
            renderAll();
            updateHeaderDate();
            
            // 设置快捷输入框的回车事件
            document.getElementById('quickIndependentInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addIndependentTask();
            });
            document.getElementById('quickTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') quickAddTask();
            });
        }

        // ==================== 拖动调整功能 ====================
        function startResize(e, mode) {
            e.preventDefault();
            resizingMode = mode;
            if (mode === 'h') {
                document.getElementById('resizerH').classList.add('active');
            } else if (mode === 'v1') {
                document.getElementById('resizerV1').classList.add('active');
            } else if (mode === 'v2') {
                document.getElementById('resizerV2').classList.add('active');
            }
        }

        function stopResize() {
            if (resizingMode) {
                if (resizingMode === 'h') {
                    document.getElementById('resizerH').classList.remove('active');
                } else if (resizingMode === 'v1') {
                    document.getElementById('resizerV1').classList.remove('active');
                } else if (resizingMode === 'v2') {
                    document.getElementById('resizerV2').classList.remove('active');
                }
                saveData();
            }
            resizingMode = null;
        }

        function resize(e) {
            if (!resizingMode) return;
            
            if (resizingMode === 'h') {
                // 左右比例调整
                const container = document.getElementById('mainGrid');
                const rect = container.getBoundingClientRect();
                const newLeft = ((e.clientX - rect.left) / rect.width) * 100;
                if (newLeft > 30 && newLeft < 70) {
                    document.documentElement.style.setProperty('--left-width', newLeft + '%');
                    data.settings.leftWidth = newLeft;
                }
            } else if (resizingMode === 'v1') {
                // DDL section高度调整
                const section = document.getElementById('ddlSection');
                const newH = e.clientY - section.getBoundingClientRect().top;
                if (newH > 200 && newH < 800) {
                    document.documentElement.style.setProperty('--ddl-height', newH + 'px');
                    data.settings.ddlHeight = newH;
                }
            } else if (resizingMode === 'v2') {
                // Todo section高度调整
                const section = document.getElementById('todoSection');
                const newH = e.clientY - section.getBoundingClientRect().top;
                if (newH > 200 && newH < 800) {
                    document.documentElement.style.setProperty('--todo-height', newH + 'px');
                    data.settings.todoHeight = newH;
                }
            }
        }

        // ==================== 渲染函数 ====================
        function renderAll() {
            renderGoals();
            renderDailySteps();
            renderCompleted();
            renderMiniCalendar();
        }

        // DDL 日历渲染 - 修改为只显示4周
        function renderMiniCalendar() {
            const container = document.getElementById('miniCalendar');
            container.innerHTML = '';
            
            const select = document.getElementById('ddlFilterSelect');
            const currentFilter = select.value;
            
            // 更新筛选选项
            const optionsHtml = '<option value="all">全部目标</option>' + 
                data.goals.filter(g => !g.completed)
                    .map(g => `<option value="${g.id}">${g.title}</option>`)
                    .join('');
            if (select.innerHTML !== optionsHtml) {
                select.innerHTML = optionsHtml;
                select.value = currentFilter;
            }

            const now = new Date();
            // 从本周周日开始
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            
            document.getElementById('miniCalTitle').innerText = `${now.getFullYear()}年 ${now.getMonth() + 1}月`;
            
            // 渲染星期标题
            ['日', '一', '二', '三', '四', '五', '六'].forEach(w => {
                container.innerHTML += `<div class="text-center text-[10px] text-gray-400 py-2 font-medium">${w}</div>`;
            });
            
            // 只显示4周（28天）
            let loop = new Date(startOfWeek);
            const daysToShow = 28;
            
            for (let i = 0; i < daysToShow; i++) {
                const dateStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isToday = dateStr === getTodayStr();
                
                if (currentFilter === 'all') {
                    // 显示所有目标
                    const goalsToday = data.goals.filter(g => g.ddl === dateStr && !g.completed);
                    let content = `<span class="relative z-10 ${goalsToday.length > 0 ? 'pencil-circle' : ''}">${loop.getDate()}</span>`;
                    if (goalsToday.length > 0) {
                        content += `<div class="cal-goal-label">${goalsToday[0].title}</div>`;
                        if (goalsToday.length > 1) {
                            content += `<div class="text-[9px] text-gray-400 mt-1">+${goalsToday.length - 1}</div>`;
                        }
                    }
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''}" onclick="showDayDetail('${dateStr}')">${content}</div>`;
                } else {
                    // 显示单个目标
                    const goal = data.goals.find(g => g.id === currentFilter);
                    if (!goal) continue;
                    
                    const isDDL = goal.ddl === dateStr;
                    const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                    
                    let html = `<span class="font-bold text-gray-500 z-10">${loop.getDate()}</span>`;
                    
                    // 倒计时标签
                    if (goal && loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        
                        if (diff <= 60) {
                            html += `<div class="countdown-badge-classic ${badgeClass}">${diff}天</div>`;
                        }
                    }
                    // DDL当天用红圈标注日期
                    if (isDDL) {
                        html = `<span class="pencil-circle z-10">${loop.getDate()}</span>`;
                    }
                    
                    // 任务列表
                    const tasks = data.subtasks.filter(s => s.goalId === currentFilter && s.date === dateStr);
                    const taskHtml = tasks.map(t => 
                        `<div class="cal-task-item ${t.completed ? 'done' : ''}">${t.title}</div>`
                    ).join('');
                    
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''} ${isDDL ? 'bg-red-50' : ''}" onclick="selectDateForTask('${dateStr}')">${html}<div class="w-full flex flex-col items-center mt-1">${taskHtml}</div></div>`;
                    currentGoalId = currentFilter;
                }
                
                loop.setDate(loop.getDate() + 1);
            }
        }

        // 代办任务渲染
        function renderDailySteps() {
            const container = document.getElementById('stepsList');
            let tasks = data.subtasks.filter(s => 
                !s.completed && 
                (!s.goalId || (data.goals.find(g => g.id === s.goalId) && !data.goals.find(g => g.id === s.goalId).completed))
            );
            
            document.getElementById('taskCountBadge').innerText = tasks.length;
            
            const todayStr = getTodayStr();
            const todayTasks = tasks.filter(t => t.date === todayStr);
            const futureTasks = tasks.filter(t => t.date > todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            const pastTasks = tasks.filter(t => t.date < todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));

            container.innerHTML = '';
            
            // 过期任务
            if (pastTasks.length) {
                container.innerHTML += pastTasks.map(t => renderTaskItem(t, 'past')).join('');
                container.innerHTML += `<div class="task-separator"><span>以上已过期</span></div>`;
            }
            
            // 今日任务
            if (todayTasks.length) {
                container.innerHTML += todayTasks.map(t => renderTaskItem(t, 'today')).join('');
            } else if (tasks.length > 0) {
                container.innerHTML += `<div class="text-center text-xs text-gray-400 py-4">
                    <i class="fa-solid fa-coffee text-2xl mb-2 opacity-50"></i>
                    <p>今天暂无安排，休息一下吧！</p>
                </div>`;
            } else {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-check-circle"></i>
                    <p>今日清闲，可以添加新任务</p>
                </div>`;
            }
            
            // 未来任务
            if (futureTasks.length) {
                container.innerHTML += `<div class="task-separator"><span>未来计划</span></div>`;
                container.innerHTML += futureTasks.map(t => renderTaskItem(t, 'future')).join('');
            }
        }

        function renderTaskItem(s, type) {
            const parent = s.goalId ? data.goals.find(g => g.id === s.goalId) : null;
            let border = type === 'today' ? 'border-l-4 border-[var(--theme-color)]' : 
                        (type === 'past' ? 'border-l-4 border-red-300' : 'border-l-4 border-gray-200');
            let bg = type === 'today' ? 'bg-white shadow-md transform scale-[1.01]' : 'bg-white/80 hover:bg-white shadow-sm';
            
            return `
            <div class="${bg} p-3 rounded-xl ${border} flex items-center justify-between group transition mb-2 fade-in-up">
                <div class="flex-1 min-w-0 mr-3">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-gray-800 text-sm truncate cursor-text" ondblclick="editTask('${s.id}')" title="${s.title}">${s.title}</span>
                        <button onclick="editTask('${s.id}')" class="opacity-0 group-hover:opacity-100 text-xs text-gray-300 hover:text-indigo-500 transition tooltip" data-tooltip="编辑">
                            <i class="fa-solid fa-pencil"></i>
                        </button>
                        ${parent ? `<span class="theme-tag truncate max-w-[80px]" title="${parent.title}">${parent.title}</span>` : ''}
                    </div>
                    <div class="text-xs text-gray-500 flex gap-3">
                        <span class="${type === 'past' ? 'text-red-500 font-bold' : ''}">
                            <i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}
                        </span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteTask('${s.id}')" class="w-7 h-7 rounded-full hover:bg-red-50 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition tooltip" data-tooltip="删除">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center transition hover:border-[var(--theme-color)] tooltip" data-tooltip="完成">
                        <i class="fa-solid fa-check text-xs opacity-0 group-hover:opacity-100 text-gray-400"></i>
                    </button>
                </div>
            </div>`;
        }

        // 目标渲染
        function renderGoals() {
            const container = document.getElementById('goalsContent');
            const list = data.goals.filter(g => !g.completed);
            list.sort((a, b) => parseDateStr(a.ddl) - parseDateStr(b.ddl));
            
            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-bullseye"></i>
                    <p>暂无目标，点击"新建"创建第一个目标</p>
                </div>`;
                return;
            }
            
            container.innerHTML = list.map(g => {
                const today = parseDateStr(getTodayStr());
                const diff = Math.ceil((parseDateStr(g.ddl) - today) / 86400000);
                
                let badgeClass = 'badge-normal';
                if (diff < 0) badgeClass = 'badge-urgent';
                else if (diff <= 3) badgeClass = 'badge-urgent';
                else if (diff <= 7) badgeClass = 'badge-warning';
                
                let badgeText = diff < 0 ? `逾期${Math.abs(diff)}天` : `${diff}天`;
                
                const relTasks = data.subtasks.filter(s => s.goalId === g.id);
                const progress = relTasks.length ? Math.round((relTasks.filter(s => s.completed).length / relTasks.length) * 100) : 0;
                
                return `
                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden fade-in-up" onclick="openDetail('${g.id}')">
                    <div class="absolute top-0 left-0 w-1 h-full theme-bg"></div>
                    <div class="flex justify-between items-start mb-1 pl-2">
                        <div class="font-bold text-gray-800 text-sm truncate pr-2" title="${g.title}">${g.title}</div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); openEditGoalModal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-gray-100 text-gray-400 hover:text-indigo-500 tooltip" data-tooltip="编辑">
                                <i class="fa-solid fa-pencil text-xs"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteGoal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-red-100 text-gray-400 hover:text-red-500 tooltip" data-tooltip="删除">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xs pl-2 mb-2">
                        <div>
                            <span class="countdown-badge-classic ${badgeClass} relative top-0 right-0">${badgeText}</span>
                            <span class="theme-tag ml-2">${g.category}</span>
                        </div>
                        <div class="text-gray-400 font-bold">${progress}%</div>
                    </div>
                    <div class="bg-gray-100 h-1 rounded-full ml-2 overflow-hidden w-[calc(100%-8px)]">
                        <div class="theme-bg h-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
        }

        // 已完成渲染
        function renderCompleted() {
            const container = document.getElementById('completedList');
            const completedGoals = data.goals.filter(g => g.completed);
            const completedTasks = data.subtasks.filter(s => s.completed);
            
            container.innerHTML = '';
            
            if (completedGoals.length === 0 && completedTasks.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-inbox"></i>
                    <p>暂无完成记录</p>
                </div>`;
                return;
            }
            
            // 显示已完成的目标
            completedGoals.forEach(g => {
                container.innerHTML += `
                <div class="bg-white p-3 rounded-lg border border-green-200 shadow-sm group relative overflow-hidden fade-in-up">
                    <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                    <div class="flex justify-between items-center pl-2">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <i class="fa-solid fa-flag text-green-500 flex-shrink-0"></i>
                            <span class="font-semibold text-gray-800 text-sm truncate" title="${g.title}">${g.title}</span>
                            <span class="theme-tag">${g.category}</span>
                        </div>
                        <button onclick="deleteGoal('${g.id}')" class="opacity-0 group-hover:opacity-100 w-6 h-6 rounded-full hover:bg-red-50 text-gray-300 hover:text-red-500 transition flex items-center justify-center">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>`;
            });
            
            // 显示已完成的任务
            completedTasks.forEach(t => {
                const parent = t.goalId ? data.goals.find(g => g.id === t.goalId) : null;
                container.innerHTML += `
                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm group relative overflow-hidden fade-in-up">
                    <div class="absolute top-0 left-0 w-1 h-full bg-gray-300"></div>
                    <div class="flex justify-between items-center pl-2">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <i class="fa-solid fa-check text-green-500 flex-shrink-0"></i>
                            <span class="text-gray-500 text-sm truncate line-through" title="${t.title}">${t.title}</span>
                            ${parent ? `<span class="theme-tag truncate max-w-[80px]" title="${parent.title}">${parent.title}</span>` : ''}
                        </div>
                        <button onclick="deleteTask('${t.id}')" class="opacity-0 group-hover:opacity-100 w-6 h-6 rounded-full hover:bg-red-50 text-gray-300 hover:text-red-500 transition flex items-center justify-center">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>`;
            });
        }

        // ==================== 目标相关操作 ====================
        function openAddGoalModal() {
            editingGoalId = null;
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-flag mr-2"></i>新建目标';
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDDL').value = '';
            
            // 更新分类选项
            const select = document.getElementById('goalCategorySelect');
            select.innerHTML = data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('goalModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function openEditGoalModal(id) {
            editingGoalId = id;
            const goal = data.goals.find(g => g.id === id);
            if (!goal) return;
            
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-edit mr-2"></i>编辑目标';
            document.getElementById('goalTitle').value = goal.title;
            document.getElementById('goalDDL').value = goal.ddl;
            
            const select = document.getElementById('goalCategorySelect');
            select.innerHTML = data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            select.value = goal.category;
            
            document.getElementById('goalModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function saveGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            const ddl = document.getElementById('goalDDL').value;
            const category = document.getElementById('goalCategorySelect').value;
            
            if (!title || !ddl) {
                alert('请填写完整信息');
                return;
            }
            
            if (editingGoalId) {
                const goal = data.goals.find(g => g.id === editingGoalId);
                if (goal) {
                    goal.title = title;
                    goal.ddl = ddl;
                    goal.category = category;
                }
            } else {
                data.goals.push({
                    id: Date.now().toString(),
                    title,
                    ddl,
                    category,
                    completed: false
                });
            }
            
            saveData();
            closeModal('goalModal');
            renderAll();
        }

        function deleteGoal(id) {
            if (!confirm('确定要删除这个目标吗？相关的任务也会被删除。')) return;
            
            data.goals = data.goals.filter(g => g.id !== id);
            data.subtasks = data.subtasks.filter(s => s.goalId !== id);
            saveData();
            renderAll();
        }

        function openDetail(goalId) {
            currentGoalId = goalId;
            const goal = data.goals.find(g => g.id === goalId);
            if (!goal) return;
            
            document.getElementById('detailTitle').innerText = goal.title;
            document.getElementById('detailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            renderDetailCalendar();
            renderDetailTasks();
        }

        function renderDetailCalendar() {
            const container = document.getElementById('detailCalendarView');
            const goal = data.goals.find(g => g.id === currentGoalId);
            if (!goal) return;
            
            container.innerHTML = '';
            
            // 渲染星期标题
            ['日', '一', '二', '三', '四', '五', '六'].forEach(w => {
                container.innerHTML += `<div class="text-center text-[10px] text-gray-400 py-2 font-medium">${w}</div>`;
            });
            
            const start = parseDateStr(getTodayStr());
            const end = parseDateStr(goal.ddl);
            
            // 确保至少显示2周
            const minDays = 14;
            const daysDiff = Math.max(Math.ceil((end - start) / 86400000) + 1, minDays);
            
            let loop = new Date(start);
            loop.setDate(loop.getDate() - loop.getDay()); // 从周日开始
            
            const totalDays = Math.ceil(daysDiff / 7) * 7;
            
            for (let i = 0; i < totalDays; i++) {
                const dateStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isToday = dateStr === getTodayStr();
                const isDDL = goal.ddl === dateStr;
                const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                
                let html = `<span class="font-bold text-gray-500 z-10">${loop.getDate()}</span>`;
                
                // 倒计时标签
                if (loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                    let badgeClass = 'badge-normal';
                    if (diff <= 3) badgeClass = 'badge-urgent';
                    else if (diff <= 7) badgeClass = 'badge-warning';
                    
                    if (diff <= 60) {
                        html += `<div class="countdown-badge-classic ${badgeClass}">${diff}天</div>`;
                    }
                }
                if (isDDL) {
                    html = `<span class="pencil-circle z-10">${loop.getDate()}</span>`;
                }
                
                // 任务列表
                const tasks = data.subtasks.filter(s => s.goalId === currentGoalId && s.date === dateStr);
                const taskHtml = tasks.map(t => 
                    `<div class="cal-task-item ${t.completed ? 'done' : ''}" onclick="event.stopPropagation(); toggleTaskStatus('${t.id}')">${t.title}</div>`
                ).join('');
                
                container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''} ${isDDL ? 'bg-red-50' : ''}" onclick="selectDateForTask('${dateStr}')">${html}<div class="w-full flex flex-col items-center mt-1">${taskHtml}</div></div>`;
                
                loop.setDate(loop.getDate() + 1);
            }
        }

        function renderDetailTasks() {
            const container = document.getElementById('detailTaskList');
            const tasks = data.subtasks.filter(s => s.goalId === currentGoalId);
            tasks.sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            
            container.innerHTML = '';
            
            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-center text-xs text-gray-400 py-8">
                    <i class="fa-solid fa-tasks text-3xl mb-2 opacity-30"></i>
                    <p>暂无任务，点击日期添加</p>
                </div>`;
                return;
            }
            
            tasks.forEach(t => {
                const isPast = t.date < getTodayStr();
                container.innerHTML += `
                <div class="bg-white p-2 rounded-lg border border-gray-100 flex items-center gap-2 group hover:shadow-sm transition">
                    <button onclick="toggleTaskStatus('${t.id}')" class="task-checkbox ${t.completed ? 'checked' : ''} w-5 h-5 rounded-full border-2 ${t.completed ? 'border-[var(--theme-color)]' : 'border-gray-300'} flex items-center justify-center">
                        <i class="fa-solid fa-check text-xs ${t.completed ? 'opacity-100' : 'opacity-0'} text-white"></i>
                    </button>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm ${t.completed ? 'text-gray-400 line-through' : 'text-gray-700'} truncate" title="${t.title}">${t.title}</div>
                        <div class="text-[10px] ${isPast && !t.completed ? 'text-red-500 font-bold' : 'text-gray-400'}">${formatDate(t.date)}</div>
                    </div>
                    <button onclick="deleteTask('${t.id}')" class="opacity-0 group-hover:opacity-100 w-6 h-6 rounded-full hover:bg-red-50 text-gray-300 hover:text-red-500 transition flex items-center justify-center">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>`;
            });
        }

        // ==================== 任务相关操作 ====================
        let selectedDate = getTodayStr();

        function selectDateForTask(dateStr) {
            selectedDate = dateStr;
            document.getElementById('quickTaskInput').focus();
        }

        function quickAddTask() {
            const input = document.getElementById('quickTaskInput');
            const title = input.value.trim();
            
            if (!title || !currentGoalId) return;
            
            data.subtasks.push({
                id: Date.now().toString(),
                goalId: currentGoalId,
                title,
                date: selectedDate,
                completed: false
            });
            
            input.value = '';
            saveData();
            renderDetailCalendar();
            renderDetailTasks();
            renderDailySteps();
        }

        function addIndependentTask() {
            const input = document.getElementById('quickIndependentInput');
            const title = input.value.trim();
            
            if (!title) return;
            
            data.subtasks.push({
                id: Date.now().toString(),
                goalId: null,
                title,
                date: getTodayStr(),
                completed: false
            });
            
            input.value = '';
            saveData();
            renderDailySteps();
        }

        function toggleTaskStatus(id) {
            const task = data.subtasks.find(t => t.id === id);
            if (!task) return;
            
            task.completed = !task.completed;
            
            // 检查是否所有任务都完成
            if (task.goalId) {
                const relTasks = data.subtasks.filter(s => s.goalId === task.goalId);
                if (relTasks.length > 0 && relTasks.every(s => s.completed)) {
                    const goal = data.goals.find(g => g.id === task.goalId);
                    if (goal && confirm(`🎉 所有任务已完成！是否将目标"${goal.title}"标记为完成？`)) {
                        goal.completed = true;
                    }
                }
            }
            
            saveData();
            renderAll();
            if (currentGoalId) {
                renderDetailCalendar();
                renderDetailTasks();
            }
        }

        function editTask(id) {
            const task = data.subtasks.find(t => t.id === id);
            if (!task) return;
            
            const newTitle = prompt('修改任务名称:', task.title);
            if (newTitle && newTitle.trim()) {
                task.title = newTitle.trim();
                saveData();
                renderAll();
                if (currentGoalId) {
                    renderDetailCalendar();
                    renderDetailTasks();
                }
            }
        }

        function deleteTask(id) {
            if (!confirm('确定要删除这个任务吗？')) return;
            
            data.subtasks = data.subtasks.filter(t => t.id !== id);
            saveData();
            renderAll();
            if (currentGoalId) {
                renderDetailCalendar();
                renderDetailTasks();
            }
        }

        // ==================== 统计功能 ====================
        function openStats() {
            document.getElementById('statsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // 总目标
            document.getElementById('statTotalGoals').innerText = data.goals.length;
            
            // 进行中的目标
            const activeGoals = data.goals.filter(g => !g.completed).length;
            document.getElementById('statActiveGoals').innerText = activeGoals;
            
            // 总任务
            document.getElementById('statTotalTasks').innerText = data.subtasks.length;
            
            // 完成率
            const completedTasks = data.subtasks.filter(s => s.completed).length;
            const rate = data.subtasks.length > 0 ? Math.round((completedTasks / data.subtasks.length) * 100) : 0;
            document.getElementById('statCompletionRate').innerText = rate + '%';
            
            // 分类统计
            const categoryContainer = document.getElementById('categoryStats');
            categoryContainer.innerHTML = '';
            
            data.categories.forEach(cat => {
                const count = data.goals.filter(g => g.category === cat).length;
                if (count > 0) {
                    categoryContainer.innerHTML += `
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">${cat}</span>
                        <span class="font-bold theme-text">${count}</span>
                    </div>`;
                }
            });
            
            // 最近7天完成任务数
            const recentContainer = document.getElementById('recentCompletions');
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const recentCompleted = data.subtasks.filter(s => {
                return s.completed && parseDateStr(s.date) >= sevenDaysAgo;
            }).length;
            
            if (recentCompleted > 0) {
                recentContainer.innerHTML = `<div class="text-4xl font-bold theme-text">${recentCompleted}</div>
                    <div class="text-sm text-gray-500 mt-2">继续保持！💪</div>`;
            } else {
                recentContainer.innerHTML = '<div class="text-gray-400">最近7天暂无完成记录</div>';
            }
        }

        // ==================== 导出功能 ====================
        function exportData() {
            if (!confirm('确定要导出所有数据吗？')) return;
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily-planner-${getTodayStr()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== 设置功能 ====================
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('themeColorPicker').value = data.settings.theme;
            document.getElementById('glassOpacityPicker').value = data.settings.glassOpacity;
            document.getElementById('imgOpacityPicker').value = data.settings.imgOpacity || 0.5;
            document.getElementById('categoriesInput').value = data.categories.join(', ');
            
            // 禁止背景滚动
            document.body.style.overflow = 'hidden';
        }

        function setPresetColor(color) {
            document.getElementById('themeColorPicker').value = color;
            updateStyleRealtime();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('图片需小于5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                data.settings.bg = ev.target.result;
                updateStyleRealtime();
            };
            reader.readAsDataURL(file);
        }

        function clearBackground() {
            data.settings.bg = '';
            updateStyleRealtime();
            document.getElementById('localBgInput').value = '';
        }

        function saveSettings() {
            data.settings.theme = document.getElementById('themeColorPicker').value;
            data.settings.glassOpacity = document.getElementById('glassOpacityPicker').value;
            data.settings.imgOpacity = document.getElementById('imgOpacityPicker').value;
            
            const categoriesText = document.getElementById('categoriesInput').value;
            data.categories = categoriesText.split(/[,،]/).map(s => s.trim()).filter(s => s);
            
            if (data.categories.length === 0) {
                data.categories = ['工作', '学习', '生活', '健康'];
            }
            
            saveData();
            closeModal('settingsModal');
            renderAll();
        }

        function updateStyleRealtime() {
            const color = document.getElementById('themeColorPicker').value;
            const glassOp = document.getElementById('glassOpacityPicker').value;
            const imgOp = document.getElementById('imgOpacityPicker').value;
            
            const rgb = hexToRgb(color);
            const lightColor = `rgba(${rgb}, 0.1)`;
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-light', lightColor);
            document.documentElement.style.setProperty('--glass-opacity', glassOp);
            document.documentElement.style.setProperty('--img-opacity', imgOp);
            
            if (data.settings.bg) {
                document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
            } else {
                document.documentElement.style.setProperty('--bg-image', 'none');
            }
        }

        function applyStyles() {
            const rgb = hexToRgb(data.settings.theme);
            const lightColor = `rgba(${rgb}, 0.1)`;
            
            document.documentElement.style.setProperty('--theme-color', data.settings.theme);
            document.documentElement.style.setProperty('--theme-light', lightColor);
            document.documentElement.style.setProperty('--glass-opacity', data.settings.glassOpacity);
            document.documentElement.style.setProperty('--img-opacity', data.settings.imgOpacity);
            
            if (data.settings.bg) {
                document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
            }
        }

        // ==================== UI 操作 ====================
        function switchTab(tabName) {
            // 只在移动端生效
            if (window.innerWidth >= 1024) return;
            
            // 先隐藏所有section
            const allSections = ['ddlSection', 'goalsSection', 'todoSection', 'completedSection'];
            allSections.forEach(id => {
                const section = document.getElementById(id);
                section.classList.remove('active');
                section.style.display = 'none';
                section.style.visibility = 'hidden';
            });
            
            // 移除所有tab的active类
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 添加active类到当前标签
            event.currentTarget.classList.add('active');
            
            // 显示对应的section
            const sectionMap = {
                'ddl': 'ddlSection',
                'goals': 'goalsSection',
                'todo': 'todoSection',
                'completed': 'completedSection'
            };
            
            const targetSectionId = sectionMap[tabName];
            const targetSection = document.getElementById(targetSectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'flex';
                targetSection.style.visibility = 'visible';
                
                // 滚动到顶部
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 50);
            }
        }
        
        function toggleSection(wrapperId, iconId, btnId) {
            const wrapper = document.getElementById(wrapperId);
            const icon = document.getElementById(iconId);
            const btn = btnId ? document.getElementById(btnId) : null;
            const parentPanel = wrapper.closest('.glass-panel');
            
            if (wrapper.classList.contains('collapsed')) {
                wrapper.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
                if (btn) btn.classList.remove('hidden-visually');
                if (parentPanel) parentPanel.classList.remove('is-collapsed');
            } else {
                wrapper.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                if (btn) btn.classList.add('hidden-visually');
                if (parentPanel) parentPanel.classList.add('is-collapsed');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            // 恢复背景滚动
            document.body.style.overflow = '';
        }

        function updateHeaderDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('headerDate').innerText = now.toLocaleDateString('zh-CN', options);
        }

        function saveData() {
            try {
                localStorage.setItem('dailyPlannerPro_v12', JSON.stringify(data));
            } catch (e) {
                console.error('数据保存失败:', e);
                alert('数据保存失败，可能是存储空间不足');
            }
        }

        function showDayDetail(dateStr) {
            const goals = data.goals.filter(g => g.ddl === dateStr && !g.completed);
            if (goals.length > 0) {
                alert(`${dateStr} 有 ${goals.length} 个截止目标:\n${goals.map(g => '• ' + g.title).join('\n')}`);
            }
        }

        // 页面加载时初始化
        init();
    </script>
</body>
</html>
