<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Serif+SC:wght@500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* === é…è‰²æ–¹æ¡ˆ (Light Academia & Notion) === */
            --bg-color: #F9F7F3;       /* æš–ç±³ç™½èƒŒæ™¯ */
            --card-bg: #FFFFFF;        /* çº¯ç™½å¡ç‰‡ */
            
            /* ä¸»é¢˜è‰²ï¼šå¤å¤é™¶åœŸæ£• (é»˜è®¤) */
            --theme-color: #8D7B68;    
            --theme-light: rgba(141, 123, 104, 0.15);
            --theme-hover: rgba(141, 123, 104, 0.08);

            /* æ–‡å­—é¢œè‰² */
            --text-main: #37352F;      /* Notion Black */
            --text-muted: #9B9A97;     /* Muted Gray */
            
            /* è¾¹æ¡†ä¸åˆ†å‰² */
            --border-color: #E6E0D9;
            --shadow-subtle: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.03);

            /* åŠŸèƒ½è‰² */
            --color-success: #448361; /* æ£®æ—ç»¿ */
            --color-danger: #D44C47;  /* å¤å¤çº¢ */

            /* å…¼å®¹å˜é‡ */
            --glass-opacity: 1; 
            --img-opacity: 1;
            --bg-image: none;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }

        /* æ ‡é¢˜å­—ä½“ */
        h1, h2, h3, .serif-font {
            font-family: 'Noto Serif SC', serif;
        }

        /* === é¡¶éƒ¨æ ·å¼ === */
        header.glass-panel {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            margin-top: 20px !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: flex-end !important;
            gap: 20px;
        }

        #appTitle {
            font-size: 2.2rem;
            color: var(--text-main);
            border-bottom: none !important;
            line-height: 1.2;
        }
        #headerDate {
            color: var(--text-muted);
            font-family: 'Noto Serif SC', serif;
            font-weight: 500;
        }

        /* === å¯¼èˆªæ  === */
        .nav-switch {
            background: transparent !important;
            padding: 0;
            border-radius: 0;
            gap: 24px;
            backdrop-filter: none;
            border-bottom: 1px solid var(--border-color);
            width: 100%;
            padding-bottom: 0px;
        }
        .nav-btn {
            width: auto;
            height: 36px;
            background: transparent !important;
            color: var(--text-muted);
            border-radius: 0;
            box-shadow: none !important;
            font-size: 15px;
            font-family: 'Noto Serif SC', serif;
            position: relative;
            padding: 0 4px;
        }
        .nav-btn:hover:not(.active) {
            color: var(--theme-color);
            background: transparent !important;
        }
        .nav-btn.active {
            color: var(--text-main);
            background: transparent !important;
            font-weight: 700;
        }
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--text-main);
        }

        .view-container { display: none; animation: fadeIn 0.3s ease-out; }
        .view-container.active { display: block; }

        /* å¸ƒå±€ */
        #calendarView { height: calc(100vh - 180px); min-height: 500px; }
        #dashboardView { display: none; }
        #dashboardView.active {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            height: calc(100vh - 180px);
            min-height: 500px;
        }
        @media (max-aspect-ratio: 1/1) {
            #dashboardView.active { grid-template-columns: 1fr; height: auto; }
            .dashboard-col { height: 500px; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .theme-text { color: var(--theme-color) !important; }
        .theme-bg { background-color: var(--theme-color) !important; }
        
        .theme-tag {
            background-color: var(--theme-light);
            color: var(--theme-color);
            border: none;
            border-radius: 4px; 
            font-size: 11px; 
            padding: 2px 8px; 
            font-weight: bold;
            display: inline-block; 
            transition: all 0.3s;
        }

        /* æ»šåŠ¨æ¡ */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #D3D1CB;
            border-radius: 3px; 
            transition: background 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #A0A0A0; }

        .glass-panel {
            background: var(--card-bg) !important;
            backdrop-filter: none !important;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            border-radius: 4px !important; 
        }

        .task-checkbox {
            position: relative;
            transition: all 0.2s ease;
            background: white;
            border-radius: 3px !important;
            border: 1px solid #C0C0C0 !important;
        }
        .task-checkbox:hover { background-color: #F0F0F0; }
        .task-checkbox.checked {
            background-color: var(--theme-color) !important;
            border-color: var(--theme-color) !important;
        }
        .task-checkbox.checked i { opacity: 1 !important; color: white; font-size: 10px; }

        .bulk-checkbox {
            width: 18px; height: 18px;
            border: 1px solid #C0C0C0;
            border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.1s; cursor: pointer; background: white;
        }
        .bulk-checkbox.selected { background-color: var(--color-danger); border-color: var(--color-danger); }
        .bulk-checkbox.selected i { opacity: 1; }
        .bulk-checkbox i { color: white; font-size: 10px; opacity: 0; }

        .panel-wrapper { flex: 1; transition: flex-grow 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; overflow: hidden; display: flex; flex-direction: column; }
        .panel-wrapper.collapsed { flex: 0 0 0; opacity: 0; padding: 0 !important; }
        .panel-inner { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: transparent !important; }

        /* === æ—¥å† === */
        .calendar-grid { 
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr)); 
            border-top: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
        }
        .calendar-day {
            min-height: 100px;
            padding: 8px; 
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: white; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start;
            transition: background 0.2s; 
            position: relative; 
            font-size: 14px;
            overflow: hidden;
            border-radius: 0;
        }
        .calendar-day:hover { background-color: #FAFAFA; z-index: 10; overflow: visible; }
        
        .cal-today { 
            background-color: #F7F6F3;
            border: none;
            box-shadow: inset 0 0 0 1px var(--border-color);
        }
        .cal-today span {
            color: var(--theme-color);
            font-weight: bold;
            border-bottom: 2px solid var(--theme-color);
        }
        
        .date-highlight-theme { color: var(--theme-color); font-weight: 800; font-size: 1.1em; }

        .date-circle-red {
            color: var(--color-danger);            
            font-weight: bold;
            border-bottom: 2px solid var(--color-danger);
            border-radius: 0;
            display: inline-block;
        }

        /* ä¿®æ”¹ï¼šæ—¥å†ä¸­çš„ç›®æ ‡æ ‡ç­¾æ”¹ä¸º Notion é£æ ¼ (å½©è‰²èƒŒæ™¯+æ·±è‰²å­—) */
        .cal-goal-tag {
            font-size: 11px;
            color: var(--theme-color); /* æ·±è‰²ä¸»é¢˜å­— */
            background: var(--theme-light); /* æµ…è‰²ä¸»é¢˜åº• */
            margin-top: 2px; 
            text-align: left;
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: 600; 
            width: 100%;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* ä¿®æ”¹ï¼šæ—¥å†ä»»åŠ¡æ ‡ç­¾æ”¹ä¸ºå…¨è‰²å—å¡«å…… */
        .cal-task-item {
            color: var(--text-main); 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-top: 2px; 
            font-size: 11px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%; max-width: 100%; 
            transition: all 0.2s;
            position: relative; text-align: left;
            border: none; 
        }
        .cal-task-item.done { opacity: 0.5; text-decoration: line-through; }
        
        .countdown-badge-classic {
            position: absolute; top: 4px; right: 4px;
            font-size: 10px; font-weight: 600;
            padding: 1px 5px; border-radius: 2px; z-index: 5;
        }
        .badge-urgent { background-color: #FFDCDD; color: #D44C47; }
        .badge-warning { background-color: #FFE8CC; color: #D9730D; }
        .badge-normal { background-color: #E3E2E0; color: #787774; }

        .task-separator { display: flex; align-items: center; margin: 16px 0 8px 0; font-size: 12px; color: var(--text-muted); font-weight: 600; font-family: 'Noto Serif SC', serif; }
        .task-separator::before, .task-separator::after { content: ""; flex: 1; height: 1px; background: #E0E0E0; }
        .task-separator span { margin: 0 10px; }

        .fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stat-card {
            background: white;
            color: var(--text-main); 
            padding: 16px; 
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-subtle);
        }
        .stat-card .text-3xl { color: var(--theme-color); font-family: 'Playfair Display', serif; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; color: #D3D1CB; }
        .empty-state i { font-size: 32px; margin-bottom: 12px; opacity: 0.8; }

        .header-btn { background: transparent; border: 1px solid transparent; }
        .header-btn:hover { background: var(--theme-hover); color: var(--theme-color); }

        button { -webkit-tap-highlight-color: transparent; outline: none; }
        
        .add-btn-theme { border: 1px solid transparent; color: var(--text-muted); transition: all 0.2s; }
        .add-btn-theme:hover, .add-btn-theme:focus { background-color: var(--theme-hover) !important; color: var(--theme-color) !important; }
        
        .restore-btn-theme:hover, .edit-btn-theme:hover { color: var(--theme-color) !important; }

        .z-60 { z-index: 60 !important; }

        .color-input-square { width: 32px; height: 32px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; overflow: hidden; display: inline-block; vertical-align: middle; }
        .scheme-slot { width: 32px; height: 32px; border: 1px dashed #d1d5db; border-radius: 4px; cursor: pointer; position: relative; transition: all 0.2s; background-color: white; display: flex; align-items: center; justify-content: center; }

        .fixed.inset-0 { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(2px); }
        #goalModal .bg-white, #taskModal .bg-white, #detailModal .bg-white, #statsModal .bg-white, #settingsModal .bg-white {
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-radius: 6px;
        }
        
        input[type="text"], input[type="date"], select, textarea {
            background-color: #F7F7F5 !important;
            border: 1px solid transparent !important;
            border-radius: 4px !important;
            transition: all 0.2s;
            color: var(--text-main);
        }
        input:focus, select:focus, textarea:focus {
            background-color: white !important;
            border-color: var(--theme-color) !important;
            box-shadow: 0 0 0 2px var(--theme-light);
        }

        .hover\:bg-gray-100:hover { background-color: #F7F6F3 !important; }
        
        .task-item-card {
            background: white !important;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            border-radius: 4px !important;
            margin-bottom: 8px;
        }
        .task-item-card:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-color: #D0D0D0;
        }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar-transition { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <header class="max-w-[95%] mx-auto mb-4 glass-panel px-6 py-3 shrink-0 relative z-20">
        <div class="flex flex-col gap-1 flex-1">
             <div class="flex items-baseline gap-4">
                <h1 id="appTitle" 
                    contenteditable="true" 
                    spellcheck="false"
                    class="font-bold tracking-tight outline-none cursor-text transition-all min-w-[100px]" 
                    onblur="saveAppTitle()"
                    onkeydown="handleTitleKeydown(event)">
                    My Planner
                </h1>
                <p class="text-sm mt-0.5" id="headerDate">åŠ è½½ä¸­...</p>
            </div>
            
            <div class="nav-switch mt-4 flex">
                <button onclick="switchView('calendar')" class="nav-btn active" id="btn-calendar">æ—¥å†</button>
                <button onclick="switchView('dashboard')" class="nav-btn" id="btn-dashboard">çœ‹æ¿</button>
            </div>
        </div>

        <div class="flex gap-2 justify-end items-center self-end mb-1">
            <button onclick="openStats()" class="header-btn flex items-center justify-center w-8 h-8 rounded text-gray-400 transition" title="æ•°æ®ç»Ÿè®¡">
                <i class="fa-solid fa-chart-bar"></i>
            </button>
            <button onclick="openSettings()" class="header-btn flex items-center justify-center w-8 h-8 rounded text-gray-400 transition" title="è®¾ç½®">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <main class="max-w-[95%] mx-auto pb-8 relative z-20">
        
        <div id="calendarView" class="view-container active">
            <section id="ddlSection" class="glass-panel rounded-lg w-full h-full">
                <div class="p-0 bg-white overflow-y-auto custom-scrollbar" style="height: 100%;">
                    <div class="flex justify-between items-center p-4 sticky top-0 bg-white z-20 border-b border-[#E6E0D9]">
                        <span class="text-xl font-bold serif-font text-gray-800" id="miniCalTitle"></span>
                        
                        <div class="flex gap-4 items-center">
                            <div id="todayProgress" class="flex items-center gap-2 text-xs opacity-0 transition-opacity duration-300">
                                <span class="text-gray-500 font-medium" id="progressText">ä»Šæ—¥: 0%</span>
                                <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progressBar" class="h-full theme-bg progress-bar-transition" style="width: 0%"></div>
                                </div>
                                <span id="celebration" class="hidden text-sm">ğŸ‰</span>
                            </div>

                            <select id="ddlFilterSelect" onchange="renderMiniCalendar()" class="text-xs bg-[#F7F7F5] border-none rounded px-2 py-1 outline-none text-gray-600 cursor-pointer">
                                <option value="all">å…¨éƒ¨ç›®æ ‡</option>
                            </select>
                        </div>
                    </div>
                    <div id="miniCalendar" class="calendar-grid"></div>
                </div>
            </section>
        </div>

        <div id="dashboardView" class="view-container">
            <section id="goalsSection" class="glass-panel rounded-lg dashboard-col">
                <div class="p-3 border-b border-[#E6E0D9] flex justify-between items-center cursor-pointer hover:bg-[#F7F6F3] transition select-none shrink-0" onclick="toggleSection('goalsWrapper', 'goalsChevron', 'addGoalBtn')">
                    <h2 class="text-lg font-bold text-[#37352F] pl-1 serif-font">ç›®æ ‡</h2>
                    <div class="flex gap-3 items-center">
                        <button id="addGoalBtn" onclick="event.stopPropagation(); openAddGoalModal()" class="add-btn-theme text-xs px-2 py-1 rounded flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <i class="fa-solid fa-chevron-down text-gray-300 transition-transform duration-300" id="goalsChevron"></i>
                    </div>
                </div>
                <div id="goalsWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 space-y-3 bg-white overflow-y-auto custom-scrollbar" id="goalsContent"></div>
                </div>
            </section>

            <section id="todoSection" class="glass-panel rounded-lg dashboard-col">
                <div class="p-3 border-b border-[#E6E0D9] flex justify-between items-center cursor-pointer hover:bg-[#F7F6F3] transition select-none shrink-0" onclick="toggleSection('stepsWrapper', 'stepsChevron', 'addTaskBtn')">
                    <div class="flex items-center gap-2">
                        <h2 class="text-lg font-bold text-[#37352F] pl-1 serif-font">å¾…åŠ</h2>
                        <span class="text-xs text-gray-400 font-normal" id="taskCountBadge">0</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <button id="bulkSelectBtn" onclick="event.stopPropagation(); toggleSelectionMode()" class="add-btn-theme text-xs px-2 py-1 rounded flex items-center gap-1" title="æ‰¹é‡ç®¡ç†">
                            <i class="fa-solid fa-list-check"></i>
                        </button>
                        <button id="addTaskBtn" onclick="event.stopPropagation(); openAddTaskModal()" class="add-btn-theme text-xs px-2 py-1 rounded flex items-center gap-1">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <i class="fa-solid fa-chevron-down text-gray-300 transition-transform duration-300" id="stepsChevron"></i>
                    </div>
                </div>
                <div id="stepsWrapper" class="panel-wrapper">
                    <div class="panel-inner flex flex-col h-full bg-white">
                        <div id="stepsList" class="space-y-2 p-4 flex-1 overflow-y-auto custom-scrollbar"></div>
                        
                        <div id="bulkDeleteBar" class="p-3 pt-2 border-t-0 bg-transparent shrink-0 hidden">
                            <button onclick="deleteSelectedTasks()" class="w-full bg-[#D44C47] text-white py-2 rounded font-bold hover:opacity-90 transition shadow-sm text-sm">
                                <i class="fa-solid fa-trash mr-2"></i>åˆ é™¤é€‰ä¸­ä»»åŠ¡
                            </button>
                        </div>

                        <div id="quickAddBar" class="p-3 pt-2 border-t border-[#E6E0D9] bg-white shrink-0">
                            <div class="flex gap-2 items-center">
                                <input type="text" id="quickIndependentInput" placeholder="+ å¿«é€Ÿæ·»åŠ ä»Šæ—¥ä»»åŠ¡..." class="flex-1 px-0 py-1 outline-none text-gray-700 text-sm bg-transparent !important border-none !important focus:ring-0 !important shadow-none !important" onkeydown="if(event.key==='Enter')addQuickTask()">
                                <button onclick="addQuickTask()" class="text-gray-400 hover:text-[var(--theme-color)] px-2 transition shrink-0">
                                    <i class="fa-solid fa-arrow-turn-down text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="completedSection" class="glass-panel rounded-lg dashboard-col">
                <div class="p-3 border-b border-[#E6E0D9] flex justify-between items-center cursor-pointer hover:bg-[#F7F6F3] transition select-none shrink-0" onclick="toggleSection('completedWrapper', 'completedChevron')">
                    <h2 class="text-lg font-bold text-[#37352F] pl-1 serif-font">å·²å®Œæˆ</h2>
                    <i class="fa-solid fa-chevron-down text-gray-300 transition-transform duration-300" id="completedChevron"></i>
                </div>
                <div id="completedWrapper" class="panel-wrapper">
                    <div class="panel-inner p-4 bg-white overflow-y-auto custom-scrollbar" id="completedContent">
                        <div id="completedList" class="grid grid-cols-1 gap-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="goalModal" class="fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-md p-6 fade-in-up">
            <h3 class="text-xl font-bold mb-4 serif-font text-[#37352F]" id="goalModalTitle">æ–°å»ºç›®æ ‡</h3>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">åç§°</label>
            <input type="text" id="goalTitle" class="w-full mb-4 p-2 border rounded outline-none" placeholder="æƒ³è¾¾æˆä»€ä¹ˆç›®æ ‡ï¼Ÿ" onkeydown="if(event.key==='Enter')saveGoal()">
            <div class="flex gap-4 mb-6">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="goalDDL" class="w-full p-2 border rounded outline-none">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">åˆ†ç±»</label>
                    <select id="goalCategorySelect" class="w-full p-2 border rounded outline-none"></select>
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-4 border-t border-[#E6E0D9]">
                <button onclick="closeModal('goalModal')" class="px-4 py-1.5 text-gray-500 hover:bg-gray-100 rounded transition text-sm">å–æ¶ˆ</button>
                <button onclick="saveGoal()" class="px-4 py-1.5 theme-bg text-white rounded hover:opacity-90 font-medium shadow-sm transition text-sm">ä¿å­˜ç›®æ ‡</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="fixed inset-0 hidden flex items-center justify-center z-60 p-4">
        <div class="bg-white rounded-lg w-full max-w-md p-6 fade-in-up">
            <h3 id="taskModalTitle" class="text-xl font-bold mb-4 serif-font text-[#37352F]">æ–°å»ºä»»åŠ¡</h3>
            <input type="text" id="taskTitle" class="w-full mb-4 p-2 border-b border-0 rounded-none focus:border-[var(--theme-color)] bg-transparent !important text-lg font-medium placeholder-gray-300" placeholder="è¾“å…¥ä»»åŠ¡åç§°...">
            
            <div class="flex gap-4 mb-2">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">æ—¥æœŸ</label>
                    <input type="date" id="taskDate" class="w-full p-2 border rounded outline-none">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">å…³è”ç›®æ ‡</label>
                    <select id="taskGoalSelectModal" class="w-full p-2 border rounded outline-none">
                        <option value="">æ— ç›®æ ‡ (ç‹¬ç«‹ä»»åŠ¡)</option>
                    </select>
                </div>
            </div>

            <div id="taskRepeatSection" class="mb-4 mt-4 p-3 bg-[#F7F7F5] rounded">
                <div class="flex items-center gap-2 mb-2">
                    <input type="checkbox" id="taskRepeatToggle" onchange="toggleRepeatMode()" class="w-4 h-4 text-[var(--theme-color)] border-gray-300 rounded focus:ring-[var(--theme-color)]">
                    <label for="taskRepeatToggle" class="text-sm font-bold text-gray-700 select-none">æ¯å¤©é‡å¤</label>
                </div>
                <div id="repeatEndDateContainer" class="hidden fade-in-up mt-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ç›´åˆ° (ç»“æŸæ—¥æœŸ)</label>
                    <input type="date" id="taskEndDate" class="w-full p-2 border rounded outline-none">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">é¢œè‰²æ ‡è®°</label>
                <div id="taskPresetsList" class="flex gap-2 items-center flex-wrap"></div>
                <input type="hidden" id="taskColor" value="">
                <span id="taskColorPreview" class="hidden"></span>
            </div>
            
            <div class="flex justify-between pt-4 border-t border-[#E6E0D9] items-center">
                <button id="btnDeleteTask" onclick="deleteTaskFromModal()" class="hidden px-3 py-1.5 text-red-500 hover:bg-red-50 rounded text-sm transition">åˆ é™¤</button>
                <div class="flex gap-3 ml-auto">
                    <button onclick="closeModal('taskModal')" class="px-4 py-1.5 text-gray-500 hover:bg-gray-100 rounded transition text-sm">å–æ¶ˆ</button>
                    <button onclick="saveTaskFromModal()" class="px-4 py-1.5 theme-bg text-white rounded hover:opacity-90 font-medium shadow-sm transition text-sm">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden fade-in-up shadow-2xl">
            <div class="p-5 border-b border-[#E6E0D9] flex justify-between items-center bg-white">
                <h2 id="detailTitle" class="text-2xl font-bold serif-font tracking-tight"></h2>
                <button onclick="closeModal('detailModal')" class="w-8 h-8 rounded hover:bg-gray-100 flex items-center justify-center text-gray-500 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-12 bg-white">
                <div class="md:col-span-8 p-6 overflow-y-auto custom-scrollbar border-r border-[#E6E0D9]">
                    <div id="detailCalendarView" class="calendar-grid pb-20 border-l border-t border-[#E6E0D9]"></div>
                </div>
                <div class="md:col-span-4 flex flex-col h-full bg-[#F9F9F8] overflow-hidden">
                    <div class="p-5 border-b border-[#E6E0D9] bg-[#F9F9F8]">
                        <h4 class="font-bold text-gray-700 text-lg serif-font">ä»»åŠ¡æ¸…å•</h4>
                    </div>
                    <div id="detailTaskList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2"></div>
                    <div class="p-4 border-t border-[#E6E0D9] bg-white">
                        <input type="text" id="quickTaskInput" placeholder="+ æ·»åŠ å­ä»»åŠ¡..." class="w-full p-2 border-b border-0 rounded-none bg-transparent !important focus:border-[var(--theme-color)] outline-none text-sm">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="statsModal" class="fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-3xl p-8 fade-in-up max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold serif-font text-[#37352F]">æ•°æ®ç»Ÿè®¡</h3>
                <button onclick="closeModal('statsModal')" class="w-8 h-8 rounded hover:bg-gray-100 flex items-center justify-center text-gray-500 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ€»ç›®æ ‡</div>
                    <div class="text-3xl font-bold" id="statTotalGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">è¿›è¡Œä¸­</div>
                    <div class="text-3xl font-bold" id="statActiveGoals">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æ€»ä»»åŠ¡</div>
                    <div class="text-3xl font-bold" id="statTotalTasks">0</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">å®Œæˆç‡</div>
                    <div class="text-3xl font-bold" id="statCompletionRate">0%</div>
                </div>
            </div>
            
            <div class="flex gap-6">
                <div class="flex-1 bg-[#F7F7F5] rounded p-5">
                    <h4 class="font-bold text-gray-700 mb-4 serif-font">åˆ†ç±»ç»Ÿè®¡</h4>
                    <div id="categoryStats" class="space-y-2"></div>
                </div>
                <div class="flex-1 bg-[#F7F7F5] rounded p-5">
                    <h4 class="font-bold text-gray-700 mb-4 serif-font">è¿‘æœŸåŠ¨æ€</h4>
                    <div id="recentCompletions" class="text-center text-gray-500 text-sm mt-4">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar fade-in-up">
            <h3 class="text-xl font-bold mb-6 serif-font text-[#37352F]">è®¾ç½®</h3>
            
            <div class="space-y-4 mb-6 pb-6 border-b border-[#E6E0D9]">
                <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">å¤–è§‚è®¾ç½®</p>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">ä¸»é¢˜é¢œè‰²</label>
                    <input type="color" id="themeColorPicker" class="color-input-square" onchange="updateStyleRealtime()">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700">èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="bgColorPicker" class="color-input-square" onchange="updateStyleRealtime()">
                </div>
                 <div class="hidden">
                    <input type="range" id="glassOpacityPicker" min="0.3" max="1" step="0.05" oninput="updateStyleRealtime()">
                    <input type="range" id="imgOpacityPicker" min="0" max="1" step="0.05" oninput="updateStyleRealtime()">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-sm font-medium text-gray-700">è‡ªå®šä¹‰é…è‰²æ–¹æ¡ˆ</label>
                    <div class="flex gap-2" id="customSchemesContainer"></div>
                </div>
            </div>

            <div class="space-y-4 mb-6 pb-6 border-b border-[#E6E0D9]">
                <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">æ•°æ®ç®¡ç†</p>
                <div class="flex gap-3">
                    <button onclick="exportData()" class="flex-1 py-2 border border-gray-200 rounded text-sm font-medium text-gray-600 hover:bg-gray-50 transition">å¯¼å‡ºæ•°æ®</button>
                    <button onclick="triggerImport()" class="flex-1 py-2 border border-gray-200 rounded text-sm font-medium text-gray-600 hover:bg-gray-50 transition">å¯¼å…¥å¤‡ä»½</button>
                    <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="importData(this)">
                </div>
            </div>

            <div class="space-y-4 mb-6 pb-6 border-b border-[#E6E0D9]">
                <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">ä»»åŠ¡è‰²æ¿é…ç½®</p>
                <div class="flex gap-4 justify-between px-2" id="settingsPresetContainer"></div>
            </div>
            
            <div class="space-y-3 mb-6 pb-6 border-b border-[#E6E0D9]">
                <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">è‡ªå®šä¹‰èƒŒæ™¯å›¾</p>
                <input type="file" id="localBgInput" accept="image/*" class="w-full text-sm text-gray-500">
                <button onclick="clearBackground()" class="text-xs text-red-500 hover:text-red-700 transition">æ¸…é™¤èƒŒæ™¯å›¾</button>
            </div>
            
            <div class="space-y-3 mb-6">
                <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">åˆ†ç±»è®¾ç½®</p>
                <textarea id="categoriesInput" rows="2" class="w-full p-2 border rounded text-sm outline-none" placeholder="å·¥ä½œ, ç”Ÿæ´», å­¦ä¹ , å¥åº·..."></textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeModal('settingsModal')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded text-sm font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="flex-1 py-2 theme-bg text-white rounded text-sm font-bold hover:opacity-90 transition">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ•°æ®ç®¡ç† ====================
        let data = {
            goals: [],
            subtasks: [],
            categories: ['å·¥ä½œ', 'ç”Ÿæ´»', 'å­¦ä¹ ', 'å¥åº·'],
            settings: {
                theme: '#8D7B68', 
                themeOpacity: 1,
                glassOpacity: 1,
                imgOpacity: 1,
                bg: '',
                bgColor: '#F9F7F3', 
                appTitle: 'My Planner', 
                taskPresets: ["#D3E5EF", "#E8DEEE", "#FDECC8", "#F4E0E9", "#DBEDDB"],
                customSchemes: [null, null, null] 
            }
        };
        let currentGoalId = null;
        let editingGoalId = null;
        let currentView = 'calendar';
        let isSelectionMode = false;
        let selectedTasks = new Set();

        // ==================== å·¥å…·å‡½æ•° ====================
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) {
                r = "0x" + hex[1] + hex[1];
                g = "0x" + hex[2] + hex[2];
                b = "0x" + hex[3] + hex[3];
            } else if (hex.length == 7) {
                r = "0x" + hex[1] + hex[2];
                g = "0x" + hex[3] + hex[4];
                b = "0x" + hex[5] + hex[6];
            }
            return +r + "," + +g + "," + +b;
        }

        function parseDateStr(s) {
            if (!s) return new Date();
            const p = s.split('-');
            return new Date(p[0], p[1] - 1, p[2]);
        }

        function getTodayStr() {
            const n = new Date();
            return `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, '0')}-${String(n.getDate()).padStart(2, '0')}`;
        }
        
        function formatDateToISO(dateObj) {
            return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const date = parseDateStr(dateStr);
            const today = parseDateStr(getTodayStr());
            const diff = Math.ceil((date - today) / 86400000);
            
            if (diff === 0) return 'ä»Šå¤©';
            if (diff === 1) return 'æ˜å¤©';
            if (diff === -1) return 'æ˜¨å¤©';
            if (diff > 0 && diff <= 7) return `${diff}å¤©å`;
            if (diff < 0) return `${Math.abs(diff)}å¤©å‰`;
            return dateStr;
        }

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            loadData();
            if (!data.settings.taskPresets || data.settings.taskPresets.length === 0 || data.settings.taskPresets[0] === "#81ad62") {
                data.settings.taskPresets = ["#D3E5EF", "#E8DEEE", "#FDECC8", "#F4E0E9", "#DBEDDB"];
            }
            if (!data.settings.bgColor) data.settings.bgColor = '#F9F7F3';
            if (!data.settings.theme) data.settings.theme = '#8D7B68';
            
            if (!data.settings.customSchemes) data.settings.customSchemes = [null, null, null];
            
            if (data.settings.appTitle) {
                document.getElementById('appTitle').innerText = data.settings.appTitle;
            }

            updateHeaderDate();
            applyStyles();
            renderAll();
            setupEventListeners();
            setInterval(updateHeaderDate, 60000);
        }

        function loadData() {
            const saved = localStorage.getItem('dailyPlannerPro_v16');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    data = { ...data, ...parsed, settings: { ...data.settings, ...parsed.settings } };
                } catch (e) { console.error(e); }
            }
        }

        function setupEventListeners() {
            document.getElementById('quickIndependentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addIndependentTask();
            });
            document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addSubtaskFromInput();
            });
            document.getElementById('localBgInput').addEventListener('change', handleImageUpload);
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function handleKeyboardShortcuts(e) {
            const taskModal = document.getElementById('taskModal');
            if (!taskModal.classList.contains('hidden')) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTaskFromModal();
                    return;
                }
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                openAddGoalModal();
            }
            if (e.key === 'Escape') closeAllModals();
        }

        function closeAllModals() {
            ['goalModal', 'detailModal', 'statsModal', 'settingsModal', 'taskModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal && !modal.classList.contains('hidden')) closeModal(id);
            });
        }

        function switchView(viewName) {
            currentView = viewName;
            document.getElementById('btn-calendar').classList.remove('active');
            document.getElementById('btn-dashboard').classList.remove('active');
            document.getElementById(`btn-${viewName}`).classList.add('active');
            document.getElementById('calendarView').classList.remove('active');
            document.getElementById('dashboardView').classList.remove('active');
            document.getElementById(`${viewName}View`).classList.add('active');
        }

        function refreshViews() {
            saveData();
            renderAll(); 
            const detailModal = document.getElementById('detailModal');
            if (!detailModal.classList.contains('hidden') && currentGoalId) {
                renderDetailTaskList();
                renderDetailCalendar();
            }
        }

        function renderAll() {
            renderGoals();
            renderDailySteps();
            renderCompleted();
            renderMiniCalendar();
            updateTaskGoalSelect();
            updateTodayProgress(); // æ–°å¢ï¼šæ›´æ–°è¿›åº¦æ¡
        }
        
        // æ–°å¢åŠŸèƒ½ï¼šä»Šæ—¥ä»»åŠ¡è¿›åº¦æ¡
        function updateTodayProgress() {
            const todayStr = getTodayStr();
            const tasks = data.subtasks.filter(t => t.date === todayStr);
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const el = document.getElementById('todayProgress');
            
            if (total === 0) {
                // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œå¯ä»¥éšè—æˆ–è€…æ˜¾ç¤º0%
                document.getElementById('progressText').innerText = "ä»Šæ—¥: 0%";
                document.getElementById('progressBar').style.width = "0%";
                el.classList.remove('opacity-0');
                document.getElementById('celebration').classList.add('hidden');
                return;
            }
            
            el.classList.remove('opacity-0');
            const percent = Math.round((completed / total) * 100);
            document.getElementById('progressText').innerText = `ä»Šæ—¥: ${percent}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
            
            if (percent === 100) {
                document.getElementById('celebration').classList.remove('hidden');
            } else {
                document.getElementById('celebration').classList.add('hidden');
            }
        }
        
        function updateTaskGoalSelect() {
            const activeGoals = data.goals.filter(g => !g.completed);
            const optionsHtml = '<option value="">æ— ç›®æ ‡ (ç‹¬ç«‹ä»»åŠ¡)</option>' + 
                activeGoals.map(g => `<option value="${g.id}">${g.title}</option>`).join('');
            const modalSelect = document.getElementById('taskGoalSelectModal');
            if (modalSelect) modalSelect.innerHTML = optionsHtml;
        }

        function renderMiniCalendar() {
            const container = document.getElementById('miniCalendar');
            container.innerHTML = '';
            
            const select = document.getElementById('ddlFilterSelect');
            const currentFilter = select.value;
            const optionsHtml = '<option value="all">å…¨éƒ¨ç›®æ ‡</option>' + 
                                '<option value="all_tasks">å…¨éƒ¨ä»»åŠ¡</option>' + 
                data.goals.filter(g => !g.completed)
                    .map(g => `<option value="${g.id}">${g.title}</option>`)
                    .join('');
            if (select.innerHTML !== optionsHtml) {
                select.innerHTML = optionsHtml;
                if(currentFilter && (currentFilter === 'all' || currentFilter === 'all_tasks' || data.goals.some(g => g.id === currentFilter))) {
                    select.value = currentFilter;
                } else {
                    select.value = 'all';
                }
            }
            const activeFilter = select.value;
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            
            let titleSuffix = "";
            if(activeFilter === "all_tasks") titleSuffix = "";
            
            document.getElementById('miniCalTitle').innerText = `${now.getFullYear()}å¹´ ${now.getMonth() + 1}æœˆ${titleSuffix}`;
            
            ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(w => {
                container.innerHTML += `<div class="text-center text-xs text-gray-400 py-2 font-semibold uppercase tracking-wider">${w}</div>`;
            });
            let loop = new Date(startOfWeek);
            let daysToShow = 35; 
            
            if (activeFilter !== 'all' && activeFilter !== 'all_tasks') {
                const goal = data.goals.find(g => g.id === activeFilter);
                if (goal) {
                    const ddlDate = parseDateStr(goal.ddl);
                    const ddlWeekEnd = new Date(ddlDate);
                    ddlWeekEnd.setDate(ddlDate.getDate() + (6 - ddlDate.getDay()));
                    const daysToDeadline = Math.ceil((ddlWeekEnd - startOfWeek) / 86400000);
                    const weeksToDeadline = Math.ceil(daysToDeadline / 7);
                    if (weeksToDeadline <= 5) daysToShow = 35; else daysToShow = daysToDeadline;
                }
            }
            
            for (let i = 0; i < daysToShow; i++) {
                const dateStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isToday = dateStr === getTodayStr();
                
                if (activeFilter === 'all') {
                    const goalsToday = data.goals.filter(g => g.ddl === dateStr && !g.completed);
                    let content = `<span class="relative z-10 ${goalsToday.length > 0 ? 'date-highlight-theme' : ''}">${loop.getDate()}</span>`;
                    if (goalsToday.length > 0) {
                        content += `<div class="flex flex-col gap-1 mt-1 w-full">`;
                        goalsToday.forEach(g => {
                            content += `<div class="cal-goal-tag truncate" title="${g.title}">${g.title}</div>`;
                        });
                        content += `</div>`;
                    }
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''}" onclick="showDayDetail('${dateStr}')">${content}</div>`;
                } else if (activeFilter === 'all_tasks') {
                    const tasks = data.subtasks.filter(s => s.date === dateStr);
                    tasks.sort((a, b) => a.completed - b.completed);

                    let taskHtml = '';
                    tasks.forEach(t => {
                        let bg = t.color || 'rgba(0,0,0,0.04)'; 
                        
                        taskHtml += `
                            <div class="cal-task-item ${t.completed ? 'done' : ''}" 
                                 style="background-color: ${bg}; cursor: pointer;" 
                                 onclick="event.stopPropagation(); editTask('${t.id}');"
                                 title="${t.title}">
                                 ${t.completed ? '<i class="fa-solid fa-check mr-1 text-[9px]"></i>' : ''}${t.title}
                            </div>`;
                    });
                    container.innerHTML += `
                        <div class="calendar-day ${isToday ? 'cal-today' : ''}" onclick="selectDateForTask('${dateStr}', '')">
                            <span class="font-bold text-gray-500 z-10 block mb-1 text-xs">${loop.getDate()}</span>
                            <div class="w-full flex flex-col overflow-hidden">
                                ${taskHtml}
                            </div>
                        </div>`;
                } else {
                    const goal = data.goals.find(g => g.id === activeFilter);
                    if (!goal) continue;
                    
                    const isDDL = goal.ddl === dateStr;
                    const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                    let html = `<span class="font-bold text-gray-500 z-10 text-xs">${loop.getDate()}</span>`;
                    
                    if (goal && loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        if (diff <= 365) html += `<div class="countdown-badge-classic ${badgeClass}">${diff}å¤©</div>`;
                    }
                    
                    if (isDDL) {
                        html = `<span class="date-circle-red z-10">${loop.getDate()}</span>`;
                    }
                    
                    const tasks = data.subtasks.filter(s => s.goalId === activeFilter && s.date === dateStr);
                    const taskHtml = tasks.map(t => {
                        // ä¿®æ”¹ï¼šåœ¨ç‰¹å®šç›®æ ‡è§†å›¾ä¸‹ä¹Ÿä½¿ç”¨å…¨è‰²å—èƒŒæ™¯æ ·å¼
                        let bg = t.color || 'rgba(0,0,0,0.04)';
                        return `<div class="cal-task-item ${t.completed ? 'done' : ''}" style="background-color: ${bg}; cursor: pointer;" onclick="event.stopPropagation(); editTask('${t.id}');">${t.title}</div>`;
                    }).join('');
                    container.innerHTML += `<div class="calendar-day ${isToday ? 'cal-today' : ''}" onclick="selectDateForTask('${dateStr}', '${activeFilter}')">${html}<div class="w-full flex flex-col items-center mt-1">${taskHtml}</div></div>`;
                }
                
                loop.setDate(loop.getDate() + 1);
            }
        }

        function renderDailySteps() {
            const container = document.getElementById('stepsList');
            const btn = document.getElementById('bulkSelectBtn');
            if (isSelectionMode) {
                btn.classList.add('bg-red-50', 'text-red-500');
                document.getElementById('bulkDeleteBar').classList.remove('hidden');
                document.getElementById('quickAddBar').classList.add('hidden');
            } else {
                btn.classList.remove('bg-red-50', 'text-red-500');
                document.getElementById('bulkDeleteBar').classList.add('hidden');
                document.getElementById('quickAddBar').classList.remove('hidden');
            }

            let tasks = data.subtasks.filter(s => 
                !s.completed && 
                (!s.goalId || (data.goals.find(g => g.id === s.goalId) && !data.goals.find(g => g.id === s.goalId).completed))
            );
            document.getElementById('taskCountBadge').innerText = tasks.length;
            
            const todayStr = getTodayStr();
            const todayTasks = tasks.filter(t => t.date === todayStr);
            const futureTasks = tasks.filter(t => t.date > todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            const pastTasks = tasks.filter(t => t.date < todayStr).sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));

            container.innerHTML = '';
            if (pastTasks.length) {
                container.innerHTML += pastTasks.map(t => renderTaskItem(t, 'past')).join('');
                container.innerHTML += `<div class="task-separator"><span>å·²è¿‡æœŸ</span></div>`;
            }
            
            if (todayTasks.length) {
                container.innerHTML += todayTasks.map(t => renderTaskItem(t, 'today')).join('');
            } else if (tasks.length > 0) {
                container.innerHTML += `<div class="text-center text-xs text-gray-400 py-4">
                    <p>ä»Šå¤©æš‚æ— ä»»åŠ¡</p>
                </div>`;
            } else {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-check-circle"></i><p>æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼</p>
                </div>`;
            }
            
            if (futureTasks.length) {
                container.innerHTML += `<div class="task-separator"><span>æœªæ¥è®¡åˆ’</span></div>`;
                container.innerHTML += futureTasks.map(t => renderTaskItem(t, 'future')).join('');
            }
        }

        function renderTaskItem(s, type) {
            const parent = s.goalId ? data.goals.find(g => g.id === s.goalId) : null;
            let bgClass = "task-item-card"; 
            
            let checkboxHtml;
            if (isSelectionMode) {
                const isSelected = selectedTasks.has(s.id);
                checkboxHtml = `
                <div id="bulk-check-${s.id}" class="bulk-checkbox ${isSelected ? 'selected' : ''} mr-3">
                    <i class="fa-solid fa-check"></i>
                </div>`;
            } else {
                checkboxHtml = `
                <div class="flex gap-2">
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox w-5 h-5 flex items-center justify-center transition hover:border-[var(--theme-color)]">
                        <i class="fa-solid fa-check text-xs opacity-0 group-hover:opacity-100 text-gray-400"></i>
                    </button>
                </div>`;
            }

            const clickAction = isSelectionMode ? `onclick="toggleTaskSelection('${s.id}')"` : '';
            const barColor = s.color || 'transparent';
            
            return `
            <div class="${bgClass} p-3 flex items-center justify-between group transition mb-2 fade-in-up relative overflow-hidden" ${clickAction}>
                ${isSelectionMode ? checkboxHtml : ''}
                <div class="flex-1 min-w-0 mr-3 pl-2 border-l-2" style="border-color: ${barColor}">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[#37352F] text-sm truncate cursor-text" ${!isSelectionMode ? `ondblclick="editTask('${s.id}')"` : ''} title="${s.title}">${s.title}</span>
                        ${!isSelectionMode ? `<button onclick="editTask('${s.id}')" class="opacity-0 group-hover:opacity-100 text-xs text-gray-300 edit-btn-theme transition"><i class="fa-solid fa-pencil"></i></button>` : ''}
                         <button onclick="deleteTask('${s.id}')" class="opacity-0 group-hover:opacity-100 text-xs text-gray-300 hover:text-red-500 transition ml-auto"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="text-[10px] text-gray-400 flex gap-3 items-center font-medium">
                        <span class="${type === 'past' ? 'text-red-500' : ''}">
                            <i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}
                        </span>
                        ${parent ? `<span class="theme-tag truncate max-w-[80px]" title="${parent.title}">${parent.title}</span>` : ''}
                    </div>
                </div>
                ${!isSelectionMode ? checkboxHtml : ''}
            </div>`;
        }

        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            selectedTasks.clear();
            renderDailySteps();
        }

        function toggleTaskSelection(id) {
            if (selectedTasks.has(id)) {
                selectedTasks.delete(id);
            } else {
                selectedTasks.add(id);
            }

            const checkboxEl = document.getElementById(`bulk-check-${id}`);
            if (checkboxEl) {
                if (selectedTasks.has(id)) {
                    checkboxEl.classList.add('selected');
                } else {
                    checkboxEl.classList.remove('selected');
                }
            }
        }

        function deleteSelectedTasks() {
            if (selectedTasks.size === 0) return alert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡');
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedTasks.size} ä¸ªä»»åŠ¡å—ï¼Ÿ`)) return;
            
            data.subtasks = data.subtasks.filter(s => !selectedTasks.has(s.id));
            toggleSelectionMode(); 
            refreshViews();
        }

        function renderGoals() {
            const container = document.getElementById('goalsContent');
            const list = data.goals.filter(g => !g.completed);
            list.sort((a, b) => parseDateStr(a.ddl) - parseDateStr(b.ddl));
            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-bullseye"></i><p>æš‚æ— è¿›è¡Œä¸­ç›®æ ‡</p></div>`;
                return;
            }
            
            container.innerHTML = list.map(g => {
                const today = parseDateStr(getTodayStr());
                const diff = Math.ceil((parseDateStr(g.ddl) - today) / 86400000);
                
                let badgeClass = 'badge-normal';
                if (diff < 0) badgeClass = 'badge-urgent';
                else if (diff <= 3) badgeClass = 'badge-urgent';
                else if (diff <= 7) badgeClass = 'badge-warning';
                
                let badgeText = diff < 0 ? `é€¾æœŸ ${Math.abs(diff)}å¤©` : `å‰© ${diff} å¤©`;
                const relTasks = data.subtasks.filter(s => s.goalId === g.id);
                const progress = relTasks.length ? Math.round((relTasks.filter(s => s.completed).length / relTasks.length) * 100) : 0;
                
                return `
                <div class="bg-white p-3 rounded border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer group relative overflow-hidden fade-in-up" onclick="openDetail('${g.id}')">
                    <div class="flex justify-between items-start mb-1 pl-1">
                        <div class="font-bold text-[#37352F] text-sm truncate pr-2 serif-font" title="${g.title}">${g.title}</div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); openEditGoalModal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-gray-100 text-gray-400 edit-btn-theme"><i class="fa-solid fa-pencil text-xs"></i></button>
                            <button onclick="event.stopPropagation(); deleteGoal('${g.id}')" class="w-5 h-5 flex items-center justify-center rounded hover:bg-red-50 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xs pl-1 mb-2">
                        <div>
                            <span class="countdown-badge-classic ${badgeClass} relative top-0 right-0">${badgeText}</span>
                            <span class="theme-tag ml-2">${g.category}</span>
                        </div>
                        <div class="text-gray-400 font-bold">${progress}%</div>
                    </div>
                    <div class="bg-[#F0EEEB] h-1 rounded-full ml-1 overflow-hidden w-[calc(100%-4px)]">
                        <div class="theme-bg h-full transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCompleted() {
            const container = document.getElementById('completedList');
            container.innerHTML = '';
            
            const cGoals = data.goals.filter(g => g.completed);
            if (cGoals.length) {
                container.innerHTML += `<div class="text-xs text-gray-400 font-bold mb-2 uppercase tracking-wider">å·²å®Œæˆç›®æ ‡</div>`;
                cGoals.forEach(g => {
                    container.innerHTML += `
                    <div class="bg-[#F7F6F3] p-2 rounded border border-gray-200 flex justify-between items-center mb-2 group hover:bg-[#F0EEEB] transition">
                        <span class="font-bold text-gray-500 line-through text-xs truncate flex-1 serif-font" title="${g.title}">${g.title}</span>
                        <div class="flex gap-2">
                            <button onclick="deleteGoal('${g.id}')" class="text-xs text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="restoreGoal('${g.id}')" class="theme-tag restore-btn-theme"><i class="fa-solid fa-rotate-left mr-1"></i>æ¢å¤</button>
                        </div>
                    </div>`;
                });
            }
            
            const cTasks = data.subtasks.filter(s => s.completed).sort((a, b) => b.id - a.id).slice(0, 10);
            if (cTasks.length) {
                container.innerHTML += `<div class="text-xs text-gray-400 font-bold mb-2 mt-3 uppercase tracking-wider">è¿‘æœŸå®Œæˆä»»åŠ¡</div>`;
                cTasks.forEach(s => {
                    container.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-white rounded border border-gray-100 mb-1 text-xs group hover:bg-[#F7F6F3] transition">
                        <span class="text-gray-400 line-through truncate flex-1 mr-2" title="${s.title}">${s.title}</span>
                        <div class="flex gap-2">
                            <button onclick="deleteTask('${s.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="toggleTaskStatus('${s.id}')" class="text-gray-400 restore-btn-theme border border-gray-200 rounded px-1"><i class="fa-solid fa-rotate-left"></i></button>
                        </div>
                    </div>`;
                });
            }
            
            if (!cGoals.length && !cTasks.length) {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-inbox"></i><p>æš‚æ— è®°å½•</p></div>`;
            }
        }

        function openDetail(id) {
            currentGoalId = id;
            const g = data.goals.find(x => x.id === id);
            document.getElementById('detailTitle').innerHTML = `${g.title}`;
            document.getElementById('detailModal').classList.remove('hidden');
            renderDetailCalendar();
            renderDetailTaskList();
        }

        function renderDetailCalendar() {
            const container = document.getElementById('detailCalendarView');
            container.innerHTML = '';
            const goal = data.goals.find(g => g.id === currentGoalId);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); 
            
            const ddlDate = parseDateStr(goal.ddl);
            const ddlWeekEnd = new Date(ddlDate);
            ddlWeekEnd.setDate(ddlDate.getDate() + (6 - ddlDate.getDay())); 
            
            const daysToDeadline = Math.ceil((ddlWeekEnd - startOfWeek) / 86400000);
            const weeksToDeadline = Math.ceil(daysToDeadline / 7);
            
            let end;
            if (weeksToDeadline <= 5) {
                end = new Date(startOfWeek);
                end.setDate(startOfWeek.getDate() + 34); 
            } else {
                end = ddlWeekEnd;
            }
            
            ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(w => container.innerHTML += `<div class="text-center text-xs font-bold text-gray-400 py-1 uppercase tracking-wider">${w}</div>`);
            let loop = new Date(startOfWeek);
            while (loop <= end) {
                const dStr = `${loop.getFullYear()}-${String(loop.getMonth() + 1).padStart(2, '0')}-${String(loop.getDate()).padStart(2, '0')}`;
                const isDDL = dStr === goal.ddl;
                const isToday = dStr === getTodayStr();
                const diff = Math.ceil((parseDateStr(goal.ddl) - loop) / 86400000);
                let html = '';
                let dateHtml = `<span class="font-bold text-gray-500 text-xs">${loop.getDate()}</span>`;
                if (loop <= parseDateStr(goal.ddl) && loop >= parseDateStr(getTodayStr()) && !isDDL) {
                    if (diff <= 365) {
                        let badgeClass = 'badge-normal';
                        if (diff <= 3) badgeClass = 'badge-urgent';
                        else if (diff <= 7) badgeClass = 'badge-warning';
                        html = `<div class="countdown-badge-classic ${badgeClass}">${diff}å¤©</div>`;
                    }
                }
                
                if (isDDL) {
                    dateHtml = `<span class="date-circle-red">${loop.getDate()}</span>`;
                }
                
                const tasks = data.subtasks.filter(s => s.goalId === currentGoalId && s.date === dStr);
                const taskHtml = tasks.map(t => {
                    return `<div class="text-[#37352F] text-[10px] px-1 rounded truncate mt-0.5 hover:opacity-100 transition w-full max-w-full ${t.completed ? 'line-through opacity-50' : ''}" style="border-left: 3px solid ${t.color || 'var(--theme-color)'}; background: #FAFAFA; cursor: pointer;" onclick="event.stopPropagation(); editTask('${t.id}');">${t.title}</div>`;
                }).join('');
                container.innerHTML += `
                <div class="min-h-[80px] border border-gray-100 p-1 relative hover:shadow-md transition bg-white overflow-hidden ${isToday ? 'bg-[#F7F6F3]' : ''}" onclick="selectDateForTask('${dStr}', '${currentGoalId}')">
                    ${dateHtml}<div class="flex flex-col w-full overflow-hidden">${taskHtml}</div>${html}
                </div>`;
                loop.setDate(loop.getDate() + 1);
            }
        }

        function renderDetailTaskList() {
            const listContainer = document.getElementById('detailTaskList');
            const tasks = data.subtasks.filter(s => s.goalId === currentGoalId);
            tasks.sort((a, b) => parseDateStr(a.date) - parseDateStr(b.date));
            if (tasks.length === 0) {
                listContainer.innerHTML = `<div class="empty-state"><i class="fa-solid fa-tasks"></i><p>æš‚æ— ä»»åŠ¡</p></div>`;
                return;
            }
            
            listContainer.innerHTML = tasks.map(s => `
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded hover:shadow-sm transition group fade-in-up">
                    <button onclick="toggleTaskStatus('${s.id}')" class="task-checkbox ${s.completed ? 'checked' : ''} w-5 h-5 flex items-center justify-center transition hover:border-[var(--theme-color)]">
                        <i class="fa-solid fa-check text-xs ${s.completed ? 'text-white' : 'text-transparent'}"></i>
                    </button>
                    <div class="flex-1 ${s.completed ? 'line-through text-gray-400' : 'text-gray-700'}">
                        <div class="text-sm font-medium cursor-text" ondblclick="editTask('${s.id}')" title="${s.title}">${s.title}</div>
                        <div class="text-[10px] text-gray-400"><i class="fa-regular fa-calendar mr-1"></i>${formatDate(s.date)}</div>
                    </div>
                    <button onclick="editTask('${s.id}')" class="text-gray-300 edit-btn-theme opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-pencil"></i></button>
                    <button onclick="deleteTask('${s.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
            const goal = data.goals.find(g => g.id === currentGoalId);
            if (tasks.length > 0 && tasks.every(t => t.completed) && !goal.completed) {
                listContainer.innerHTML += `<button onclick="completeGoal('${currentGoalId}')" class="w-full mt-4 py-2 bg-[#E7F3F0] text-[#448361] rounded transition font-bold shadow-sm text-sm">ğŸ‰ ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œå½’æ¡£è¯¥ç›®æ ‡ï¼</button>`;
            }
        }

        function openAddGoalModal() {
            editingGoalId = null;
            document.getElementById('goalModalTitle').innerHTML = 'æ–°å»ºç›®æ ‡';
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDDL').value = getTodayStr();
            document.getElementById('goalModal').classList.remove('hidden');
            fillCategories();
            setTimeout(() => document.getElementById('goalTitle').focus(), 100);
        }
        
        function openEditGoalModal(id) {
            editingGoalId = id;
            const g = data.goals.find(x => x.id === id);
            document.getElementById('goalModalTitle').innerHTML = 'ç¼–è¾‘ç›®æ ‡';
            document.getElementById('goalTitle').value = g.title;
            document.getElementById('goalDDL').value = g.ddl;
            document.getElementById('goalModal').classList.remove('hidden');
            fillCategories();
            document.getElementById('goalCategorySelect').value = g.category;
            setTimeout(() => document.getElementById('goalTitle').focus(), 100);
        }
        
        function fillCategories() {
            document.getElementById('goalCategorySelect').innerHTML = data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        function saveGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            const ddl = document.getElementById('goalDDL').value;
            const cat = document.getElementById('goalCategorySelect').value;
            if (!title || !ddl) return alert('è¯·å®Œå–„ä¿¡æ¯');
            if (editingGoalId) {
                const g = data.goals.find(x => x.id === editingGoalId);
                g.title = title; g.ddl = ddl; g.category = cat;
            } else {
                data.goals.push({ id: Date.now().toString(), title, ddl, category: cat, completed: false });
            }
            saveData(); closeModal('goalModal'); renderAll();
        }

        function deleteGoal(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) return;
            data.goals = data.goals.filter(g => g.id !== id);
            data.subtasks = data.subtasks.filter(s => s.goalId !== id);
            saveData(); renderAll();
        }

        function completeGoal(id) {
            data.goals.find(x => x.id === id).completed = true;
            saveData(); closeModal('detailModal'); renderAll();
        }

        function restoreGoal(id) {
            data.goals.find(x => x.id === id).completed = false;
            saveData(); renderAll();
        }

        let editingTaskId = null;
        function editTask(id) {
            const task = data.subtasks.find(s => s.id === id);
            if (!task) return;
            
            editingTaskId = id;
            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModalTitle').innerHTML = 'ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDate').value = task.date;
            
            document.getElementById('btnDeleteTask').classList.remove('hidden');
            document.getElementById('taskRepeatSection').classList.add('hidden');
            
            updateTaskGoalSelect();
            document.getElementById('taskGoalSelectModal').value = task.goalId || '';
            renderTaskPresets();
            setTaskColor(task.color || '');
        }

        function addIndependentTask() {
            const input = document.getElementById('quickIndependentInput');
            const title = input.value.trim();
            if (title) {
                addTaskData(title, getTodayStr(), null);
                input.value = '';
            }
        }

        function addQuickTask() {
            const input = document.getElementById('quickIndependentInput');
            const title = input.value.trim();
            if (title) {
                addTaskData(title, getTodayStr(), null);
                input.value = '';
            }
        }

        function openAddTaskModal() {
            editingTaskId = null;
            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModalTitle').innerHTML = 'æ–°å»ºä»»åŠ¡';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDate').value = getTodayStr();
            
            document.getElementById('btnDeleteTask').classList.add('hidden');
            document.getElementById('taskRepeatSection').classList.remove('hidden');
            document.getElementById('taskRepeatToggle').checked = false;
            toggleRepeatMode();
            document.getElementById('taskEndDate').value = '';

            document.getElementById('taskGoalSelectModal').value = '';
            renderTaskPresets();
            setTaskColor('');
            updateTaskGoalSelect();
            setTimeout(() => document.getElementById('taskTitle').focus(), 100);
        }

        function toggleRepeatMode() {
            const isRepeat = document.getElementById('taskRepeatToggle').checked;
            const endContainer = document.getElementById('repeatEndDateContainer');
            if (isRepeat) {
                endContainer.classList.remove('hidden');
            } else {
                endContainer.classList.add('hidden');
            }
        }

        function renderTaskPresets() {
            const container = document.getElementById('taskPresetsList');
            container.innerHTML = '';

            const defaultBtn = document.createElement('button');
            defaultBtn.type = 'button';
            defaultBtn.className = 'w-6 h-6 rounded-full border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition';
            defaultBtn.title = 'é»˜è®¤';
            defaultBtn.onclick = () => setTaskColor('');
            defaultBtn.innerHTML = '<i class="fa-solid fa-ban text-gray-400 text-[10px]"></i>';
            container.appendChild(defaultBtn);
            
            data.settings.taskPresets.forEach((color, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative w-6 h-6';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-6 h-6 rounded-full transform hover:scale-110 transition border border-gray-200';
                btn.style.backgroundColor = color;
                btn.onclick = () => setTaskColor(color);
                wrapper.appendChild(btn);
                container.appendChild(wrapper);
            });
            const customWrapper = document.createElement('div');
            customWrapper.className = 'relative w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition border border-gray-300';
            customWrapper.innerHTML = `
                <i class="fa-solid fa-eye-dropper text-gray-500 text-[10px] pointer-events-none"></i>
                <input type="color" id="taskColorPicker" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" onchange="setTaskColor(this.value)" title="è‡ªå®šä¹‰é¢œè‰²">
            `;
            container.appendChild(customWrapper);
        }
        
        function renderSettingsPresets() {
            const container = document.getElementById('settingsPresetContainer');
            container.innerHTML = '';
             data.settings.taskPresets.forEach((color, index) => {
                 const wrapper = document.createElement('div');
                 wrapper.className = 'flex flex-col items-center';
                 wrapper.innerHTML = `
                    <div class="rounded-full overflow-hidden w-8 h-8 border border-gray-200 relative shadow-sm hover:scale-110 transition">
                         <input type="color" value="${color}" class="absolute -top-2 -left-2 w-12 h-12 cursor-pointer p-0 border-0" id="settingPreset${index}">
                    </div>
                 `;
                 container.appendChild(wrapper);
             });
        }

        function renderCustomSchemes() {
            const container = document.getElementById('customSchemesContainer');
            container.innerHTML = '';
            
            data.settings.customSchemes.forEach((scheme, index) => {
                const slot = document.createElement('div');
                slot.className = `scheme-slot ${scheme ? 'filled' : ''}`;
                
                if (scheme) {
                    slot.style.backgroundColor = scheme.bg;
                    slot.style.borderColor = scheme.theme;
                    slot.title = "åº”ç”¨æ­¤æ–¹æ¡ˆ";
                    slot.onclick = () => loadCustomScheme(index);
                    
                    const clearBtn = document.createElement('div');
                    clearBtn.className = 'absolute -top-1 -right-1 bg-white border rounded-full w-4 h-4 flex items-center justify-center shadow text-red-500 text-[8px]';
                    clearBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
                    clearBtn.onclick = (e) => {
                        e.stopPropagation();
                        clearCustomScheme(index);
                    };
                    slot.appendChild(clearBtn);
                } else {
                    slot.title = "ä¿å­˜å½“å‰æ–¹æ¡ˆ";
                    slot.onclick = () => saveCustomScheme(index);
                    slot.innerHTML = '<i class="fa-solid fa-plus text-gray-300 text-xs"></i>';
                }
                container.appendChild(slot);
            });
        }

        function saveCustomScheme(index) {
            const currentTheme = document.getElementById('themeColorPicker').value;
            const currentBg = document.getElementById('bgColorPicker').value;
            data.settings.customSchemes[index] = { theme: currentTheme, bg: currentBg };
            renderCustomSchemes();
        }

        function loadCustomScheme(index) {
            const scheme = data.settings.customSchemes[index];
            if (scheme) {
                document.getElementById('themeColorPicker').value = scheme.theme;
                document.getElementById('bgColorPicker').value = scheme.bg;
                updateStyleRealtime(); 
            }
        }
        
        function clearCustomScheme(index) {
            data.settings.customSchemes[index] = null;
            renderCustomSchemes();
        }

        function setTaskColor(color) {
            document.getElementById('taskColor').value = color;
            const picker = document.getElementById('taskColorPicker');
            if (picker && color) picker.value = color;
        }

        function saveTaskFromModal() {
            const title = document.getElementById('taskTitle').value.trim();
            const date = document.getElementById('taskDate').value;
            const goalId = document.getElementById('taskGoalSelectModal').value || null;
            const color = document.getElementById('taskColor').value || '';
            const isRepeat = document.getElementById('taskRepeatToggle').checked;
            const endDateStr = document.getElementById('taskEndDate').value;
            
            if (!title) { alert('è¯·è¾“å…¥ä»»åŠ¡åç§°'); return; }
            if (!date) { alert('è¯·é€‰æ‹©æ—¥æœŸ'); return; }
            
            closeModal('taskModal');
            setTimeout(() => {
                if (editingTaskId) {
                    const task = data.subtasks.find(s => s.id === editingTaskId);
                    if (task) {
                        task.title = title;
                        task.date = date;
                        task.goalId = goalId;
                        task.color = color;
                        refreshViews(); 
                    }
                    editingTaskId = null;
                } else {
                    if (isRepeat && endDateStr) {
                        const start = parseDateStr(date);
                        const end = parseDateStr(endDateStr);
                        if (end < start) { alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ'); return; }
                        let loopDate = new Date(start);
                        while (loopDate <= end) {
                            const dStr = formatDateToISO(loopDate);
                            data.subtasks.push({
                                id: Date.now() + Math.random().toString(), 
                                title: title,
                                date: dStr,
                                goalId: goalId,
                                completed: false,
                                color: color || ''
                            });
                            loopDate.setDate(loopDate.getDate() + 1);
                        }
                        refreshViews();
                    } else {
                        addTaskData(title, date, goalId, color);
                    }
                }
            }, 10);
        }
        
        function deleteTaskFromModal() {
            if (editingTaskId) {
                deleteTask(editingTaskId);
                closeModal('taskModal');
            }
        }

        function addSubtaskFromInput() {
            const input = document.getElementById('quickTaskInput');
            const title = input.value.trim();
            if (title) {
                addTaskData(title, getTodayStr(), currentGoalId);
                input.value = '';
            }
        }

        function selectDateForTask(dateStr, goalId) {
            const targetGoalId = goalId || currentGoalId || '';
            editingTaskId = null;
            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModalTitle').innerHTML = 'æ–°å»ºä»»åŠ¡';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDate').value = dateStr;
            document.getElementById('btnDeleteTask').classList.add('hidden');
            document.getElementById('taskRepeatSection').classList.remove('hidden');
            document.getElementById('taskRepeatToggle').checked = false;
            toggleRepeatMode();
            document.getElementById('taskEndDate').value = '';
            updateTaskGoalSelect();
            renderTaskPresets();
            document.getElementById('taskGoalSelectModal').value = targetGoalId;
            setTaskColor('');
            setTimeout(() => document.getElementById('taskTitle').focus(), 100);
        }

        function addTaskData(title, dateStr, goalId, color) {
            data.subtasks.push({ id: Date.now() + '', title, date: dateStr, goalId: goalId, completed: false, color: color || '' });
            refreshViews();
        }

        function toggleTaskStatus(id) {
            const task = data.subtasks.find(s => s.id === id);
            task.completed = !task.completed;
            refreshViews();
        }

        function deleteTask(id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            data.subtasks = data.subtasks.filter(s => s.id !== id);
            refreshViews();
        }

        function openStats() {
            document.getElementById('statsModal').classList.remove('hidden');
            const totalGoals = data.goals.length;
            const activeGoals = data.goals.filter(g => !g.completed).length;
            const totalTasks = data.subtasks.length;
            const completedTasks = data.subtasks.filter(t => t.completed).length;
            document.getElementById('statTotalGoals').innerText = totalGoals;
            document.getElementById('statActiveGoals').innerText = activeGoals;
            document.getElementById('statTotalTasks').innerText = totalTasks;
            document.getElementById('statCompletionRate').innerText = (totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0) + '%';
            const categoryCounts = {};
            data.goals.filter(g => !g.completed).forEach(g => categoryCounts[g.category] = (categoryCounts[g.category] || 0) + 1);
            document.getElementById('categoryStats').innerHTML = Object.entries(categoryCounts).length ?
                Object.entries(categoryCounts).map(([cat, count]) => `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="theme-tag">${cat}</span><span class="font-bold text-gray-700">${count}</span>
                </div>`).join('') : '<div class="text-center text-gray-400 py-2">æš‚æ— æ•°æ®</div>';
            const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recent = data.subtasks.filter(t => t.completed && parseInt(t.id) > sevenDaysAgo.getTime()).length;
            document.getElementById('recentCompletions').innerHTML = recent > 0 ? 
                `<div class="text-4xl font-bold theme-text">${recent}</div><div class="text-xs text-gray-500 mt-2">æœ¬å‘¨å®Œæˆ</div>` : 
                '<div class="text-gray-400">æœ¬å‘¨æš‚æ— å®Œæˆä»»åŠ¡</div>';
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('themeColorPicker').value = data.settings.theme;
            document.getElementById('bgColorPicker').value = data.settings.bgColor || '#F9F7F3';
            // å…¼å®¹æ€§ä¿ç•™
            document.getElementById('glassOpacityPicker').value = 1;
            document.getElementById('imgOpacityPicker').value = 1;
            document.getElementById('categoriesInput').value = data.categories.join(', ');
            renderSettingsPresets();
            renderCustomSchemes();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                data.settings.bg = ev.target.result;
                updateStyleRealtime();
            };
            reader.readAsDataURL(file);
        }

        function clearBackground() {
            data.settings.bg = '';
            document.getElementById('localBgInput').value = '';
            updateStyleRealtime();
        }

        function saveSettings() {
            data.settings.theme = document.getElementById('themeColorPicker').value;
            data.settings.bgColor = document.getElementById('bgColorPicker').value;
            // å›ºå®šä¸ºä¸é€æ˜
            data.settings.glassOpacity = 1;
            data.settings.imgOpacity = 1;
            data.categories = document.getElementById('categoriesInput').value.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            if (data.categories.length === 0) data.categories = ['å·¥ä½œ', 'ç”Ÿæ´»', 'å­¦ä¹ ', 'å¥åº·'];
            
            const newPresets = [];
            for(let i=0; i<5; i++) {
                const val = document.getElementById(`settingPreset${i}`).value;
                newPresets.push(val);
            }
            data.settings.taskPresets = newPresets;
            
            saveData(); closeModal('settingsModal'); renderAll(); applyStyles();
        }

        function updateStyleRealtime() {
            const color = document.getElementById('themeColorPicker').value;
            const bgColor = document.getElementById('bgColorPicker').value; 
            
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-light', `rgba(${hexToRgb(color)}, 0.15)`); // ç¨å¾®å¢åŠ ä¸é€æ˜åº¦
            document.documentElement.style.setProperty('--theme-hover', `rgba(${hexToRgb(color)}, 0.05)`);
            document.documentElement.style.setProperty('--bg-color', bgColor);
            
            // å¼ºåˆ¶è¦†ç›–ï¼Œä¸ä½¿ç”¨é€æ˜åº¦
            document.documentElement.style.setProperty('--glass-opacity', 1);
            document.documentElement.style.setProperty('--img-opacity', 1);
            if (data.settings.bg) {
                 document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
                 document.getElementById('bg-layer').style.display = 'block';
            } else {
                 document.documentElement.style.setProperty('--bg-image', 'none');
                 document.getElementById('bg-layer').style.display = 'none';
            }
        }

        function applyStyles() {
            document.documentElement.style.setProperty('--theme-color', data.settings.theme);
            document.documentElement.style.setProperty('--theme-light', `rgba(${hexToRgb(data.settings.theme)}, 0.15)`);
            document.documentElement.style.setProperty('--theme-hover', `rgba(${hexToRgb(data.settings.theme)}, 0.05)`);
            document.documentElement.style.setProperty('--bg-color', data.settings.bgColor || '#F9F7F3');
            
            document.documentElement.style.setProperty('--glass-opacity', 1);
            document.documentElement.style.setProperty('--img-opacity', 1);
            if (data.settings.bg) {
                document.documentElement.style.setProperty('--bg-image', `url('${data.settings.bg}')`);
                document.getElementById('bg-layer').style.display = 'block';
            } else {
                document.getElementById('bg-layer').style.display = 'none';
            }
        }

        function toggleSection(wrapperId, iconId, btnId) {
            const wrapper = document.getElementById(wrapperId);
            const icon = document.getElementById(iconId);
            const btn = btnId ? document.getElementById(btnId) : null;
            const parentPanel = wrapper.closest('.glass-panel');
            if (wrapper.classList.contains('collapsed')) {
                wrapper.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
                if (btn) btn.style.display = 'flex';
            } else {
                wrapper.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                if (btn) btn.style.display = 'none';
            }
        }

        function updateHeaderDate() {
            const now = new Date();
            // ä¸­æ–‡æ—¥æœŸæ ¼å¼
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('headerDate').innerText = now.toLocaleDateString('zh-CN', options);
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function saveData() { localStorage.setItem('dailyPlannerPro_v16', JSON.stringify(data)); }
        
        function showDayDetail(dateStr) { }
        
        function saveAppTitle() {
            const titleEl = document.getElementById('appTitle');
            const newTitle = titleEl.innerText.trim();
            if (!newTitle) {
                titleEl.innerText = 'My Planner';
                data.settings.appTitle = 'My Planner';
            } else {
                data.settings.appTitle = newTitle;
            }
            saveData();
        }

        function handleTitleKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('appTitle').blur(); 
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `MyPlanner_Backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerImport() { document.getElementById('importFileInput').click(); }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.goals || !importedData.subtasks) {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šè¿™ä¸æ˜¯ My Planner çš„å¤‡ä»½æ–‡ä»¶ã€‚');
                        return;
                    }
                    if (confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰çš„å…¨éƒ¨æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        data = importedData;
                        if (!data.settings) data.settings = {};
                        if (!data.settings.taskPresets) data.settings.taskPresets = ["#D3E5EF", "#E8DEEE", "#FDECC8", "#F4E0E9", "#DBEDDB"];
                        if (!data.settings.customSchemes) data.settings.customSchemes = [null, null, null];
                        
                        saveData();
                        init(); 
                        alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
                        closeModal('settingsModal');
                    }
                } catch (err) {
                    alert('æ–‡ä»¶æ— æ³•è¯»å–ï¼Œå¯èƒ½å·²æŸåã€‚');
                    console.error(err);
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
